
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="../../../images/favicon.ico">
      <meta name="generator" content="mkdocs-1.2.3, mkdocs-material-8.1.3">
    
    
      
        <title>Evaluation - Ray</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.edf004c2.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.e6a45f82.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../../../css/termynal.css">
    
      <link rel="stylesheet" href="../../../css/extra.css">
    
    <script>__md_scope=new URL("../../..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="blue">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#evaluation-package" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <div data-md-component="outdated" hidden>
        <aside class="md-banner md-banner--warning">
          
        </aside>
      </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="https://ray.io" title="Ray" class="md-header__button md-logo" aria-label="Ray" data-md-component="logo">
      
  <img src="../../../images/ray-logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Ray
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Evaluation
            
          </span>
        </div>
      </div>
    </div>
    
      <form class="md-header__option" data-md-component="palette">
        
          
          
          <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="blue"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
          
            <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3 3.19.09m3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95 2.06.05m-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31z"/></svg>
            </label>
          
        
          
          
          <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="red"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
          
            <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5c-.84 0-1.65.15-2.39.42L12 2M3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29L3.34 7m.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14L3.36 17M20.65 7l-1.77 3.79a7.023 7.023 0 0 0-2.38-4.15l4.15.36m-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29L20.64 17M12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44L12 22z"/></svg>
            </label>
          
        
      </form>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/ray-project/ray" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    ray-project/ray
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../.." class="md-tabs__link">
        Getting Started
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../../ray-deployment/" class="md-tabs__link">
        Deploying Ray
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../../ray-ecosystem/" class="md-tabs__link">
        Ecosystem
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../../ray-examples/" class="md-tabs__link">
        Examples
      </a>
    </li>
  

      
        
  
  
    
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../" class="md-tabs__link md-tabs__link--active">
        API
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../../ray-contributor-guide/" class="md-tabs__link">
        Contribute
      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="https://ray.io" title="Ray" class="md-nav__button md-logo" aria-label="Ray" data-md-component="logo">
      
  <img src="../../../images/ray-logo.png" alt="logo">

    </a>
    Ray
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/ray-project/ray" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    ray-project/ray
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_1" type="checkbox" id="__nav_1" >
      
      
      
        
          
            
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../..">Getting Started</a>
          
            <label for="__nav_1">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="Getting Started" data-md-level="1">
        <label class="md-nav__title" for="__nav_1">
          <span class="md-nav__icon md-icon"></span>
          Getting Started
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../ray-overview/what-and-why-ray/" class="md-nav__link">
        Why Ray?
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../ray-overview/more-information/" class="md-nav__link">
        Learn more
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_1_4" type="checkbox" id="__nav_1_4" >
      
      
      
        
          
            
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../../ray-core/">Ray Core</a>
          
            <label for="__nav_1_4">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="Ray Core" data-md-level="2">
        <label class="md-nav__title" for="__nav_1_4">
          <span class="md-nav__icon md-icon"></span>
          Ray Core
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../ray-core/key-concepts/" class="md-nav__link">
        Key concepts
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../ray-core/tutorials/" class="md-nav__link">
        Tutorials
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_1_5" type="checkbox" id="__nav_1_5" >
      
      
      
        
          
            
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../../ray-ml/ray-data/">Ray Data</a>
          
            <label for="__nav_1_5">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="Ray Data" data-md-level="2">
        <label class="md-nav__title" for="__nav_1_5">
          <span class="md-nav__icon md-icon"></span>
          Ray Data
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../ray-ml/ray-data/key-concepts/" class="md-nav__link">
        Key concepts
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_1_5_3" type="checkbox" id="__nav_1_5_3" >
      
      
      
        
          
            
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../../ray-ml/ray-data/tutorials/">Tutorials</a>
          
        </div>
      
      <nav class="md-nav" aria-label="Tutorials" data-md-level="3">
        <label class="md-nav__title" for="__nav_1_5_3">
          <span class="md-nav__icon md-icon"></span>
          Tutorials
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_1_6" type="checkbox" id="__nav_1_6" >
      
      
      
        
          
            
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../../ray-ml/ray-train/">Ray Train</a>
          
            <label for="__nav_1_6">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="Ray Train" data-md-level="2">
        <label class="md-nav__title" for="__nav_1_6">
          <span class="md-nav__icon md-icon"></span>
          Ray Train
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../ray-ml/ray-train/key-concepts/" class="md-nav__link">
        Key concepts
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../ray-ml/ray-train/tutorials/" class="md-nav__link">
        Tutorials
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_1_7" type="checkbox" id="__nav_1_7" >
      
      
      
        
          
            
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../../ray-ml/ray-rllib/">Ray RLlib</a>
          
            <label for="__nav_1_7">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="Ray RLlib" data-md-level="2">
        <label class="md-nav__title" for="__nav_1_7">
          <span class="md-nav__icon md-icon"></span>
          Ray RLlib
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../ray-ml/ray-rllib/key-concepts/" class="md-nav__link">
        Key concepts
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../ray-ml/ray-rllib/tutorials/" class="md-nav__link">
        Tutorials
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_1_8" type="checkbox" id="__nav_1_8" >
      
      
      
        
          
            
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../../ray-ml/ray-tune/">Ray Tune</a>
          
            <label for="__nav_1_8">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="Ray Tune" data-md-level="2">
        <label class="md-nav__title" for="__nav_1_8">
          <span class="md-nav__icon md-icon"></span>
          Ray Tune
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../ray-ml/ray-tune/key-concepts/" class="md-nav__link">
        Key concepts
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../ray-ml/ray-tune/tutorials/" class="md-nav__link">
        Tutorials
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_1_9" type="checkbox" id="__nav_1_9" >
      
      
      
        
          
            
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../../ray-ml/ray-serve/">Ray Serve</a>
          
            <label for="__nav_1_9">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="Ray Serve" data-md-level="2">
        <label class="md-nav__title" for="__nav_1_9">
          <span class="md-nav__icon md-icon"></span>
          Ray Serve
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../ray-ml/ray-serve/key-concepts/" class="md-nav__link">
        Key concepts
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_1_9_3" type="checkbox" id="__nav_1_9_3" >
      
      
      
        
          
            
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../../ray-ml/ray-serve/tutorials/">Tutorials</a>
          
            <label for="__nav_1_9_3">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="Tutorials" data-md-level="3">
        <label class="md-nav__title" for="__nav_1_9_3">
          <span class="md-nav__icon md-icon"></span>
          Tutorials
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../ray-ml/ray-serve/tutorials/model-composition/" class="md-nav__link">
        Model composition
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_1_10" type="checkbox" id="__nav_1_10" >
      
      
      
        
          
            
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../../ray-ml/ray-workflows/">Ray Workflows</a>
          
            <label for="__nav_1_10">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="Ray Workflows" data-md-level="2">
        <label class="md-nav__title" for="__nav_1_10">
          <span class="md-nav__icon md-icon"></span>
          Ray Workflows
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../ray-ml/ray-workflows/key-concepts/" class="md-nav__link">
        Key concepts
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../ray-ml/ray-workflows/tutorials/" class="md-nav__link">
        Tutorials
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      
      
        
          
            
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../../ray-deployment/">Deploying Ray</a>
          
            <label for="__nav_2">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="Deploying Ray" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Deploying Ray
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../ray-deployment/key-concepts/" class="md-nav__link">
        Key concepts
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../ray-deployment/tutorials/" class="md-nav__link">
        Tutorials
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      
      
        
          
            
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../../ray-ecosystem/">Ecosystem</a>
          
            <label for="__nav_3">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="Ecosystem" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Ecosystem
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../ray-ecosystem/integrations/integrations/" class="md-nav__link">
        Integrations
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../ray-ecosystem/integrations/joblib/" class="md-nav__link">
        Joblib
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      
      
        
          
            
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../../ray-examples/">Examples</a>
          
            <label for="__nav_4">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="Examples" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Examples
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_2" type="checkbox" id="__nav_4_2" >
      
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4_2">
          Crash Course
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Crash Course" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_2">
          <span class="md-nav__icon md-icon"></span>
          Crash Course
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../ray-examples/ray-crash-course/00-Ray-Crash-Course-Overview/" class="md-nav__link">
        Ray "Crash Course" Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../ray-examples/ray-crash-course/01-Ray-Tasks/" class="md-nav__link">
        Ray Crash Course - Tasks
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../ray-examples/ray-crash-course/02-Ray-Actors/" class="md-nav__link">
        Ray Crash Course - Actors
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../ray-examples/ray-crash-course/03-Why-Ray/" class="md-nav__link">
        Ray Crash Course - Why Ray?
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../ray-examples/ray-crash-course/04-Ray-Multiprocessing/" class="md-nav__link">
        Ray Crash Course - Python Multiprocessing with Ray
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../ray-examples/ray-crash-course/05-Ray-Parallel-Iterators/" class="md-nav__link">
        Ray Crash Course - Ray Parallel Iterators (Now deprecated in Ray 1.7)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../ray-examples/ray-crash-course/06-Exploring-Ray-API-Calls/" class="md-nav__link">
        Ray Crash Course - Exploring Ray API Calls
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../ray-examples/ray-crash-course/07-Running-Ray-Clusters/" class="md-nav__link">
        Ray Crash Course - Ray Clusters and the Ray CLI
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" checked>
      
      
      
        
          
            
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../">API</a>
          
            <label for="__nav_5">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="API" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          API
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5_2" type="checkbox" id="__nav_5_2" checked>
      
      
      
        
          
            
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../">Ray RLlib</a>
          
            <label for="__nav_5_2">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="Ray RLlib" data-md-level="2">
        <label class="md-nav__title" for="__nav_5_2">
          <span class="md-nav__icon md-icon"></span>
          Ray RLlib
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../agents/" class="md-nav__link">
        Agents
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../policy/" class="md-nav__link">
        Policies
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../env/" class="md-nav__link">
        Environments
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../models/" class="md-nav__link">
        Models
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Evaluation
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Evaluation
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#episodes" class="md-nav__link">
    Episodes
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.episode.Episode" class="md-nav__link">
    Episode
  </a>
  
    <nav class="md-nav" aria-label="Episode">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.episode.Episode.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.episode.Episode.get_agents" class="md-nav__link">
    get_agents()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.episode.Episode.last_action_for" class="md-nav__link">
    last_action_for()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.episode.Episode.last_done_for" class="md-nav__link">
    last_done_for()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.episode.Episode.last_extra_action_outs_for" class="md-nav__link">
    last_extra_action_outs_for()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.episode.Episode.last_info_for" class="md-nav__link">
    last_info_for()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.episode.Episode.last_observation_for" class="md-nav__link">
    last_observation_for()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.episode.Episode.last_raw_obs_for" class="md-nav__link">
    last_raw_obs_for()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.episode.Episode.last_reward_for" class="md-nav__link">
    last_reward_for()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.episode.Episode.policy_for" class="md-nav__link">
    policy_for()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.episode.Episode.prev_action_for" class="md-nav__link">
    prev_action_for()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.episode.Episode.prev_reward_for" class="md-nav__link">
    prev_reward_for()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.episode.Episode.rnn_state_for" class="md-nav__link">
    rnn_state_for()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.episode.Episode.soft_reset" class="md-nav__link">
    soft_reset()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.episode.MultiAgentEpisode" class="md-nav__link">
    MultiAgentEpisode
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rollouts" class="md-nav__link">
    Rollouts
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.rollout_worker.RolloutWorker" class="md-nav__link">
    RolloutWorker
  </a>
  
    <nav class="md-nav" aria-label="RolloutWorker">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.rollout_worker.RolloutWorker.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.rollout_worker.RolloutWorker.add_policy" class="md-nav__link">
    add_policy()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.rollout_worker.RolloutWorker.apply" class="md-nav__link">
    apply()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.rollout_worker.RolloutWorker.apply_gradients" class="md-nav__link">
    apply_gradients()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.rollout_worker.RolloutWorker.as_remote" class="md-nav__link">
    as_remote()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.rollout_worker.RolloutWorker.compute_gradients" class="md-nav__link">
    compute_gradients()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.rollout_worker.RolloutWorker.creation_args" class="md-nav__link">
    creation_args()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.rollout_worker.RolloutWorker.find_free_port" class="md-nav__link">
    find_free_port()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.rollout_worker.RolloutWorker.for_policy" class="md-nav__link">
    for_policy()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.rollout_worker.RolloutWorker.foreach_env" class="md-nav__link">
    foreach_env()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.rollout_worker.RolloutWorker.foreach_env_with_context" class="md-nav__link">
    foreach_env_with_context()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.rollout_worker.RolloutWorker.foreach_policy" class="md-nav__link">
    foreach_policy()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.rollout_worker.RolloutWorker.foreach_trainable_policy" class="md-nav__link">
    foreach_trainable_policy()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.rollout_worker.RolloutWorker.get_filters" class="md-nav__link">
    get_filters()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.rollout_worker.RolloutWorker.get_global_vars" class="md-nav__link">
    get_global_vars()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.rollout_worker.RolloutWorker.get_host" class="md-nav__link">
    get_host()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.rollout_worker.RolloutWorker.get_metrics" class="md-nav__link">
    get_metrics()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.rollout_worker.RolloutWorker.get_node_ip" class="md-nav__link">
    get_node_ip()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.rollout_worker.RolloutWorker.get_policy" class="md-nav__link">
    get_policy()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.rollout_worker.RolloutWorker.get_weights" class="md-nav__link">
    get_weights()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.rollout_worker.RolloutWorker.learn_on_batch" class="md-nav__link">
    learn_on_batch()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.rollout_worker.RolloutWorker.remove_policy" class="md-nav__link">
    remove_policy()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.rollout_worker.RolloutWorker.restore" class="md-nav__link">
    restore()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.rollout_worker.RolloutWorker.sample" class="md-nav__link">
    sample()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.rollout_worker.RolloutWorker.sample_and_learn" class="md-nav__link">
    sample_and_learn()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.rollout_worker.RolloutWorker.sample_with_count" class="md-nav__link">
    sample_with_count()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.rollout_worker.RolloutWorker.save" class="md-nav__link">
    save()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.rollout_worker.RolloutWorker.set_global_vars" class="md-nav__link">
    set_global_vars()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.rollout_worker.RolloutWorker.set_policies_to_train" class="md-nav__link">
    set_policies_to_train()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.rollout_worker.RolloutWorker.set_policy_mapping_fn" class="md-nav__link">
    set_policy_mapping_fn()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.rollout_worker.RolloutWorker.set_weights" class="md-nav__link">
    set_weights()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.rollout_worker.RolloutWorker.setup_torch_data_parallel" class="md-nav__link">
    setup_torch_data_parallel()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.rollout_worker.RolloutWorker.stop" class="md-nav__link">
    stop()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.rollout_worker.RolloutWorker.sync_filters" class="md-nav__link">
    sync_filters()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sample-batches" class="md-nav__link">
    Sample Batches
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ray.rllib.policy.sample_batch.SampleBatch" class="md-nav__link">
    SampleBatch
  </a>
  
    <nav class="md-nav" aria-label="SampleBatch">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ray.rllib.policy.sample_batch.SampleBatch.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.policy.sample_batch.SampleBatch.columns" class="md-nav__link">
    columns()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.policy.sample_batch.SampleBatch.compress" class="md-nav__link">
    compress()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.policy.sample_batch.SampleBatch.concat" class="md-nav__link">
    concat()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.policy.sample_batch.SampleBatch.concat_samples" class="md-nav__link">
    concat_samples()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.policy.sample_batch.SampleBatch.copy" class="md-nav__link">
    copy()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.policy.sample_batch.SampleBatch.decompress_if_needed" class="md-nav__link">
    decompress_if_needed()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.policy.sample_batch.SampleBatch.get" class="md-nav__link">
    get()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.policy.sample_batch.SampleBatch.get_single_step_input_dict" class="md-nav__link">
    get_single_step_input_dict()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.policy.sample_batch.SampleBatch.right_zero_pad" class="md-nav__link">
    right_zero_pad()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.policy.sample_batch.SampleBatch.rows" class="md-nav__link">
    rows()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.policy.sample_batch.SampleBatch.shuffle" class="md-nav__link">
    shuffle()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.policy.sample_batch.SampleBatch.size_bytes" class="md-nav__link">
    size_bytes()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.policy.sample_batch.SampleBatch.split_by_episode" class="md-nav__link">
    split_by_episode()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.policy.sample_batch.SampleBatch.timeslices" class="md-nav__link">
    timeslices()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.policy.sample_batch.SampleBatch.to_device" class="md-nav__link">
    to_device()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.sample_batch_builder.SampleBatchBuilder" class="md-nav__link">
    SampleBatchBuilder
  </a>
  
    <nav class="md-nav" aria-label="SampleBatchBuilder">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.sample_batch_builder.SampleBatchBuilder.add_batch" class="md-nav__link">
    add_batch()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.sample_batch_builder.SampleBatchBuilder.add_values" class="md-nav__link">
    add_values()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.sample_batch_builder.SampleBatchBuilder.build_and_reset" class="md-nav__link">
    build_and_reset()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ray.rllib.policy.sample_batch.MultiAgentBatch" class="md-nav__link">
    MultiAgentBatch
  </a>
  
    <nav class="md-nav" aria-label="MultiAgentBatch">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ray.rllib.policy.sample_batch.MultiAgentBatch.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.policy.sample_batch.MultiAgentBatch.agent_steps" class="md-nav__link">
    agent_steps()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.policy.sample_batch.MultiAgentBatch.compress" class="md-nav__link">
    compress()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.policy.sample_batch.MultiAgentBatch.concat_samples" class="md-nav__link">
    concat_samples()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.policy.sample_batch.MultiAgentBatch.copy" class="md-nav__link">
    copy()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.policy.sample_batch.MultiAgentBatch.decompress_if_needed" class="md-nav__link">
    decompress_if_needed()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.policy.sample_batch.MultiAgentBatch.env_steps" class="md-nav__link">
    env_steps()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.policy.sample_batch.MultiAgentBatch.size_bytes" class="md-nav__link">
    size_bytes()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.policy.sample_batch.MultiAgentBatch.timeslices" class="md-nav__link">
    timeslices()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.policy.sample_batch.MultiAgentBatch.wrap_as_needed" class="md-nav__link">
    wrap_as_needed()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.sample_batch_builder.MultiAgentSampleBatchBuilder" class="md-nav__link">
    MultiAgentSampleBatchBuilder
  </a>
  
    <nav class="md-nav" aria-label="MultiAgentSampleBatchBuilder">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.sample_batch_builder.MultiAgentSampleBatchBuilder.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.sample_batch_builder.MultiAgentSampleBatchBuilder.add_values" class="md-nav__link">
    add_values()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.sample_batch_builder.MultiAgentSampleBatchBuilder.build_and_reset" class="md-nav__link">
    build_and_reset()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.sample_batch_builder.MultiAgentSampleBatchBuilder.has_pending_agent_data" class="md-nav__link">
    has_pending_agent_data()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.sample_batch_builder.MultiAgentSampleBatchBuilder.postprocess_batch_so_far" class="md-nav__link">
    postprocess_batch_so_far()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.sample_batch_builder.MultiAgentSampleBatchBuilder.total" class="md-nav__link">
    total()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#samplers" class="md-nav__link">
    Samplers
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.sampler.SyncSampler" class="md-nav__link">
    SyncSampler
  </a>
  
    <nav class="md-nav" aria-label="SyncSampler">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.sampler.SyncSampler.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.sampler.SyncSampler.get_data" class="md-nav__link">
    get_data()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.sampler.SyncSampler.get_extra_batches" class="md-nav__link">
    get_extra_batches()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.sampler.SyncSampler.get_metrics" class="md-nav__link">
    get_metrics()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.sampler.AsyncSampler" class="md-nav__link">
    AsyncSampler
  </a>
  
    <nav class="md-nav" aria-label="AsyncSampler">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.sampler.AsyncSampler.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.sampler.AsyncSampler.get_data" class="md-nav__link">
    get_data()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.sampler.AsyncSampler.get_extra_batches" class="md-nav__link">
    get_extra_batches()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.sampler.AsyncSampler.get_metrics" class="md-nav__link">
    get_metrics()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.sampler.AsyncSampler.run" class="md-nav__link">
    run()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#utility-functions" class="md-nav__link">
    Utility Functions
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.postprocessing.compute_advantages" class="md-nav__link">
    compute_advantages()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.metrics.collect_metrics" class="md-nav__link">
    collect_metrics()
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../execution/" class="md-nav__link">
        Execution
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../utils/" class="md-nav__link">
        Utility
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../ray-core/" class="md-nav__link">
        Ray Core
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../ray-data/" class="md-nav__link">
        Ray Data
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../ray-train/" class="md-nav__link">
        Ray Train
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../ray-tune/" class="md-nav__link">
        Ray Tune
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../ray-workflows/" class="md-nav__link">
        Ray Workflows
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../ray-serve/" class="md-nav__link">
        Ray Serve
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6" type="checkbox" id="__nav_6" >
      
      
      
        
          
            
          
        
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../../ray-contributor-guide/">Contribute</a>
          
            <label for="__nav_6">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="Contribute" data-md-level="1">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          Contribute
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../ray-contributor-guide/getting-involved/" class="md-nav__link">
        Start Contributing
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../ray-contributor-guide/installing-ray/building-ray-on-linux-and-macos/" class="md-nav__link">
        Building Ray on Linux and macOS
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../ray-contributor-guide/installing-ray/building-ray-on-windows/" class="md-nav__link">
        Building Ray on Windows
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#episodes" class="md-nav__link">
    Episodes
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.episode.Episode" class="md-nav__link">
    Episode
  </a>
  
    <nav class="md-nav" aria-label="Episode">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.episode.Episode.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.episode.Episode.get_agents" class="md-nav__link">
    get_agents()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.episode.Episode.last_action_for" class="md-nav__link">
    last_action_for()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.episode.Episode.last_done_for" class="md-nav__link">
    last_done_for()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.episode.Episode.last_extra_action_outs_for" class="md-nav__link">
    last_extra_action_outs_for()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.episode.Episode.last_info_for" class="md-nav__link">
    last_info_for()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.episode.Episode.last_observation_for" class="md-nav__link">
    last_observation_for()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.episode.Episode.last_raw_obs_for" class="md-nav__link">
    last_raw_obs_for()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.episode.Episode.last_reward_for" class="md-nav__link">
    last_reward_for()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.episode.Episode.policy_for" class="md-nav__link">
    policy_for()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.episode.Episode.prev_action_for" class="md-nav__link">
    prev_action_for()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.episode.Episode.prev_reward_for" class="md-nav__link">
    prev_reward_for()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.episode.Episode.rnn_state_for" class="md-nav__link">
    rnn_state_for()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.episode.Episode.soft_reset" class="md-nav__link">
    soft_reset()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.episode.MultiAgentEpisode" class="md-nav__link">
    MultiAgentEpisode
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rollouts" class="md-nav__link">
    Rollouts
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.rollout_worker.RolloutWorker" class="md-nav__link">
    RolloutWorker
  </a>
  
    <nav class="md-nav" aria-label="RolloutWorker">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.rollout_worker.RolloutWorker.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.rollout_worker.RolloutWorker.add_policy" class="md-nav__link">
    add_policy()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.rollout_worker.RolloutWorker.apply" class="md-nav__link">
    apply()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.rollout_worker.RolloutWorker.apply_gradients" class="md-nav__link">
    apply_gradients()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.rollout_worker.RolloutWorker.as_remote" class="md-nav__link">
    as_remote()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.rollout_worker.RolloutWorker.compute_gradients" class="md-nav__link">
    compute_gradients()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.rollout_worker.RolloutWorker.creation_args" class="md-nav__link">
    creation_args()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.rollout_worker.RolloutWorker.find_free_port" class="md-nav__link">
    find_free_port()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.rollout_worker.RolloutWorker.for_policy" class="md-nav__link">
    for_policy()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.rollout_worker.RolloutWorker.foreach_env" class="md-nav__link">
    foreach_env()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.rollout_worker.RolloutWorker.foreach_env_with_context" class="md-nav__link">
    foreach_env_with_context()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.rollout_worker.RolloutWorker.foreach_policy" class="md-nav__link">
    foreach_policy()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.rollout_worker.RolloutWorker.foreach_trainable_policy" class="md-nav__link">
    foreach_trainable_policy()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.rollout_worker.RolloutWorker.get_filters" class="md-nav__link">
    get_filters()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.rollout_worker.RolloutWorker.get_global_vars" class="md-nav__link">
    get_global_vars()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.rollout_worker.RolloutWorker.get_host" class="md-nav__link">
    get_host()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.rollout_worker.RolloutWorker.get_metrics" class="md-nav__link">
    get_metrics()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.rollout_worker.RolloutWorker.get_node_ip" class="md-nav__link">
    get_node_ip()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.rollout_worker.RolloutWorker.get_policy" class="md-nav__link">
    get_policy()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.rollout_worker.RolloutWorker.get_weights" class="md-nav__link">
    get_weights()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.rollout_worker.RolloutWorker.learn_on_batch" class="md-nav__link">
    learn_on_batch()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.rollout_worker.RolloutWorker.remove_policy" class="md-nav__link">
    remove_policy()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.rollout_worker.RolloutWorker.restore" class="md-nav__link">
    restore()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.rollout_worker.RolloutWorker.sample" class="md-nav__link">
    sample()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.rollout_worker.RolloutWorker.sample_and_learn" class="md-nav__link">
    sample_and_learn()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.rollout_worker.RolloutWorker.sample_with_count" class="md-nav__link">
    sample_with_count()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.rollout_worker.RolloutWorker.save" class="md-nav__link">
    save()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.rollout_worker.RolloutWorker.set_global_vars" class="md-nav__link">
    set_global_vars()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.rollout_worker.RolloutWorker.set_policies_to_train" class="md-nav__link">
    set_policies_to_train()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.rollout_worker.RolloutWorker.set_policy_mapping_fn" class="md-nav__link">
    set_policy_mapping_fn()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.rollout_worker.RolloutWorker.set_weights" class="md-nav__link">
    set_weights()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.rollout_worker.RolloutWorker.setup_torch_data_parallel" class="md-nav__link">
    setup_torch_data_parallel()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.rollout_worker.RolloutWorker.stop" class="md-nav__link">
    stop()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.rollout_worker.RolloutWorker.sync_filters" class="md-nav__link">
    sync_filters()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sample-batches" class="md-nav__link">
    Sample Batches
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ray.rllib.policy.sample_batch.SampleBatch" class="md-nav__link">
    SampleBatch
  </a>
  
    <nav class="md-nav" aria-label="SampleBatch">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ray.rllib.policy.sample_batch.SampleBatch.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.policy.sample_batch.SampleBatch.columns" class="md-nav__link">
    columns()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.policy.sample_batch.SampleBatch.compress" class="md-nav__link">
    compress()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.policy.sample_batch.SampleBatch.concat" class="md-nav__link">
    concat()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.policy.sample_batch.SampleBatch.concat_samples" class="md-nav__link">
    concat_samples()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.policy.sample_batch.SampleBatch.copy" class="md-nav__link">
    copy()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.policy.sample_batch.SampleBatch.decompress_if_needed" class="md-nav__link">
    decompress_if_needed()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.policy.sample_batch.SampleBatch.get" class="md-nav__link">
    get()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.policy.sample_batch.SampleBatch.get_single_step_input_dict" class="md-nav__link">
    get_single_step_input_dict()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.policy.sample_batch.SampleBatch.right_zero_pad" class="md-nav__link">
    right_zero_pad()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.policy.sample_batch.SampleBatch.rows" class="md-nav__link">
    rows()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.policy.sample_batch.SampleBatch.shuffle" class="md-nav__link">
    shuffle()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.policy.sample_batch.SampleBatch.size_bytes" class="md-nav__link">
    size_bytes()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.policy.sample_batch.SampleBatch.split_by_episode" class="md-nav__link">
    split_by_episode()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.policy.sample_batch.SampleBatch.timeslices" class="md-nav__link">
    timeslices()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.policy.sample_batch.SampleBatch.to_device" class="md-nav__link">
    to_device()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.sample_batch_builder.SampleBatchBuilder" class="md-nav__link">
    SampleBatchBuilder
  </a>
  
    <nav class="md-nav" aria-label="SampleBatchBuilder">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.sample_batch_builder.SampleBatchBuilder.add_batch" class="md-nav__link">
    add_batch()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.sample_batch_builder.SampleBatchBuilder.add_values" class="md-nav__link">
    add_values()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.sample_batch_builder.SampleBatchBuilder.build_and_reset" class="md-nav__link">
    build_and_reset()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ray.rllib.policy.sample_batch.MultiAgentBatch" class="md-nav__link">
    MultiAgentBatch
  </a>
  
    <nav class="md-nav" aria-label="MultiAgentBatch">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ray.rllib.policy.sample_batch.MultiAgentBatch.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.policy.sample_batch.MultiAgentBatch.agent_steps" class="md-nav__link">
    agent_steps()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.policy.sample_batch.MultiAgentBatch.compress" class="md-nav__link">
    compress()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.policy.sample_batch.MultiAgentBatch.concat_samples" class="md-nav__link">
    concat_samples()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.policy.sample_batch.MultiAgentBatch.copy" class="md-nav__link">
    copy()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.policy.sample_batch.MultiAgentBatch.decompress_if_needed" class="md-nav__link">
    decompress_if_needed()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.policy.sample_batch.MultiAgentBatch.env_steps" class="md-nav__link">
    env_steps()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.policy.sample_batch.MultiAgentBatch.size_bytes" class="md-nav__link">
    size_bytes()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.policy.sample_batch.MultiAgentBatch.timeslices" class="md-nav__link">
    timeslices()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.policy.sample_batch.MultiAgentBatch.wrap_as_needed" class="md-nav__link">
    wrap_as_needed()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.sample_batch_builder.MultiAgentSampleBatchBuilder" class="md-nav__link">
    MultiAgentSampleBatchBuilder
  </a>
  
    <nav class="md-nav" aria-label="MultiAgentSampleBatchBuilder">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.sample_batch_builder.MultiAgentSampleBatchBuilder.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.sample_batch_builder.MultiAgentSampleBatchBuilder.add_values" class="md-nav__link">
    add_values()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.sample_batch_builder.MultiAgentSampleBatchBuilder.build_and_reset" class="md-nav__link">
    build_and_reset()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.sample_batch_builder.MultiAgentSampleBatchBuilder.has_pending_agent_data" class="md-nav__link">
    has_pending_agent_data()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.sample_batch_builder.MultiAgentSampleBatchBuilder.postprocess_batch_so_far" class="md-nav__link">
    postprocess_batch_so_far()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.sample_batch_builder.MultiAgentSampleBatchBuilder.total" class="md-nav__link">
    total()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#samplers" class="md-nav__link">
    Samplers
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.sampler.SyncSampler" class="md-nav__link">
    SyncSampler
  </a>
  
    <nav class="md-nav" aria-label="SyncSampler">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.sampler.SyncSampler.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.sampler.SyncSampler.get_data" class="md-nav__link">
    get_data()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.sampler.SyncSampler.get_extra_batches" class="md-nav__link">
    get_extra_batches()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.sampler.SyncSampler.get_metrics" class="md-nav__link">
    get_metrics()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.sampler.AsyncSampler" class="md-nav__link">
    AsyncSampler
  </a>
  
    <nav class="md-nav" aria-label="AsyncSampler">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.sampler.AsyncSampler.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.sampler.AsyncSampler.get_data" class="md-nav__link">
    get_data()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.sampler.AsyncSampler.get_extra_batches" class="md-nav__link">
    get_extra_batches()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.sampler.AsyncSampler.get_metrics" class="md-nav__link">
    get_metrics()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.sampler.AsyncSampler.run" class="md-nav__link">
    run()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#utility-functions" class="md-nav__link">
    Utility Functions
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.postprocessing.compute_advantages" class="md-nav__link">
    compute_advantages()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ray.rllib.evaluation.metrics.collect_metrics" class="md-nav__link">
    collect_metrics()
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                

<h1 id="evaluation-package"><code>evaluation</code> Package</h1>
<h2 id="episodes">Episodes</h2>


  <div class="doc doc-object doc-class">



<h2 class="doc doc-heading" id="ray.rllib.evaluation.episode.Episode">
        <code>
ray.rllib.evaluation.episode.Episode        </code>



</h2>

    <div class="doc doc-contents first">

      <p>Tracks the current state of a (possibly multi-agent) episode.</p>

<p><strong>Attributes:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>new_batch_builder</code></td>
        <td><code>func</code></td>
        <td><p>Create a new MultiAgentSampleBatchBuilder.</p></td>
      </tr>
      <tr>
        <td><code>add_extra_batch</code></td>
        <td><code>func</code></td>
        <td><p>Return a built MultiAgentBatch to the sampler.</p></td>
      </tr>
      <tr>
        <td><code>batch_builder</code></td>
        <td><code>obj</code></td>
        <td><p>Batch builder for the current episode.</p></td>
      </tr>
      <tr>
        <td><code>total_reward</code></td>
        <td><code>float</code></td>
        <td><p>Summed reward across all agents in this episode.</p></td>
      </tr>
      <tr>
        <td><code>length</code></td>
        <td><code>int</code></td>
        <td><p>Length of this episode.</p></td>
      </tr>
      <tr>
        <td><code>episode_id</code></td>
        <td><code>int</code></td>
        <td><p>Unique id identifying this trajectory.</p></td>
      </tr>
      <tr>
        <td><code>agent_rewards</code></td>
        <td><code>dict</code></td>
        <td><p>Summed rewards broken down by agent.</p></td>
      </tr>
      <tr>
        <td><code>custom_metrics</code></td>
        <td><code>dict</code></td>
        <td><p>Dict where the you can add custom metrics.</p></td>
      </tr>
      <tr>
        <td><code>user_data</code></td>
        <td><code>dict</code></td>
        <td><p>Dict that you can use for temporary storage. E.g.
in between two custom callbacks referring to the same episode.</p></td>
      </tr>
      <tr>
        <td><code>hist_data</code></td>
        <td><code>dict</code></td>
        <td><p>Dict mapping str keys to List[float] for storage of
per-timestep float data throughout the episode.</p></td>
      </tr>
  </tbody>
</table>      <p>Use case 1: Model-based rollouts in multi-agent:
    A custom compute_actions() function in a policy can inspect the
    current episode state and perform a number of rollouts based on the
    policies and state of other agents in the environment.</p>
<p>Use case 2: Returning extra rollouts data.
    The model rollouts can be returned back to the sampler by calling:</p>
<div class="highlight"><pre><span></span><code>&gt;&gt;&gt; batch = episode.new_batch_builder()
&gt;&gt;&gt; for each transition:
       batch.add_values(...)  # see sampler for usage
&gt;&gt;&gt; episode.extra_batches.add(batch.build_and_reset())
</code></pre></div>




  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="ray.rllib.evaluation.episode.Episode.__init__">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">policies</span><span class="p">,</span> <span class="n">policy_mapping_fn</span><span class="p">,</span> <span class="n">batch_builder_factory</span><span class="p">,</span> <span class="n">extra_batch_callback</span><span class="p">,</span> <span class="n">env_id</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">worker</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

</h3>

    <div class="doc doc-contents ">

      <p>Initializes an Episode instance.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>policies</code></td>
        <td><code>PolicyMap</code></td>
        <td><p>The PolicyMap object (mapping PolicyIDs to Policy
objects) to use for determining, which policy is used for
which agent.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>policy_mapping_fn</code></td>
        <td><code>Callable[[Any, Episode, RolloutWorker], str]</code></td>
        <td><p>The mapping function mapping AgentIDs to
PolicyIDs.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>batch_builder_factory</code></td>
        <td><code>Callable[[], MultiAgentSampleBatchBuilder]</code></td>
        <td></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>extra_batch_callback</code></td>
        <td><code>Callable[[Union[SampleBatch, MultiAgentBatch]]]</code></td>
        <td></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>env_id</code></td>
        <td><code>Union[int, str]</code></td>
        <td><p>The environment's ID in which this episode runs.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>worker</code></td>
        <td><code>Optional[RolloutWorker]</code></td>
        <td><p>The RolloutWorker instance, in which this episode runs.</p></td>
        <td><code>None</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>ray/rllib/evaluation/episode.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>        <span class="n">policies</span><span class="p">:</span> <span class="n">PolicyMap</span><span class="p">,</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>        <span class="n">policy_mapping_fn</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">AgentID</span><span class="p">,</span> <span class="s2">&quot;Episode&quot;</span><span class="p">,</span> <span class="s2">&quot;RolloutWorker&quot;</span><span class="p">],</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a>                                    <span class="n">PolicyID</span><span class="p">],</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a>        <span class="n">batch_builder_factory</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[],</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a>                                        <span class="s2">&quot;MultiAgentSampleBatchBuilder&quot;</span><span class="p">],</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a>        <span class="n">extra_batch_callback</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">SampleBatchType</span><span class="p">],</span> <span class="kc">None</span><span class="p">],</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a>        <span class="n">env_id</span><span class="p">:</span> <span class="n">EnvID</span><span class="p">,</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a>        <span class="o">*</span><span class="p">,</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a>        <span class="n">worker</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;RolloutWorker&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="p">):</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a>    <span class="sd">&quot;&quot;&quot;Initializes an Episode instance.</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="sd">        policies: The PolicyMap object (mapping PolicyIDs to Policy</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="sd">            objects) to use for determining, which policy is used for</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="sd">            which agent.</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="sd">        policy_mapping_fn: The mapping function mapping AgentIDs to</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="sd">            PolicyIDs.</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a><span class="sd">        batch_builder_factory:</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a><span class="sd">        extra_batch_callback:</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a><span class="sd">        env_id: The environment&#39;s ID in which this episode runs.</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a><span class="sd">        worker: The RolloutWorker instance, in which this episode runs.</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">new_batch_builder</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a>        <span class="p">[],</span> <span class="s2">&quot;MultiAgentSampleBatchBuilder&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">batch_builder_factory</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">add_extra_batch</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">SampleBatchType</span><span class="p">],</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a>                                   <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="n">extra_batch_callback</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">batch_builder</span><span class="p">:</span> <span class="s2">&quot;MultiAgentSampleBatchBuilder&quot;</span> <span class="o">=</span> \
<a id="__codelineno-0-31" name="__codelineno-0-31"></a>        <span class="n">batch_builder_factory</span><span class="p">()</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">total_reward</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">episode_id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="mf">2e9</span><span class="p">)</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">env_id</span> <span class="o">=</span> <span class="n">env_id</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">worker</span> <span class="o">=</span> <span class="n">worker</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">agent_rewards</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">AgentID</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">custom_metrics</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">user_data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">hist_data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">media</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">policy_map</span><span class="p">:</span> <span class="n">PolicyMap</span> <span class="o">=</span> <span class="n">policies</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_policies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">policy_map</span>  <span class="c1"># backward compatibility</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">policy_mapping_fn</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">AgentID</span><span class="p">,</span> <span class="s2">&quot;Episode&quot;</span><span class="p">,</span> <span class="s2">&quot;RolloutWorker&quot;</span><span class="p">],</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>                                     <span class="n">PolicyID</span><span class="p">]</span> <span class="o">=</span> <span class="n">policy_mapping_fn</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_next_agent_index</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_agent_to_index</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">AgentID</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_agent_to_policy</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">AgentID</span><span class="p">,</span> <span class="n">PolicyID</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_agent_to_rnn_state</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">AgentID</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_agent_to_last_obs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">AgentID</span><span class="p">,</span> <span class="n">EnvObsType</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_agent_to_last_raw_obs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">AgentID</span><span class="p">,</span> <span class="n">EnvObsType</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_agent_to_last_done</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">AgentID</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_agent_to_last_info</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">AgentID</span><span class="p">,</span> <span class="n">EnvInfoDict</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_agent_to_last_action</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">AgentID</span><span class="p">,</span> <span class="n">EnvActionType</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_agent_to_last_extra_action_outs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">AgentID</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_agent_to_prev_action</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">AgentID</span><span class="p">,</span> <span class="n">EnvActionType</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_agent_reward_history</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">AgentID</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>        <span class="nb">list</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="ray.rllib.evaluation.episode.Episode.get_agents">
<code class="highlight language-python"><span class="n">get_agents</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Returns list of agent IDs that have appeared in this episode.</p>

<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>List[Any]</code></td>
      <td><p>The list of all agent IDs that have appeared so far in this
episode.</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>ray/rllib/evaluation/episode.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nd">@DeveloperAPI</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="k">def</span> <span class="nf">get_agents</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">AgentID</span><span class="p">]:</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>    <span class="sd">&quot;&quot;&quot;Returns list of agent IDs that have appeared in this episode.</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="sd">        The list of all agent IDs that have appeared so far in this</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="sd">        episode.</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a>    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_agent_to_index</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="ray.rllib.evaluation.episode.Episode.last_action_for">
<code class="highlight language-python"><span class="n">last_action_for</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent_id</span><span class="o">=</span><span class="s1">&#39;agent0&#39;</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Returns the last action for the specified AgentID, or zeros.</p>
<p>The "last" action is the most recent one taken by the agent.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>agent_id</code></td>
        <td><code>Any</code></td>
        <td><p>The agent's ID to get the last action for.</p></td>
        <td><code>&#39;agent0&#39;</code></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>Any</code></td>
      <td><p>Last action the specified AgentID has executed.
Zeros in case the agent has never performed any actions in the
episode.</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>ray/rllib/evaluation/episode.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nd">@DeveloperAPI</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="k">def</span> <span class="nf">last_action_for</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>                    <span class="n">agent_id</span><span class="p">:</span> <span class="n">AgentID</span> <span class="o">=</span> <span class="n">_DUMMY_AGENT_ID</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EnvActionType</span><span class="p">:</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>    <span class="sd">&quot;&quot;&quot;Returns the last action for the specified AgentID, or zeros.</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="sd">    The &quot;last&quot; action is the most recent one taken by the agent.</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="sd">        agent_id: The agent&#39;s ID to get the last action for.</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="sd">        Last action the specified AgentID has executed.</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="sd">        Zeros in case the agent has never performed any actions in the</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="sd">        episode.</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a>    <span class="c1"># Agent has already taken at least one action in the episode.</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a>    <span class="k">if</span> <span class="n">agent_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_agent_to_last_action</span><span class="p">:</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a>        <span class="k">return</span> <span class="n">flatten_to_single_ndarray</span><span class="p">(</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_agent_to_last_action</span><span class="p">[</span><span class="n">agent_id</span><span class="p">])</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a>    <span class="c1"># Agent has not acted yet, return all zeros.</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a>        <span class="n">policy_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">policy_for</span><span class="p">(</span><span class="n">agent_id</span><span class="p">)</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a>        <span class="n">policy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">policy_map</span><span class="p">[</span><span class="n">policy_id</span><span class="p">]</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a>        <span class="n">flat</span> <span class="o">=</span> <span class="n">flatten_to_single_ndarray</span><span class="p">(</span><span class="n">policy</span><span class="o">.</span><span class="n">action_space</span><span class="o">.</span><span class="n">sample</span><span class="p">())</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a>        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">policy</span><span class="o">.</span><span class="n">action_space</span><span class="p">,</span> <span class="s2">&quot;dtype&quot;</span><span class="p">):</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a>            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">flat</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">policy</span><span class="o">.</span><span class="n">action_space</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a>        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">flat</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="ray.rllib.evaluation.episode.Episode.last_done_for">
<code class="highlight language-python"><span class="n">last_done_for</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent_id</span><span class="o">=</span><span class="s1">&#39;agent0&#39;</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Returns the last done flag for the specified AgentID.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>agent_id</code></td>
        <td><code>Any</code></td>
        <td><p>The agent's ID to get the last done flag for.</p></td>
        <td><code>&#39;agent0&#39;</code></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>bool</code></td>
      <td><p>Last done flag for the specified AgentID.</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>ray/rllib/evaluation/episode.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nd">@DeveloperAPI</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="k">def</span> <span class="nf">last_done_for</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent_id</span><span class="p">:</span> <span class="n">AgentID</span> <span class="o">=</span> <span class="n">_DUMMY_AGENT_ID</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>    <span class="sd">&quot;&quot;&quot;Returns the last done flag for the specified AgentID.</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="sd">        agent_id: The agent&#39;s ID to get the last done flag for.</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="sd">        Last done flag for the specified AgentID.</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a>    <span class="k">if</span> <span class="n">agent_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_agent_to_last_done</span><span class="p">:</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_agent_to_last_done</span><span class="p">[</span><span class="n">agent_id</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a>    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_agent_to_last_done</span><span class="p">[</span><span class="n">agent_id</span><span class="p">]</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="ray.rllib.evaluation.episode.Episode.last_extra_action_outs_for">
<code class="highlight language-python"><span class="n">last_extra_action_outs_for</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent_id</span><span class="o">=</span><span class="s1">&#39;agent0&#39;</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Returns the last extra-action outputs for the specified agent.</p>
<p>This data is returned by a call to
<code>Policy.compute_actions_from_input_dict</code> as the 3rd return value
(1st return value = action; 2nd return value = RNN state outs).</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>agent_id</code></td>
        <td><code>Any</code></td>
        <td><p>The agent's ID to get the last extra-action outs for.</p></td>
        <td><code>&#39;agent0&#39;</code></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>dict</code></td>
      <td><p>The last extra-action outs for the specified AgentID.</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>ray/rllib/evaluation/episode.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nd">@DeveloperAPI</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="k">def</span> <span class="nf">last_extra_action_outs_for</span><span class="p">(</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>        <span class="n">agent_id</span><span class="p">:</span> <span class="n">AgentID</span> <span class="o">=</span> <span class="n">_DUMMY_AGENT_ID</span><span class="p">,</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a>    <span class="sd">&quot;&quot;&quot;Returns the last extra-action outputs for the specified agent.</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="sd">    This data is returned by a call to</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="sd">    `Policy.compute_actions_from_input_dict` as the 3rd return value</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="sd">    (1st return value = action; 2nd return value = RNN state outs).</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="sd">        agent_id: The agent&#39;s ID to get the last extra-action outs for.</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="sd">        The last extra-action outs for the specified AgentID.</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a>    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_agent_to_last_extra_action_outs</span><span class="p">[</span><span class="n">agent_id</span><span class="p">]</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="ray.rllib.evaluation.episode.Episode.last_info_for">
<code class="highlight language-python"><span class="n">last_info_for</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent_id</span><span class="o">=</span><span class="s1">&#39;agent0&#39;</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Returns the last info for the specified AgentID.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>agent_id</code></td>
        <td><code>Any</code></td>
        <td><p>The agent's ID to get the last info for.</p></td>
        <td><code>&#39;agent0&#39;</code></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>Optional[dict]</code></td>
      <td><p>Last info dict the specified AgentID has seen.
None in case the agent has never made any observations in the
episode.</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>ray/rllib/evaluation/episode.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nd">@DeveloperAPI</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="k">def</span> <span class="nf">last_info_for</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent_id</span><span class="p">:</span> <span class="n">AgentID</span> <span class="o">=</span> <span class="n">_DUMMY_AGENT_ID</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>                  <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">EnvInfoDict</span><span class="p">]:</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>    <span class="sd">&quot;&quot;&quot;Returns the last info for the specified AgentID.</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="sd">        agent_id: The agent&#39;s ID to get the last info for.</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="sd">        Last info dict the specified AgentID has seen.</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="sd">        None in case the agent has never made any observations in the</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="sd">        episode.</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a>    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_agent_to_last_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">agent_id</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="ray.rllib.evaluation.episode.Episode.last_observation_for">
<code class="highlight language-python"><span class="n">last_observation_for</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent_id</span><span class="o">=</span><span class="s1">&#39;agent0&#39;</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Returns the last observation for the specified AgentID.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>agent_id</code></td>
        <td><code>Any</code></td>
        <td><p>The agent's ID to get the last observation for.</p></td>
        <td><code>&#39;agent0&#39;</code></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>Optional[Any]</code></td>
      <td><p>Last observation the specified AgentID has seen. None in case
the agent has never made any observations in the episode.</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>ray/rllib/evaluation/episode.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nd">@DeveloperAPI</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="k">def</span> <span class="nf">last_observation_for</span><span class="p">(</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">agent_id</span><span class="p">:</span> <span class="n">AgentID</span> <span class="o">=</span> <span class="n">_DUMMY_AGENT_ID</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">EnvObsType</span><span class="p">]:</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>    <span class="sd">&quot;&quot;&quot;Returns the last observation for the specified AgentID.</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="sd">        agent_id: The agent&#39;s ID to get the last observation for.</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="sd">        Last observation the specified AgentID has seen. None in case</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="sd">        the agent has never made any observations in the episode.</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a>    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_agent_to_last_obs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">agent_id</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>




  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="ray.rllib.evaluation.episode.Episode.last_raw_obs_for">
<code class="highlight language-python"><span class="n">last_raw_obs_for</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent_id</span><span class="o">=</span><span class="s1">&#39;agent0&#39;</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Returns the last un-preprocessed obs for the specified AgentID.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>agent_id</code></td>
        <td><code>Any</code></td>
        <td><p>The agent's ID to get the last un-preprocessed
observation for.</p></td>
        <td><code>&#39;agent0&#39;</code></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>Optional[Any]</code></td>
      <td><p>Last un-preprocessed observation the specified AgentID has seen.
None in case the agent has never made any observations in the
episode.</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>ray/rllib/evaluation/episode.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nd">@DeveloperAPI</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="k">def</span> <span class="nf">last_raw_obs_for</span><span class="p">(</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">agent_id</span><span class="p">:</span> <span class="n">AgentID</span> <span class="o">=</span> <span class="n">_DUMMY_AGENT_ID</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">EnvObsType</span><span class="p">]:</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>    <span class="sd">&quot;&quot;&quot;Returns the last un-preprocessed obs for the specified AgentID.</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="sd">        agent_id: The agent&#39;s ID to get the last un-preprocessed</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="sd">            observation for.</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="sd">        Last un-preprocessed observation the specified AgentID has seen.</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="sd">        None in case the agent has never made any observations in the</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="sd">        episode.</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a>    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_agent_to_last_raw_obs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">agent_id</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="ray.rllib.evaluation.episode.Episode.last_reward_for">
<code class="highlight language-python"><span class="n">last_reward_for</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent_id</span><span class="o">=</span><span class="s1">&#39;agent0&#39;</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Returns the last reward for the specified agent, or zero.</p>
<p>The "last" reward is the one received most recently by the agent.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>agent_id</code></td>
        <td><code>Any</code></td>
        <td><p>The agent's ID to get the last reward for.</p></td>
        <td><code>&#39;agent0&#39;</code></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>float</code></td>
      <td><p>Last reward for the the specified AgentID.
Zero in case the agent has never performed any actions
(and thus received rewards) in the episode.</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>ray/rllib/evaluation/episode.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nd">@DeveloperAPI</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="k">def</span> <span class="nf">last_reward_for</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent_id</span><span class="p">:</span> <span class="n">AgentID</span> <span class="o">=</span> <span class="n">_DUMMY_AGENT_ID</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>    <span class="sd">&quot;&quot;&quot;Returns the last reward for the specified agent, or zero.</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="sd">    The &quot;last&quot; reward is the one received most recently by the agent.</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="sd">        agent_id: The agent&#39;s ID to get the last reward for.</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="sd">        Last reward for the the specified AgentID.</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="sd">        Zero in case the agent has never performed any actions</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="sd">        (and thus received rewards) in the episode.</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a>    <span class="n">history</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_agent_reward_history</span><span class="p">[</span><span class="n">agent_id</span><span class="p">]</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a>    <span class="c1"># We are at t &gt; 0 -&gt; Return previously received reward.</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">history</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a>        <span class="k">return</span> <span class="n">history</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a>    <span class="c1"># We&#39;re at t=0, so there is no previous reward, just return zero.</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a>        <span class="k">return</span> <span class="mf">0.0</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="ray.rllib.evaluation.episode.Episode.policy_for">
<code class="highlight language-python"><span class="n">policy_for</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent_id</span><span class="o">=</span><span class="s1">&#39;agent0&#39;</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Returns and stores the policy ID for the specified agent.</p>
<p>If the agent is new, the policy mapping fn will be called to bind the
agent to a policy for the duration of the entire episode (even if the
policy_mapping_fn is changed in the meantime!).</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>agent_id</code></td>
        <td><code>Any</code></td>
        <td><p>The agent ID to lookup the policy ID for.</p></td>
        <td><code>&#39;agent0&#39;</code></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>str</code></td>
      <td><p>The policy ID for the specified agent.</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>ray/rllib/evaluation/episode.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nd">@DeveloperAPI</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="k">def</span> <span class="nf">policy_for</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent_id</span><span class="p">:</span> <span class="n">AgentID</span> <span class="o">=</span> <span class="n">_DUMMY_AGENT_ID</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PolicyID</span><span class="p">:</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>    <span class="sd">&quot;&quot;&quot;Returns and stores the policy ID for the specified agent.</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="sd">    If the agent is new, the policy mapping fn will be called to bind the</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="sd">    agent to a policy for the duration of the entire episode (even if the</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="sd">    policy_mapping_fn is changed in the meantime!).</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="sd">        agent_id: The agent ID to lookup the policy ID for.</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="sd">        The policy ID for the specified agent.</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a>    <span class="c1"># Perform a new policy_mapping_fn lookup and bind AgentID for the</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a>    <span class="c1"># duration of this episode to the returned PolicyID.</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a>    <span class="k">if</span> <span class="n">agent_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_agent_to_policy</span><span class="p">:</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a>        <span class="c1"># Try new API: pass in agent_id and episode as named args.</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a>        <span class="c1"># New signature should be: (agent_id, episode, worker, **kwargs)</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a>            <span class="n">policy_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_agent_to_policy</span><span class="p">[</span><span class="n">agent_id</span><span class="p">]</span> <span class="o">=</span> \
<a id="__codelineno-0-23" name="__codelineno-0-23"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">policy_mapping_fn</span><span class="p">(</span><span class="n">agent_id</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">worker</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">worker</span><span class="p">)</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a>        <span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a>            <span class="k">if</span> <span class="s2">&quot;positional argument&quot;</span> <span class="ow">in</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> \
<a id="__codelineno-0-26" name="__codelineno-0-26"></a>                    <span class="s2">&quot;unexpected keyword argument&quot;</span> <span class="ow">in</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a>                <span class="k">if</span> <span class="n">log_once</span><span class="p">(</span><span class="s2">&quot;policy_mapping_new_signature&quot;</span><span class="p">):</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a>                    <span class="n">deprecation_warning</span><span class="p">(</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a>                        <span class="n">old</span><span class="o">=</span><span class="s2">&quot;policy_mapping_fn(agent_id)&quot;</span><span class="p">,</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a>                        <span class="n">new</span><span class="o">=</span><span class="s2">&quot;policy_mapping_fn(agent_id, episode, &quot;</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a>                        <span class="s2">&quot;worker, **kwargs)&quot;</span><span class="p">)</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a>                <span class="n">policy_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_agent_to_policy</span><span class="p">[</span><span class="n">agent_id</span><span class="p">]</span> <span class="o">=</span> \
<a id="__codelineno-0-33" name="__codelineno-0-33"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">policy_mapping_fn</span><span class="p">(</span><span class="n">agent_id</span><span class="p">)</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a>                <span class="k">raise</span> <span class="n">e</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a>    <span class="c1"># Use already determined PolicyID.</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a>        <span class="n">policy_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_agent_to_policy</span><span class="p">[</span><span class="n">agent_id</span><span class="p">]</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a>    <span class="c1"># PolicyID not found in policy map -&gt; Error.</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>    <span class="k">if</span> <span class="n">policy_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">policy_map</span><span class="p">:</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;policy_mapping_fn returned invalid policy id &quot;</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>                       <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">policy_id</span><span class="si">}</span><span class="s2">&#39;!&quot;</span><span class="p">)</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>    <span class="k">return</span> <span class="n">policy_id</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="ray.rllib.evaluation.episode.Episode.prev_action_for">
<code class="highlight language-python"><span class="n">prev_action_for</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent_id</span><span class="o">=</span><span class="s1">&#39;agent0&#39;</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Returns the previous action for the specified agent, or zeros.</p>
<p>The "previous" action is the one taken one timestep before the
most recent action taken by the agent.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>agent_id</code></td>
        <td><code>Any</code></td>
        <td><p>The agent's ID to get the previous action for.</p></td>
        <td><code>&#39;agent0&#39;</code></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>Any</code></td>
      <td><p>Previous action the specified AgentID has executed.
Zero in case the agent has never performed any actions (or only
one) in the episode.</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>ray/rllib/evaluation/episode.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nd">@DeveloperAPI</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="k">def</span> <span class="nf">prev_action_for</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>                    <span class="n">agent_id</span><span class="p">:</span> <span class="n">AgentID</span> <span class="o">=</span> <span class="n">_DUMMY_AGENT_ID</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EnvActionType</span><span class="p">:</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>    <span class="sd">&quot;&quot;&quot;Returns the previous action for the specified agent, or zeros.</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="sd">    The &quot;previous&quot; action is the one taken one timestep before the</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="sd">    most recent action taken by the agent.</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="sd">        agent_id: The agent&#39;s ID to get the previous action for.</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="sd">        Previous action the specified AgentID has executed.</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="sd">        Zero in case the agent has never performed any actions (or only</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="sd">        one) in the episode.</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a>    <span class="c1"># We are at t &gt; 1 -&gt; There has been a previous action by this agent.</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a>    <span class="k">if</span> <span class="n">agent_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_agent_to_prev_action</span><span class="p">:</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a>        <span class="k">return</span> <span class="n">flatten_to_single_ndarray</span><span class="p">(</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_agent_to_prev_action</span><span class="p">[</span><span class="n">agent_id</span><span class="p">])</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a>    <span class="c1"># We&#39;re at t &lt;= 1, so return all zeros.</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a>        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last_action_for</span><span class="p">(</span><span class="n">agent_id</span><span class="p">))</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="ray.rllib.evaluation.episode.Episode.prev_reward_for">
<code class="highlight language-python"><span class="n">prev_reward_for</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent_id</span><span class="o">=</span><span class="s1">&#39;agent0&#39;</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Returns the previous reward for the specified agent, or zero.</p>
<p>The "previous" reward is the one received one timestep before the
most recently received reward of the agent.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>agent_id</code></td>
        <td><code>Any</code></td>
        <td><p>The agent's ID to get the previous reward for.</p></td>
        <td><code>&#39;agent0&#39;</code></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>float</code></td>
      <td><p>Previous reward for the the specified AgentID.
Zero in case the agent has never performed any actions (or only
one) in the episode.</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>ray/rllib/evaluation/episode.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nd">@DeveloperAPI</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="k">def</span> <span class="nf">prev_reward_for</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent_id</span><span class="p">:</span> <span class="n">AgentID</span> <span class="o">=</span> <span class="n">_DUMMY_AGENT_ID</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>    <span class="sd">&quot;&quot;&quot;Returns the previous reward for the specified agent, or zero.</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="sd">    The &quot;previous&quot; reward is the one received one timestep before the</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="sd">    most recently received reward of the agent.</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="sd">        agent_id: The agent&#39;s ID to get the previous reward for.</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="sd">        Previous reward for the the specified AgentID.</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="sd">        Zero in case the agent has never performed any actions (or only</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="sd">        one) in the episode.</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a>    <span class="n">history</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_agent_reward_history</span><span class="p">[</span><span class="n">agent_id</span><span class="p">]</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a>    <span class="c1"># We are at t &gt; 1 -&gt; Return reward prior to most recent (last) one.</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">history</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a>        <span class="k">return</span> <span class="n">history</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a>    <span class="c1"># We&#39;re at t &lt;= 1, so there is no previous reward, just return zero.</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a>        <span class="k">return</span> <span class="mf">0.0</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="ray.rllib.evaluation.episode.Episode.rnn_state_for">
<code class="highlight language-python"><span class="n">rnn_state_for</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent_id</span><span class="o">=</span><span class="s1">&#39;agent0&#39;</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Returns the last RNN state for the specified agent.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>agent_id</code></td>
        <td><code>Any</code></td>
        <td><p>The agent's ID to get the most recent RNN state for.</p></td>
        <td><code>&#39;agent0&#39;</code></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>List[Any]</code></td>
      <td><p>Most recent RNN state of the the specified AgentID.</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>ray/rllib/evaluation/episode.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nd">@DeveloperAPI</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="k">def</span> <span class="nf">rnn_state_for</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent_id</span><span class="p">:</span> <span class="n">AgentID</span> <span class="o">=</span> <span class="n">_DUMMY_AGENT_ID</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>    <span class="sd">&quot;&quot;&quot;Returns the last RNN state for the specified agent.</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="sd">        agent_id: The agent&#39;s ID to get the most recent RNN state for.</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="sd">        Most recent RNN state of the the specified AgentID.</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a>    <span class="k">if</span> <span class="n">agent_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_agent_to_rnn_state</span><span class="p">:</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a>        <span class="n">policy_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">policy_for</span><span class="p">(</span><span class="n">agent_id</span><span class="p">)</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a>        <span class="n">policy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">policy_map</span><span class="p">[</span><span class="n">policy_id</span><span class="p">]</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_agent_to_rnn_state</span><span class="p">[</span><span class="n">agent_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">policy</span><span class="o">.</span><span class="n">get_initial_state</span><span class="p">()</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a>    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_agent_to_rnn_state</span><span class="p">[</span><span class="n">agent_id</span><span class="p">]</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="ray.rllib.evaluation.episode.Episode.soft_reset">
<code class="highlight language-python"><span class="n">soft_reset</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Clears rewards and metrics, but retains RNN and other state.</p>
<p>This is used to carry state across multiple logical episodes in the
same env (i.e., if <code>soft_horizon</code> is set).</p>

        <details class="quote">
          <summary>Source code in <code>ray/rllib/evaluation/episode.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nd">@DeveloperAPI</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="k">def</span> <span class="nf">soft_reset</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>    <span class="sd">&quot;&quot;&quot;Clears rewards and metrics, but retains RNN and other state.</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="sd">    This is used to carry state across multiple logical episodes in the</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="sd">    same env (i.e., if `soft_horizon` is set).</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">episode_id</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="mf">2e9</span><span class="p">)</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">total_reward</span> <span class="o">=</span> <span class="mf">0.0</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">agent_rewards</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_agent_reward_history</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h2 class="doc doc-heading" id="ray.rllib.evaluation.episode.MultiAgentEpisode">
        <code>
ray.rllib.evaluation.episode.MultiAgentEpisode            (<a title="ray.rllib.evaluation.episode.Episode" href="#ray.rllib.evaluation.episode.Episode">Episode</a>)
        </code>



</h2>

    <div class="doc doc-contents first">





  <div class="doc doc-children">












  </div>

    </div>

  </div>

<h2 id="rollouts">Rollouts</h2>


  <div class="doc doc-object doc-class">



<h2 class="doc doc-heading" id="ray.rllib.evaluation.rollout_worker.RolloutWorker">
        <code>
ray.rllib.evaluation.rollout_worker.RolloutWorker            (<span title="ray.util.iter.ParallelIteratorWorker">ParallelIteratorWorker</span>)
        </code>



</h2>

    <div class="doc doc-contents first">

      <p>Common experience collection class.</p>
<p>This class wraps a policy instance and an environment class to
collect experiences from the environment. You can create many replicas of
this class as Ray actors to scale RL training.</p>
<p>This class supports vectorized and multi-agent policy evaluation (e.g.,
VectorEnv, MultiAgentEnv, etc.)</p>

<p><strong>Examples:</strong></p>
    <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="o">&gt;&gt;&gt;</span> <span class="c1"># Create a rollout worker and using it to collect experiences.</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="o">&gt;&gt;&gt;</span> <span class="n">worker</span> <span class="o">=</span> <span class="n">RolloutWorker</span><span class="p">(</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="o">...</span>   <span class="n">env_creator</span><span class="o">=</span><span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="n">gym</span><span class="o">.</span><span class="n">make</span><span class="p">(</span><span class="s2">&quot;CartPole-v0&quot;</span><span class="p">),</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="o">...</span>   <span class="n">policy_spec</span><span class="o">=</span><span class="n">PGTFPolicy</span><span class="p">)</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="o">&gt;&gt;&gt;</span> <span class="nb">print</span><span class="p">(</span><span class="n">worker</span><span class="o">.</span><span class="n">sample</span><span class="p">())</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="n">SampleBatch</span><span class="p">({</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a>    <span class="s2">&quot;obs&quot;</span><span class="p">:</span> <span class="p">[[</span><span class="o">...</span><span class="p">]],</span> <span class="s2">&quot;actions&quot;</span><span class="p">:</span> <span class="p">[[</span><span class="o">...</span><span class="p">]],</span> <span class="s2">&quot;rewards&quot;</span><span class="p">:</span> <span class="p">[[</span><span class="o">...</span><span class="p">]],</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a>    <span class="s2">&quot;dones&quot;</span><span class="p">:</span> <span class="p">[[</span><span class="o">...</span><span class="p">]],</span> <span class="s2">&quot;new_obs&quot;</span><span class="p">:</span> <span class="p">[[</span><span class="o">...</span><span class="p">]]})</span>
</code></pre></div>
    <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="o">&gt;&gt;&gt;</span> <span class="c1"># Creating a multi-agent rollout worker</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="o">&gt;&gt;&gt;</span> <span class="n">worker</span> <span class="o">=</span> <span class="n">RolloutWorker</span><span class="p">(</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="o">...</span>   <span class="n">env_creator</span><span class="o">=</span><span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="n">MultiAgentTrafficGrid</span><span class="p">(</span><span class="n">num_cars</span><span class="o">=</span><span class="mi">25</span><span class="p">),</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="o">...</span>   <span class="n">policy_spec</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="o">...</span>       <span class="c1"># Use an ensemble of two policies for car agents</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="o">...</span>       <span class="s2">&quot;car_policy1&quot;</span><span class="p">:</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="o">...</span>         <span class="p">(</span><span class="n">PGTFPolicy</span><span class="p">,</span> <span class="n">Box</span><span class="p">(</span><span class="o">...</span><span class="p">),</span> <span class="n">Discrete</span><span class="p">(</span><span class="o">...</span><span class="p">),</span> <span class="p">{</span><span class="s2">&quot;gamma&quot;</span><span class="p">:</span> <span class="mf">0.99</span><span class="p">}),</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="o">...</span>       <span class="s2">&quot;car_policy2&quot;</span><span class="p">:</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="o">...</span>         <span class="p">(</span><span class="n">PGTFPolicy</span><span class="p">,</span> <span class="n">Box</span><span class="p">(</span><span class="o">...</span><span class="p">),</span> <span class="n">Discrete</span><span class="p">(</span><span class="o">...</span><span class="p">),</span> <span class="p">{</span><span class="s2">&quot;gamma&quot;</span><span class="p">:</span> <span class="mf">0.95</span><span class="p">}),</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="o">...</span>       <span class="c1"># Use a single shared policy for all traffic lights</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="o">...</span>       <span class="s2">&quot;traffic_light_policy&quot;</span><span class="p">:</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="o">...</span>         <span class="p">(</span><span class="n">PGTFPolicy</span><span class="p">,</span> <span class="n">Box</span><span class="p">(</span><span class="o">...</span><span class="p">),</span> <span class="n">Discrete</span><span class="p">(</span><span class="o">...</span><span class="p">),</span> <span class="p">{}),</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="o">...</span>   <span class="p">},</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="o">...</span>   <span class="n">policy_mapping_fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">agent_id</span><span class="p">,</span> <span class="n">episode</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="o">...</span>     <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="s2">&quot;car_policy1&quot;</span><span class="p">,</span> <span class="s2">&quot;car_policy2&quot;</span><span class="p">])</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="o">...</span>     <span class="k">if</span> <span class="n">agent_id</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;car_&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;traffic_light_policy&quot;</span><span class="p">)</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="o">&gt;&gt;&gt;</span> <span class="nb">print</span><span class="p">(</span><span class="n">worker</span><span class="o">.</span><span class="n">sample</span><span class="p">())</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="n">MultiAgentBatch</span><span class="p">({</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a>    <span class="s2">&quot;car_policy1&quot;</span><span class="p">:</span> <span class="n">SampleBatch</span><span class="p">(</span><span class="o">...</span><span class="p">),</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a>    <span class="s2">&quot;car_policy2&quot;</span><span class="p">:</span> <span class="n">SampleBatch</span><span class="p">(</span><span class="o">...</span><span class="p">),</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a>    <span class="s2">&quot;traffic_light_policy&quot;</span><span class="p">:</span> <span class="n">SampleBatch</span><span class="p">(</span><span class="o">...</span><span class="p">)})</span>
</code></pre></div>




  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="ray.rllib.evaluation.rollout_worker.RolloutWorker.__init__">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">env_creator</span><span class="p">,</span> <span class="n">validate_env</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">policy_spec</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">policy_mapping_fn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">policies_to_train</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tf_session_creator</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rollout_fragment_length</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">count_steps_by</span><span class="o">=</span><span class="s1">&#39;env_steps&#39;</span><span class="p">,</span> <span class="n">batch_mode</span><span class="o">=</span><span class="s1">&#39;truncate_episodes&#39;</span><span class="p">,</span> <span class="n">episode_horizon</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">preprocessor_pref</span><span class="o">=</span><span class="s1">&#39;deepmind&#39;</span><span class="p">,</span> <span class="n">sample_async</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">compress_observations</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">num_envs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">observation_fn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">observation_filter</span><span class="o">=</span><span class="s1">&#39;NoFilter&#39;</span><span class="p">,</span> <span class="n">clip_rewards</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">normalize_actions</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">clip_actions</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">env_config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">model_config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">policy_config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">worker_index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">record_env</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">log_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">log_level</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">callbacks</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">input_creator</span><span class="o">=&lt;</span><span class="n">function</span> <span class="n">RolloutWorker</span><span class="o">.&lt;</span><span class="k">lambda</span><span class="o">&gt;</span> <span class="n">at</span> <span class="mh">0x11d91bd40</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">input_evaluation</span><span class="o">=</span><span class="nb">frozenset</span><span class="p">(),</span> <span class="n">output_creator</span><span class="o">=&lt;</span><span class="n">function</span> <span class="n">RolloutWorker</span><span class="o">.&lt;</span><span class="k">lambda</span><span class="o">&gt;</span> <span class="n">at</span> <span class="mh">0x11d91bdd0</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">remote_worker_envs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">remote_env_batch_wait_ms</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">soft_horizon</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">no_done_at_end</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">extra_python_environs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fake_sampler</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">spaces</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">policy</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">monitor_path</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

</h3>

    <div class="doc doc-contents ">

      <p>Initializes a RolloutWorker instance.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>env_creator</code></td>
        <td><code>Callable[[ray.rllib.env.env_context.EnvContext], Any]</code></td>
        <td><p>Function that returns a gym.Env given an EnvContext
wrapped configuration.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>validate_env</code></td>
        <td><code>Optional[Callable[[Any, ray.rllib.env.env_context.EnvContext], NoneType]]</code></td>
        <td><p>Optional callable to validate the generated
environment (only on worker=0).</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>policy_spec</code></td>
        <td><code>Union[type, Dict[str, ray.rllib.policy.policy.PolicySpec]]</code></td>
        <td><p>The MultiAgentPolicyConfigDict mapping policy IDs
(str) to PolicySpec's or a single policy class to use.
If a dict is specified, then we are in multi-agent mode and a
policy_mapping_fn can also be set (if not, will map all agents
to DEFAULT_POLICY_ID).</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>policy_mapping_fn</code></td>
        <td><code>Optional[Callable[[Any, Episode], str]]</code></td>
        <td><p>A callable that maps agent ids to policy ids in
multi-agent mode. This function will be called each time a new
agent appears in an episode, to bind that agent to a policy
for the duration of the episode. If not provided, will map all
agents to DEFAULT_POLICY_ID.</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>policies_to_train</code></td>
        <td><code>Optional[List[str]]</code></td>
        <td><p>Optional list of policies to train, or None
for all policies.</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>tf_session_creator</code></td>
        <td><code>Optional[Callable[[], tf1.Session]]</code></td>
        <td><p>A function that returns a TF session.
This is optional and only useful with TFPolicy.</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>rollout_fragment_length</code></td>
        <td><code>int</code></td>
        <td><p>The target number of steps
(maesured in <code>count_steps_by</code>) to include in each sample
batch returned from this worker.</p></td>
        <td><code>100</code></td>
      </tr>
      <tr>
        <td><code>count_steps_by</code></td>
        <td><code>str</code></td>
        <td><p>The unit in which to count fragment
lengths. One of env_steps or agent_steps.</p></td>
        <td><code>&#39;env_steps&#39;</code></td>
      </tr>
      <tr>
        <td><code>batch_mode</code></td>
        <td><code>str</code></td>
        <td><p>One of the following batch modes:
- "truncate_episodes": Each call to sample() will return a
batch of at most <code>rollout_fragment_length * num_envs</code> in size.
The batch will be exactly <code>rollout_fragment_length * num_envs</code>
in size if postprocessing does not change batch sizes. Episodes
may be truncated in order to meet this size requirement.
- "complete_episodes": Each call to sample() will return a
batch of at least <code>rollout_fragment_length * num_envs</code> in
size. Episodes will not be truncated, but multiple episodes
may be packed within one batch to meet the batch size. Note
that when <code>num_envs &gt; 1</code>, episode steps will be buffered
until the episode completes, and hence batches may contain
significant amounts of off-policy data.</p></td>
        <td><code>&#39;truncate_episodes&#39;</code></td>
      </tr>
      <tr>
        <td><code>episode_horizon</code></td>
        <td><code>Optional[int]</code></td>
        <td><p>Horizon at which to stop episodes (even if the
environment itself has not retured a "done" signal).</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>preprocessor_pref</code></td>
        <td><code>str</code></td>
        <td><p>Whether to use RLlib preprocessors
("rllib") or deepmind ("deepmind"), when applicable.</p></td>
        <td><code>&#39;deepmind&#39;</code></td>
      </tr>
      <tr>
        <td><code>sample_async</code></td>
        <td><code>bool</code></td>
        <td><p>Whether to compute samples asynchronously in
the background, which improves throughput but can cause samples
to be slightly off-policy.</p></td>
        <td><code>False</code></td>
      </tr>
      <tr>
        <td><code>compress_observations</code></td>
        <td><code>bool</code></td>
        <td><p>If true, compress the observations.
They can be decompressed with rllib/utils/compression.</p></td>
        <td><code>False</code></td>
      </tr>
      <tr>
        <td><code>num_envs</code></td>
        <td><code>int</code></td>
        <td><p>If more than one, will create multiple envs
and vectorize the computation of actions. This has no effect if
if the env already implements VectorEnv.</p></td>
        <td><code>1</code></td>
      </tr>
      <tr>
        <td><code>observation_fn</code></td>
        <td><code>Optional[ObservationFunction]</code></td>
        <td><p>Optional multi-agent observation function.</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>observation_filter</code></td>
        <td><code>str</code></td>
        <td><p>Name of observation filter to use.</p></td>
        <td><code>&#39;NoFilter&#39;</code></td>
      </tr>
      <tr>
        <td><code>clip_rewards</code></td>
        <td><code>Union[bool, float]</code></td>
        <td><p>True for clipping rewards to [-1.0, 1.0] prior
to experience postprocessing. None: Clip for Atari only.
float: Clip to [-clip_rewards; +clip_rewards].</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>normalize_actions</code></td>
        <td><code>bool</code></td>
        <td><p>Whether to normalize actions to the
action space's bounds.</p></td>
        <td><code>True</code></td>
      </tr>
      <tr>
        <td><code>clip_actions</code></td>
        <td><code>bool</code></td>
        <td><p>Whether to clip action values to the range
specified by the policy action space.</p></td>
        <td><code>False</code></td>
      </tr>
      <tr>
        <td><code>env_config</code></td>
        <td><code>Optional[dict]</code></td>
        <td><p>Config to pass to the env creator.</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>model_config</code></td>
        <td><code>Optional[dict]</code></td>
        <td><p>Config to use when creating the policy model.</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>policy_config</code></td>
        <td><code>Optional[dict]</code></td>
        <td><p>Config to pass to the
policy. In the multi-agent case, this config will be merged
with the per-policy configs specified by <code>policy_spec</code>.</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>worker_index</code></td>
        <td><code>int</code></td>
        <td><p>For remote workers, this should be set to a
non-zero and unique value. This index is passed to created envs
through EnvContext so that envs can be configured per worker.</p></td>
        <td><code>0</code></td>
      </tr>
      <tr>
        <td><code>num_workers</code></td>
        <td><code>int</code></td>
        <td><p>For remote workers, how many workers altogether
have been created?</p></td>
        <td><code>0</code></td>
      </tr>
      <tr>
        <td><code>record_env</code></td>
        <td><code>Union[bool, str]</code></td>
        <td><p>Write out episode stats and videos
using gym.wrappers.Monitor to this directory if specified. If
True, use the default output dir in ~/ray_results/.... If
False, do not record anything.</p></td>
        <td><code>False</code></td>
      </tr>
      <tr>
        <td><code>log_dir</code></td>
        <td><code>Optional[str]</code></td>
        <td><p>Directory where logs can be placed.</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>log_level</code></td>
        <td><code>Optional[str]</code></td>
        <td><p>Set the root log level on creation.</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>callbacks</code></td>
        <td><code>Type[DefaultCallbacks]</code></td>
        <td><p>Custom sub-class of
DefaultCallbacks for training/policy/rollout-worker callbacks.</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>input_creator</code></td>
        <td><code>Callable[[ray.rllib.offline.io_context.IOContext], ray.rllib.offline.input_reader.InputReader]</code></td>
        <td><p>Function that returns an InputReader object for
loading previous generated experiences.</p></td>
        <td><code>&lt;function RolloutWorker.&lt;lambda&gt; at 0x11d91bd40&gt;</code></td>
      </tr>
      <tr>
        <td><code>input_evaluation</code></td>
        <td><code>List[str]</code></td>
        <td><p>How to evaluate the policy
performance. This only makes sense to set when the input is
reading offline data. The possible values include:
- "is": the step-wise importance sampling estimator.
- "wis": the weighted step-wise is estimator.
- "simulation": run the environment in the background, but
use this data for evaluation only and never for learning.</p></td>
        <td><code>frozenset()</code></td>
      </tr>
      <tr>
        <td><code>output_creator</code></td>
        <td><code>Callable[[ray.rllib.offline.io_context.IOContext], ray.rllib.offline.output_writer.OutputWriter]</code></td>
        <td><p>Function that returns an OutputWriter object for
saving generated experiences.</p></td>
        <td><code>&lt;function RolloutWorker.&lt;lambda&gt; at 0x11d91bdd0&gt;</code></td>
      </tr>
      <tr>
        <td><code>remote_worker_envs</code></td>
        <td><code>bool</code></td>
        <td><p>If using num_envs_per_worker &gt; 1,
whether to create those new envs in remote processes instead of
in the current process. This adds overheads, but can make sense
if your envs are expensive to step/reset (e.g., for StarCraft).
Use this cautiously, overheads are significant!</p></td>
        <td><code>False</code></td>
      </tr>
      <tr>
        <td><code>remote_env_batch_wait_ms</code></td>
        <td><code>int</code></td>
        <td><p>Timeout that remote workers
are waiting when polling environments. 0 (continue when at
least one env is ready) is a reasonable default, but optimal
value could be obtained by measuring your environment
step / reset and model inference perf.</p></td>
        <td><code>0</code></td>
      </tr>
      <tr>
        <td><code>soft_horizon</code></td>
        <td><code>bool</code></td>
        <td><p>Calculate rewards but don't reset the
environment when the horizon is hit.</p></td>
        <td><code>False</code></td>
      </tr>
      <tr>
        <td><code>no_done_at_end</code></td>
        <td><code>bool</code></td>
        <td><p>Ignore the done=True at the end of the
episode and instead record done=False.</p></td>
        <td><code>False</code></td>
      </tr>
      <tr>
        <td><code>seed</code></td>
        <td><code>int</code></td>
        <td><p>Set the seed of both np and tf to this value to
to ensure each remote worker has unique exploration behavior.</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>extra_python_environs</code></td>
        <td><code>Optional[dict]</code></td>
        <td><p>Extra python environments need to be set.</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>fake_sampler</code></td>
        <td><code>bool</code></td>
        <td><p>Use a fake (inf speed) sampler for testing.</p></td>
        <td><code>False</code></td>
      </tr>
      <tr>
        <td><code>spaces</code></td>
        <td><code>Optional[Dict[str, Tuple[gym.spaces.space.Space, gym.spaces.space.Space]]]</code></td>
        <td><p>An optional space dict mapping policy IDs
to (obs_space, action_space)-tuples. This is used in case no
Env is created on this RolloutWorker.</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>policy</code></td>
        <td></td>
        <td><p>Obsoleted arg. Use <code>policy_spec</code> instead.</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>monitor_path</code></td>
        <td></td>
        <td><p>Obsoleted arg. Use <code>record_env</code> instead.</p></td>
        <td><code>None</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>ray/rllib/evaluation/rollout_worker.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nd">@DeveloperAPI</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>        <span class="o">*</span><span class="p">,</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a>        <span class="n">env_creator</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">EnvContext</span><span class="p">],</span> <span class="n">EnvType</span><span class="p">],</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a>        <span class="n">validate_env</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">EnvType</span><span class="p">,</span> <span class="n">EnvContext</span><span class="p">],</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a>                                        <span class="kc">None</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a>        <span class="n">policy_spec</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">type</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="n">PolicyID</span><span class="p">,</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a>                                               <span class="n">PolicySpec</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a>        <span class="n">policy_mapping_fn</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">AgentID</span><span class="p">,</span> <span class="s2">&quot;Episode&quot;</span><span class="p">],</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a>                                             <span class="n">PolicyID</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a>        <span class="n">policies_to_train</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">PolicyID</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a>        <span class="n">tf_session_creator</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[],</span> <span class="s2">&quot;tf1.Session&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a>        <span class="n">rollout_fragment_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a>        <span class="n">count_steps_by</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;env_steps&quot;</span><span class="p">,</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a>        <span class="n">batch_mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;truncate_episodes&quot;</span><span class="p">,</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a>        <span class="n">episode_horizon</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a>        <span class="n">preprocessor_pref</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;deepmind&quot;</span><span class="p">,</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a>        <span class="n">sample_async</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a>        <span class="n">compress_observations</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a>        <span class="n">num_envs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a>        <span class="n">observation_fn</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;ObservationFunction&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a>        <span class="n">observation_filter</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;NoFilter&quot;</span><span class="p">,</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a>        <span class="n">clip_rewards</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a>        <span class="n">normalize_actions</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a>        <span class="n">clip_actions</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a>        <span class="n">env_config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">EnvConfigDict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a>        <span class="n">model_config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ModelConfigDict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a>        <span class="n">policy_config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">PartialTrainerConfigDict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a>        <span class="n">worker_index</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a>        <span class="n">num_workers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a>        <span class="n">record_env</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a>        <span class="n">log_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a>        <span class="n">log_level</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a>        <span class="n">callbacks</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="s2">&quot;DefaultCallbacks&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a>        <span class="n">input_creator</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a>            <span class="n">IOContext</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a>        <span class="p">],</span> <span class="n">InputReader</span><span class="p">]</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">ioctx</span><span class="p">:</span> <span class="n">ioctx</span><span class="o">.</span><span class="n">default_sampler_input</span><span class="p">(),</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a>        <span class="n">input_evaluation</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">([]),</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a>        <span class="n">output_creator</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>            <span class="p">[</span><span class="n">IOContext</span><span class="p">],</span> <span class="n">OutputWriter</span><span class="p">]</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">ioctx</span><span class="p">:</span> <span class="n">NoopOutput</span><span class="p">(),</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>        <span class="n">remote_worker_envs</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>        <span class="n">remote_env_batch_wait_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>        <span class="n">soft_horizon</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>        <span class="n">no_done_at_end</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>        <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>        <span class="n">extra_python_environs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>        <span class="n">fake_sampler</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>        <span class="n">spaces</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="n">PolicyID</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">gym</span><span class="o">.</span><span class="n">spaces</span><span class="o">.</span><span class="n">Space</span><span class="p">,</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>                                              <span class="n">gym</span><span class="o">.</span><span class="n">spaces</span><span class="o">.</span><span class="n">Space</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>        <span class="n">policy</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>        <span class="n">monitor_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a><span class="p">):</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>    <span class="sd">&quot;&quot;&quot;Initializes a RolloutWorker instance.</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a><span class="sd">        env_creator: Function that returns a gym.Env given an EnvContext</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a><span class="sd">            wrapped configuration.</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a><span class="sd">        validate_env: Optional callable to validate the generated</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a><span class="sd">            environment (only on worker=0).</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a><span class="sd">        policy_spec: The MultiAgentPolicyConfigDict mapping policy IDs</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a><span class="sd">            (str) to PolicySpec&#39;s or a single policy class to use.</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a><span class="sd">            If a dict is specified, then we are in multi-agent mode and a</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a><span class="sd">            policy_mapping_fn can also be set (if not, will map all agents</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a><span class="sd">            to DEFAULT_POLICY_ID).</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a><span class="sd">        policy_mapping_fn: A callable that maps agent ids to policy ids in</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a><span class="sd">            multi-agent mode. This function will be called each time a new</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a><span class="sd">            agent appears in an episode, to bind that agent to a policy</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a><span class="sd">            for the duration of the episode. If not provided, will map all</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a><span class="sd">            agents to DEFAULT_POLICY_ID.</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a><span class="sd">        policies_to_train: Optional list of policies to train, or None</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a><span class="sd">            for all policies.</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a><span class="sd">        tf_session_creator: A function that returns a TF session.</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a><span class="sd">            This is optional and only useful with TFPolicy.</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a><span class="sd">        rollout_fragment_length: The target number of steps</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a><span class="sd">            (maesured in `count_steps_by`) to include in each sample</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a><span class="sd">            batch returned from this worker.</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a><span class="sd">        count_steps_by: The unit in which to count fragment</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a><span class="sd">            lengths. One of env_steps or agent_steps.</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a><span class="sd">        batch_mode: One of the following batch modes:</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a><span class="sd">            - &quot;truncate_episodes&quot;: Each call to sample() will return a</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a><span class="sd">            batch of at most `rollout_fragment_length * num_envs` in size.</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a><span class="sd">            The batch will be exactly `rollout_fragment_length * num_envs`</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a><span class="sd">            in size if postprocessing does not change batch sizes. Episodes</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a><span class="sd">            may be truncated in order to meet this size requirement.</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a><span class="sd">            - &quot;complete_episodes&quot;: Each call to sample() will return a</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a><span class="sd">            batch of at least `rollout_fragment_length * num_envs` in</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a><span class="sd">            size. Episodes will not be truncated, but multiple episodes</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a><span class="sd">            may be packed within one batch to meet the batch size. Note</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a><span class="sd">            that when `num_envs &gt; 1`, episode steps will be buffered</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a><span class="sd">            until the episode completes, and hence batches may contain</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a><span class="sd">            significant amounts of off-policy data.</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a><span class="sd">        episode_horizon: Horizon at which to stop episodes (even if the</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a><span class="sd">            environment itself has not retured a &quot;done&quot; signal).</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a><span class="sd">        preprocessor_pref: Whether to use RLlib preprocessors</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a><span class="sd">            (&quot;rllib&quot;) or deepmind (&quot;deepmind&quot;), when applicable.</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a><span class="sd">        sample_async: Whether to compute samples asynchronously in</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a><span class="sd">            the background, which improves throughput but can cause samples</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a><span class="sd">            to be slightly off-policy.</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a><span class="sd">        compress_observations: If true, compress the observations.</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a><span class="sd">            They can be decompressed with rllib/utils/compression.</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a><span class="sd">        num_envs: If more than one, will create multiple envs</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a><span class="sd">            and vectorize the computation of actions. This has no effect if</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a><span class="sd">            if the env already implements VectorEnv.</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a><span class="sd">        observation_fn: Optional multi-agent observation function.</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a><span class="sd">        observation_filter: Name of observation filter to use.</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a><span class="sd">        clip_rewards: True for clipping rewards to [-1.0, 1.0] prior</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a><span class="sd">            to experience postprocessing. None: Clip for Atari only.</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a><span class="sd">            float: Clip to [-clip_rewards; +clip_rewards].</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a><span class="sd">        normalize_actions: Whether to normalize actions to the</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a><span class="sd">            action space&#39;s bounds.</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a><span class="sd">        clip_actions: Whether to clip action values to the range</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a><span class="sd">            specified by the policy action space.</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a><span class="sd">        env_config: Config to pass to the env creator.</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a><span class="sd">        model_config: Config to use when creating the policy model.</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a><span class="sd">        policy_config: Config to pass to the</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a><span class="sd">            policy. In the multi-agent case, this config will be merged</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a><span class="sd">            with the per-policy configs specified by `policy_spec`.</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a><span class="sd">        worker_index: For remote workers, this should be set to a</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a><span class="sd">            non-zero and unique value. This index is passed to created envs</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a><span class="sd">            through EnvContext so that envs can be configured per worker.</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a><span class="sd">        num_workers: For remote workers, how many workers altogether</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a><span class="sd">            have been created?</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a><span class="sd">        record_env: Write out episode stats and videos</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a><span class="sd">            using gym.wrappers.Monitor to this directory if specified. If</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a><span class="sd">            True, use the default output dir in ~/ray_results/.... If</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a><span class="sd">            False, do not record anything.</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a><span class="sd">        log_dir: Directory where logs can be placed.</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a><span class="sd">        log_level: Set the root log level on creation.</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a><span class="sd">        callbacks: Custom sub-class of</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a><span class="sd">            DefaultCallbacks for training/policy/rollout-worker callbacks.</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a><span class="sd">        input_creator: Function that returns an InputReader object for</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a><span class="sd">            loading previous generated experiences.</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a><span class="sd">        input_evaluation: How to evaluate the policy</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a><span class="sd">            performance. This only makes sense to set when the input is</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a><span class="sd">            reading offline data. The possible values include:</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a><span class="sd">            - &quot;is&quot;: the step-wise importance sampling estimator.</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a><span class="sd">            - &quot;wis&quot;: the weighted step-wise is estimator.</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a><span class="sd">            - &quot;simulation&quot;: run the environment in the background, but</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a><span class="sd">            use this data for evaluation only and never for learning.</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a><span class="sd">        output_creator: Function that returns an OutputWriter object for</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a><span class="sd">            saving generated experiences.</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a><span class="sd">        remote_worker_envs: If using num_envs_per_worker &gt; 1,</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a><span class="sd">            whether to create those new envs in remote processes instead of</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a><span class="sd">            in the current process. This adds overheads, but can make sense</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a><span class="sd">            if your envs are expensive to step/reset (e.g., for StarCraft).</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a><span class="sd">            Use this cautiously, overheads are significant!</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a><span class="sd">        remote_env_batch_wait_ms: Timeout that remote workers</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a><span class="sd">            are waiting when polling environments. 0 (continue when at</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a><span class="sd">            least one env is ready) is a reasonable default, but optimal</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a><span class="sd">            value could be obtained by measuring your environment</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a><span class="sd">            step / reset and model inference perf.</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a><span class="sd">        soft_horizon: Calculate rewards but don&#39;t reset the</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a><span class="sd">            environment when the horizon is hit.</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a><span class="sd">        no_done_at_end: Ignore the done=True at the end of the</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a><span class="sd">            episode and instead record done=False.</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a><span class="sd">        seed: Set the seed of both np and tf to this value to</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a><span class="sd">            to ensure each remote worker has unique exploration behavior.</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a><span class="sd">        extra_python_environs: Extra python environments need to be set.</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a><span class="sd">        fake_sampler: Use a fake (inf speed) sampler for testing.</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a><span class="sd">        spaces: An optional space dict mapping policy IDs</span>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a><span class="sd">            to (obs_space, action_space)-tuples. This is used in case no</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a><span class="sd">            Env is created on this RolloutWorker.</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a><span class="sd">        policy: Obsoleted arg. Use `policy_spec` instead.</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a><span class="sd">        monitor_path: Obsoleted arg. Use `record_env` instead.</span>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a>    <span class="c1"># Deprecated args.</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a>    <span class="k">if</span> <span class="n">policy</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a>        <span class="n">deprecation_warning</span><span class="p">(</span><span class="s2">&quot;policy&quot;</span><span class="p">,</span> <span class="s2">&quot;policy_spec&quot;</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a>        <span class="n">policy_spec</span> <span class="o">=</span> <span class="n">policy</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a>    <span class="k">assert</span> <span class="n">policy_spec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> \
<a id="__codelineno-0-173" name="__codelineno-0-173"></a>        <span class="s2">&quot;Must provide `policy_spec` when creating RolloutWorker!&quot;</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a>    <span class="c1"># Do quick translation into MultiAgentPolicyConfigDict.</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">policy_spec</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a>        <span class="n">policy_spec</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>            <span class="n">DEFAULT_POLICY_ID</span><span class="p">:</span> <span class="n">PolicySpec</span><span class="p">(</span><span class="n">policy_class</span><span class="o">=</span><span class="n">policy_spec</span><span class="p">)</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a>        <span class="p">}</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a>    <span class="n">policy_spec</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a>        <span class="n">pid</span><span class="p">:</span> <span class="n">spec</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">PolicySpec</span><span class="p">)</span> <span class="k">else</span> <span class="n">PolicySpec</span><span class="p">(</span><span class="o">*</span><span class="n">spec</span><span class="p">)</span>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a>        <span class="k">for</span> <span class="n">pid</span><span class="p">,</span> <span class="n">spec</span> <span class="ow">in</span> <span class="n">policy_spec</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a>    <span class="p">}</span>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a>    <span class="k">if</span> <span class="n">monitor_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a>        <span class="n">deprecation_warning</span><span class="p">(</span><span class="s2">&quot;monitor_path&quot;</span><span class="p">,</span> <span class="s2">&quot;record_env&quot;</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>        <span class="n">record_env</span> <span class="o">=</span> <span class="n">monitor_path</span>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_original_kwargs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="nb">locals</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_original_kwargs</span><span class="p">[</span><span class="s2">&quot;self&quot;</span><span class="p">]</span>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a>    <span class="k">global</span> <span class="n">_global_worker</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a>    <span class="n">_global_worker</span> <span class="o">=</span> <span class="bp">self</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a>    <span class="c1"># set extra environs first</span>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a>    <span class="k">if</span> <span class="n">extra_python_environs</span><span class="p">:</span>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a>        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">extra_python_environs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a>            <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a>    <span class="k">def</span> <span class="nf">gen_rollouts</span><span class="p">():</span>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a>        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a>            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a>    <span class="n">ParallelIteratorWorker</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gen_rollouts</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a>    <span class="n">policy_config</span> <span class="o">=</span> <span class="n">policy_config</span> <span class="ow">or</span> <span class="p">{}</span>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">tf1</span> <span class="ow">and</span> <span class="n">policy_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;framework&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;tf2&quot;</span><span class="p">,</span> <span class="s2">&quot;tfe&quot;</span><span class="p">]</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a>            <span class="c1"># This eager check is necessary for certain all-framework tests</span>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a>            <span class="c1"># that use tf&#39;s eager_mode() context generator.</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a>            <span class="ow">and</span> <span class="ow">not</span> <span class="n">tf1</span><span class="o">.</span><span class="n">executing_eagerly</span><span class="p">()):</span>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a>        <span class="n">tf1</span><span class="o">.</span><span class="n">enable_eager_execution</span><span class="p">()</span>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a>    <span class="k">if</span> <span class="n">log_level</span><span class="p">:</span>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a>        <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;ray.rllib&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">log_level</span><span class="p">)</span>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a>    <span class="k">if</span> <span class="n">worker_index</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a>        <span class="n">disable_log_once_globally</span><span class="p">()</span>  <span class="c1"># only need 1 worker to log</span>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a>    <span class="k">elif</span> <span class="n">log_level</span> <span class="o">==</span> <span class="s2">&quot;DEBUG&quot;</span><span class="p">:</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a>        <span class="n">enable_periodic_logging</span><span class="p">()</span>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a>    <span class="n">env_context</span> <span class="o">=</span> <span class="n">EnvContext</span><span class="p">(</span>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a>        <span class="n">env_config</span> <span class="ow">or</span> <span class="p">{},</span>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a>        <span class="n">worker_index</span><span class="o">=</span><span class="n">worker_index</span><span class="p">,</span>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a>        <span class="n">vector_index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a>        <span class="n">num_workers</span><span class="o">=</span><span class="n">num_workers</span><span class="p">,</span>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a>    <span class="p">)</span>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">env_context</span> <span class="o">=</span> <span class="n">env_context</span>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">policy_config</span><span class="p">:</span> <span class="n">PartialTrainerConfigDict</span> <span class="o">=</span> <span class="n">policy_config</span>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a>    <span class="k">if</span> <span class="n">callbacks</span><span class="p">:</span>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">:</span> <span class="s2">&quot;DefaultCallbacks&quot;</span> <span class="o">=</span> <span class="n">callbacks</span><span class="p">()</span>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a>        <span class="kn">from</span> <span class="nn">ray.rllib.agents.callbacks</span> <span class="kn">import</span> <span class="n">DefaultCallbacks</span>  <span class="c1"># noqa</span>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">:</span> <span class="n">DefaultCallbacks</span> <span class="o">=</span> <span class="n">DefaultCallbacks</span><span class="p">()</span>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">worker_index</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">worker_index</span>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">num_workers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">num_workers</span>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a>    <span class="n">model_config</span><span class="p">:</span> <span class="n">ModelConfigDict</span> <span class="o">=</span> \
<a id="__codelineno-0-237" name="__codelineno-0-237"></a>        <span class="n">model_config</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">policy_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>
<a id="__codelineno-0-238" name="__codelineno-0-238"></a>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a>    <span class="c1"># Default policy mapping fn is to always return DEFAULT_POLICY_ID,</span>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a>    <span class="c1"># independent on the agent ID and the episode passed in.</span>
<a id="__codelineno-0-241" name="__codelineno-0-241"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">policy_mapping_fn</span> <span class="o">=</span> \
<a id="__codelineno-0-242" name="__codelineno-0-242"></a>        <span class="k">lambda</span> <span class="n">agent_id</span><span class="p">,</span> <span class="n">episode</span><span class="p">,</span> <span class="n">worker</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">DEFAULT_POLICY_ID</span>
<a id="__codelineno-0-243" name="__codelineno-0-243"></a>    <span class="c1"># If provided, set it here.</span>
<a id="__codelineno-0-244" name="__codelineno-0-244"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">set_policy_mapping_fn</span><span class="p">(</span><span class="n">policy_mapping_fn</span><span class="p">)</span>
<a id="__codelineno-0-245" name="__codelineno-0-245"></a>
<a id="__codelineno-0-246" name="__codelineno-0-246"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">env_creator</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">EnvContext</span><span class="p">],</span> <span class="n">EnvType</span><span class="p">]</span> <span class="o">=</span> <span class="n">env_creator</span>
<a id="__codelineno-0-247" name="__codelineno-0-247"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">rollout_fragment_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">rollout_fragment_length</span> <span class="o">*</span> <span class="n">num_envs</span>
<a id="__codelineno-0-248" name="__codelineno-0-248"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">count_steps_by</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">count_steps_by</span>
<a id="__codelineno-0-249" name="__codelineno-0-249"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">batch_mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">batch_mode</span>
<a id="__codelineno-0-250" name="__codelineno-0-250"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">compress_observations</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">compress_observations</span>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">preprocessing_enabled</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span> \
<a id="__codelineno-0-252" name="__codelineno-0-252"></a>        <span class="k">if</span> <span class="n">policy_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_disable_preprocessor_api&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">True</span>
<a id="__codelineno-0-253" name="__codelineno-0-253"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">observation_filter</span> <span class="o">=</span> <span class="n">observation_filter</span>
<a id="__codelineno-0-254" name="__codelineno-0-254"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">last_batch</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SampleBatchType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-255" name="__codelineno-0-255"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">global_vars</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-256" name="__codelineno-0-256"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">fake_sampler</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">fake_sampler</span>
<a id="__codelineno-0-257" name="__codelineno-0-257"></a>
<a id="__codelineno-0-258" name="__codelineno-0-258"></a>    <span class="c1"># Update the global seed for numpy/random/tf-eager/torch if we are not</span>
<a id="__codelineno-0-259" name="__codelineno-0-259"></a>    <span class="c1"># the local worker, otherwise, this was already done in the Trainer</span>
<a id="__codelineno-0-260" name="__codelineno-0-260"></a>    <span class="c1"># object itself.</span>
<a id="__codelineno-0-261" name="__codelineno-0-261"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker_index</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-262" name="__codelineno-0-262"></a>        <span class="n">update_global_seed_if_necessary</span><span class="p">(</span>
<a id="__codelineno-0-263" name="__codelineno-0-263"></a>            <span class="n">policy_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;framework&quot;</span><span class="p">),</span> <span class="n">seed</span><span class="p">)</span>
<a id="__codelineno-0-264" name="__codelineno-0-264"></a>
<a id="__codelineno-0-265" name="__codelineno-0-265"></a>    <span class="c1"># A single environment provided by the user (via config.env). This may</span>
<a id="__codelineno-0-266" name="__codelineno-0-266"></a>    <span class="c1"># also remain None.</span>
<a id="__codelineno-0-267" name="__codelineno-0-267"></a>    <span class="c1"># 1) Create the env using the user provided env_creator. This may</span>
<a id="__codelineno-0-268" name="__codelineno-0-268"></a>    <span class="c1">#    return a gym.Env (incl. MultiAgentEnv), an already vectorized</span>
<a id="__codelineno-0-269" name="__codelineno-0-269"></a>    <span class="c1">#    VectorEnv, BaseEnv, ExternalEnv, or an ActorHandle (remote env).</span>
<a id="__codelineno-0-270" name="__codelineno-0-270"></a>    <span class="c1"># 2) Wrap - if applicable - with Atari/recording/rendering wrappers.</span>
<a id="__codelineno-0-271" name="__codelineno-0-271"></a>    <span class="c1"># 3) Seed the env, if necessary.</span>
<a id="__codelineno-0-272" name="__codelineno-0-272"></a>    <span class="c1"># 4) Vectorize the existing single env by creating more clones of</span>
<a id="__codelineno-0-273" name="__codelineno-0-273"></a>    <span class="c1">#    this env and wrapping it with the RLlib BaseEnv class.</span>
<a id="__codelineno-0-274" name="__codelineno-0-274"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">env</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-275" name="__codelineno-0-275"></a>
<a id="__codelineno-0-276" name="__codelineno-0-276"></a>    <span class="c1"># Create a (single) env for this worker.</span>
<a id="__codelineno-0-277" name="__codelineno-0-277"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">worker_index</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">num_workers</span> <span class="o">&gt;</span> <span class="mi">0</span>
<a id="__codelineno-0-278" name="__codelineno-0-278"></a>            <span class="ow">and</span> <span class="ow">not</span> <span class="n">policy_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;create_env_on_driver&quot;</span><span class="p">)):</span>
<a id="__codelineno-0-279" name="__codelineno-0-279"></a>        <span class="c1"># Run the `env_creator` function passing the EnvContext.</span>
<a id="__codelineno-0-280" name="__codelineno-0-280"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">env</span> <span class="o">=</span> <span class="n">env_creator</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env_context</span><span class="p">))</span>
<a id="__codelineno-0-281" name="__codelineno-0-281"></a>
<a id="__codelineno-0-282" name="__codelineno-0-282"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-283" name="__codelineno-0-283"></a>        <span class="c1"># Validate environment (general validation function).</span>
<a id="__codelineno-0-284" name="__codelineno-0-284"></a>        <span class="n">_validate_env</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">,</span> <span class="n">env_context</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">env_context</span><span class="p">)</span>
<a id="__codelineno-0-285" name="__codelineno-0-285"></a>        <span class="c1"># Custom validation function given.</span>
<a id="__codelineno-0-286" name="__codelineno-0-286"></a>        <span class="k">if</span> <span class="n">validate_env</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-287" name="__codelineno-0-287"></a>            <span class="n">validate_env</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">env_context</span><span class="p">)</span>
<a id="__codelineno-0-288" name="__codelineno-0-288"></a>        <span class="c1"># We can&#39;t auto-wrap a BaseEnv.</span>
<a id="__codelineno-0-289" name="__codelineno-0-289"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">,</span> <span class="p">(</span><span class="n">BaseEnv</span><span class="p">,</span> <span class="n">ray</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">ActorHandle</span><span class="p">)):</span>
<a id="__codelineno-0-290" name="__codelineno-0-290"></a>
<a id="__codelineno-0-291" name="__codelineno-0-291"></a>            <span class="k">def</span> <span class="nf">wrap</span><span class="p">(</span><span class="n">env</span><span class="p">):</span>
<a id="__codelineno-0-292" name="__codelineno-0-292"></a>                <span class="k">return</span> <span class="n">env</span>
<a id="__codelineno-0-293" name="__codelineno-0-293"></a>
<a id="__codelineno-0-294" name="__codelineno-0-294"></a>        <span class="c1"># Atari type env and &quot;deepmind&quot; preprocessor pref.</span>
<a id="__codelineno-0-295" name="__codelineno-0-295"></a>        <span class="k">elif</span> <span class="n">is_atari</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">)</span> <span class="ow">and</span> \
<a id="__codelineno-0-296" name="__codelineno-0-296"></a>                <span class="ow">not</span> <span class="n">model_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;custom_preprocessor&quot;</span><span class="p">)</span> <span class="ow">and</span> \
<a id="__codelineno-0-297" name="__codelineno-0-297"></a>                <span class="n">preprocessor_pref</span> <span class="o">==</span> <span class="s2">&quot;deepmind&quot;</span><span class="p">:</span>
<a id="__codelineno-0-298" name="__codelineno-0-298"></a>
<a id="__codelineno-0-299" name="__codelineno-0-299"></a>            <span class="c1"># Deepmind wrappers already handle all preprocessing.</span>
<a id="__codelineno-0-300" name="__codelineno-0-300"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">preprocessing_enabled</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-301" name="__codelineno-0-301"></a>
<a id="__codelineno-0-302" name="__codelineno-0-302"></a>            <span class="c1"># If clip_rewards not explicitly set to False, switch it</span>
<a id="__codelineno-0-303" name="__codelineno-0-303"></a>            <span class="c1"># on here (clip between -1.0 and 1.0).</span>
<a id="__codelineno-0-304" name="__codelineno-0-304"></a>            <span class="k">if</span> <span class="n">clip_rewards</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-305" name="__codelineno-0-305"></a>                <span class="n">clip_rewards</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-306" name="__codelineno-0-306"></a>
<a id="__codelineno-0-307" name="__codelineno-0-307"></a>            <span class="c1"># Framestacking is used.</span>
<a id="__codelineno-0-308" name="__codelineno-0-308"></a>            <span class="n">use_framestack</span> <span class="o">=</span> <span class="n">model_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;framestack&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span>
<a id="__codelineno-0-309" name="__codelineno-0-309"></a>
<a id="__codelineno-0-310" name="__codelineno-0-310"></a>            <span class="k">def</span> <span class="nf">wrap</span><span class="p">(</span><span class="n">env</span><span class="p">):</span>
<a id="__codelineno-0-311" name="__codelineno-0-311"></a>                <span class="n">env</span> <span class="o">=</span> <span class="n">wrap_deepmind</span><span class="p">(</span>
<a id="__codelineno-0-312" name="__codelineno-0-312"></a>                    <span class="n">env</span><span class="p">,</span>
<a id="__codelineno-0-313" name="__codelineno-0-313"></a>                    <span class="n">dim</span><span class="o">=</span><span class="n">model_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dim&quot;</span><span class="p">),</span>
<a id="__codelineno-0-314" name="__codelineno-0-314"></a>                    <span class="n">framestack</span><span class="o">=</span><span class="n">use_framestack</span><span class="p">)</span>
<a id="__codelineno-0-315" name="__codelineno-0-315"></a>                <span class="n">env</span> <span class="o">=</span> <span class="n">record_env_wrapper</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">record_env</span><span class="p">,</span> <span class="n">log_dir</span><span class="p">,</span>
<a id="__codelineno-0-316" name="__codelineno-0-316"></a>                                         <span class="n">policy_config</span><span class="p">)</span>
<a id="__codelineno-0-317" name="__codelineno-0-317"></a>                <span class="k">return</span> <span class="n">env</span>
<a id="__codelineno-0-318" name="__codelineno-0-318"></a>
<a id="__codelineno-0-319" name="__codelineno-0-319"></a>        <span class="c1"># gym.Env -&gt; Wrap with gym Monitor.</span>
<a id="__codelineno-0-320" name="__codelineno-0-320"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-321" name="__codelineno-0-321"></a>
<a id="__codelineno-0-322" name="__codelineno-0-322"></a>            <span class="k">def</span> <span class="nf">wrap</span><span class="p">(</span><span class="n">env</span><span class="p">):</span>
<a id="__codelineno-0-323" name="__codelineno-0-323"></a>                <span class="k">return</span> <span class="n">record_env_wrapper</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">record_env</span><span class="p">,</span> <span class="n">log_dir</span><span class="p">,</span>
<a id="__codelineno-0-324" name="__codelineno-0-324"></a>                                          <span class="n">policy_config</span><span class="p">)</span>
<a id="__codelineno-0-325" name="__codelineno-0-325"></a>
<a id="__codelineno-0-326" name="__codelineno-0-326"></a>        <span class="c1"># Wrap env through the correct wrapper.</span>
<a id="__codelineno-0-327" name="__codelineno-0-327"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">:</span> <span class="n">EnvType</span> <span class="o">=</span> <span class="n">wrap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">)</span>
<a id="__codelineno-0-328" name="__codelineno-0-328"></a>        <span class="c1"># Ideally, we would use the same make_sub_env() function below</span>
<a id="__codelineno-0-329" name="__codelineno-0-329"></a>        <span class="c1"># to create self.env, but wrap(env) and self.env has a cyclic</span>
<a id="__codelineno-0-330" name="__codelineno-0-330"></a>        <span class="c1"># dependency on each other right now, so we would settle on</span>
<a id="__codelineno-0-331" name="__codelineno-0-331"></a>        <span class="c1"># duplicating the random seed setting logic for now.</span>
<a id="__codelineno-0-332" name="__codelineno-0-332"></a>        <span class="n">_update_env_seed_if_necessary</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">,</span> <span class="n">seed</span><span class="p">,</span> <span class="n">worker_index</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-0-333" name="__codelineno-0-333"></a>
<a id="__codelineno-0-334" name="__codelineno-0-334"></a>    <span class="k">def</span> <span class="nf">make_sub_env</span><span class="p">(</span><span class="n">vector_index</span><span class="p">):</span>
<a id="__codelineno-0-335" name="__codelineno-0-335"></a>        <span class="c1"># Used to created additional environments during environment</span>
<a id="__codelineno-0-336" name="__codelineno-0-336"></a>        <span class="c1"># vectorization.</span>
<a id="__codelineno-0-337" name="__codelineno-0-337"></a>
<a id="__codelineno-0-338" name="__codelineno-0-338"></a>        <span class="c1"># Create the env context (config dict + meta-data) for</span>
<a id="__codelineno-0-339" name="__codelineno-0-339"></a>        <span class="c1"># this particular sub-env within the vectorized one.</span>
<a id="__codelineno-0-340" name="__codelineno-0-340"></a>        <span class="n">env_ctx</span> <span class="o">=</span> <span class="n">env_context</span><span class="o">.</span><span class="n">copy_with_overrides</span><span class="p">(</span>
<a id="__codelineno-0-341" name="__codelineno-0-341"></a>            <span class="n">worker_index</span><span class="o">=</span><span class="n">worker_index</span><span class="p">,</span>
<a id="__codelineno-0-342" name="__codelineno-0-342"></a>            <span class="n">vector_index</span><span class="o">=</span><span class="n">vector_index</span><span class="p">,</span>
<a id="__codelineno-0-343" name="__codelineno-0-343"></a>            <span class="n">remote</span><span class="o">=</span><span class="n">remote_worker_envs</span><span class="p">)</span>
<a id="__codelineno-0-344" name="__codelineno-0-344"></a>        <span class="c1"># Create the sub-env.</span>
<a id="__codelineno-0-345" name="__codelineno-0-345"></a>        <span class="n">env</span> <span class="o">=</span> <span class="n">env_creator</span><span class="p">(</span><span class="n">env_ctx</span><span class="p">)</span>
<a id="__codelineno-0-346" name="__codelineno-0-346"></a>        <span class="c1"># Validate first.</span>
<a id="__codelineno-0-347" name="__codelineno-0-347"></a>        <span class="n">_validate_env</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">env_context</span><span class="o">=</span><span class="n">env_ctx</span><span class="p">)</span>
<a id="__codelineno-0-348" name="__codelineno-0-348"></a>        <span class="c1"># Custom validation function given by user.</span>
<a id="__codelineno-0-349" name="__codelineno-0-349"></a>        <span class="k">if</span> <span class="n">validate_env</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-350" name="__codelineno-0-350"></a>            <span class="n">validate_env</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">env_ctx</span><span class="p">)</span>
<a id="__codelineno-0-351" name="__codelineno-0-351"></a>        <span class="c1"># Use our wrapper, defined above.</span>
<a id="__codelineno-0-352" name="__codelineno-0-352"></a>        <span class="n">env</span> <span class="o">=</span> <span class="n">wrap</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
<a id="__codelineno-0-353" name="__codelineno-0-353"></a>
<a id="__codelineno-0-354" name="__codelineno-0-354"></a>        <span class="c1"># Make sure a deterministic random seed is set on</span>
<a id="__codelineno-0-355" name="__codelineno-0-355"></a>        <span class="c1"># all the sub-environments if specified.</span>
<a id="__codelineno-0-356" name="__codelineno-0-356"></a>        <span class="n">_update_env_seed_if_necessary</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">seed</span><span class="p">,</span> <span class="n">worker_index</span><span class="p">,</span>
<a id="__codelineno-0-357" name="__codelineno-0-357"></a>                                      <span class="n">vector_index</span><span class="p">)</span>
<a id="__codelineno-0-358" name="__codelineno-0-358"></a>        <span class="k">return</span> <span class="n">env</span>
<a id="__codelineno-0-359" name="__codelineno-0-359"></a>
<a id="__codelineno-0-360" name="__codelineno-0-360"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">make_sub_env_fn</span> <span class="o">=</span> <span class="n">make_sub_env</span>
<a id="__codelineno-0-361" name="__codelineno-0-361"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">spaces</span> <span class="o">=</span> <span class="n">spaces</span>
<a id="__codelineno-0-362" name="__codelineno-0-362"></a>
<a id="__codelineno-0-363" name="__codelineno-0-363"></a>    <span class="n">policy_dict</span> <span class="o">=</span> <span class="n">_determine_spaces_for_multi_agent_dict</span><span class="p">(</span>
<a id="__codelineno-0-364" name="__codelineno-0-364"></a>        <span class="n">policy_spec</span><span class="p">,</span>
<a id="__codelineno-0-365" name="__codelineno-0-365"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">,</span>
<a id="__codelineno-0-366" name="__codelineno-0-366"></a>        <span class="n">spaces</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spaces</span><span class="p">,</span>
<a id="__codelineno-0-367" name="__codelineno-0-367"></a>        <span class="n">policy_config</span><span class="o">=</span><span class="n">policy_config</span><span class="p">)</span>
<a id="__codelineno-0-368" name="__codelineno-0-368"></a>
<a id="__codelineno-0-369" name="__codelineno-0-369"></a>    <span class="c1"># List of IDs of those policies, which should be trained.</span>
<a id="__codelineno-0-370" name="__codelineno-0-370"></a>    <span class="c1"># By default, these are all policies found in the policy_dict.</span>
<a id="__codelineno-0-371" name="__codelineno-0-371"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">policies_to_train</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">PolicyID</span><span class="p">]</span> <span class="o">=</span> <span class="n">policies_to_train</span> <span class="ow">or</span> <span class="nb">list</span><span class="p">(</span>
<a id="__codelineno-0-372" name="__codelineno-0-372"></a>        <span class="n">policy_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<a id="__codelineno-0-373" name="__codelineno-0-373"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">set_policies_to_train</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">policies_to_train</span><span class="p">)</span>
<a id="__codelineno-0-374" name="__codelineno-0-374"></a>
<a id="__codelineno-0-375" name="__codelineno-0-375"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">policy_map</span><span class="p">:</span> <span class="n">PolicyMap</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-376" name="__codelineno-0-376"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">preprocessors</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">PolicyID</span><span class="p">,</span> <span class="n">Preprocessor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-377" name="__codelineno-0-377"></a>
<a id="__codelineno-0-378" name="__codelineno-0-378"></a>    <span class="c1"># Check available number of GPUs.</span>
<a id="__codelineno-0-379" name="__codelineno-0-379"></a>    <span class="n">num_gpus</span> <span class="o">=</span> <span class="n">policy_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;num_gpus&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">if</span> \
<a id="__codelineno-0-380" name="__codelineno-0-380"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">worker_index</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> \
<a id="__codelineno-0-381" name="__codelineno-0-381"></a>        <span class="n">policy_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;num_gpus_per_worker&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-0-382" name="__codelineno-0-382"></a>    <span class="c1"># Error if we don&#39;t find enough GPUs.</span>
<a id="__codelineno-0-383" name="__codelineno-0-383"></a>    <span class="k">if</span> <span class="n">ray</span><span class="o">.</span><span class="n">is_initialized</span><span class="p">()</span> <span class="ow">and</span> \
<a id="__codelineno-0-384" name="__codelineno-0-384"></a>            <span class="n">ray</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">_mode</span><span class="p">()</span> <span class="o">!=</span> <span class="n">ray</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">LOCAL_MODE</span> <span class="ow">and</span> \
<a id="__codelineno-0-385" name="__codelineno-0-385"></a>            <span class="ow">not</span> <span class="n">policy_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_fake_gpus&quot;</span><span class="p">):</span>
<a id="__codelineno-0-386" name="__codelineno-0-386"></a>
<a id="__codelineno-0-387" name="__codelineno-0-387"></a>        <span class="n">devices</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-388" name="__codelineno-0-388"></a>        <span class="k">if</span> <span class="n">policy_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;framework&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;tf2&quot;</span><span class="p">,</span> <span class="s2">&quot;tf&quot;</span><span class="p">,</span> <span class="s2">&quot;tfe&quot;</span><span class="p">]:</span>
<a id="__codelineno-0-389" name="__codelineno-0-389"></a>            <span class="n">devices</span> <span class="o">=</span> <span class="n">get_tf_gpu_devices</span><span class="p">()</span>
<a id="__codelineno-0-390" name="__codelineno-0-390"></a>        <span class="k">elif</span> <span class="n">policy_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;framework&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;torch&quot;</span><span class="p">:</span>
<a id="__codelineno-0-391" name="__codelineno-0-391"></a>            <span class="n">devices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">device_count</span><span class="p">()))</span>
<a id="__codelineno-0-392" name="__codelineno-0-392"></a>
<a id="__codelineno-0-393" name="__codelineno-0-393"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">devices</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">num_gpus</span><span class="p">:</span>
<a id="__codelineno-0-394" name="__codelineno-0-394"></a>            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
<a id="__codelineno-0-395" name="__codelineno-0-395"></a>                <span class="n">ERR_MSG_NO_GPUS</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">devices</span><span class="p">),</span> <span class="n">devices</span><span class="p">)</span> <span class="o">+</span>
<a id="__codelineno-0-396" name="__codelineno-0-396"></a>                <span class="n">HOWTO_CHANGE_CONFIG</span><span class="p">)</span>
<a id="__codelineno-0-397" name="__codelineno-0-397"></a>    <span class="c1"># Warn, if running in local-mode and actual GPUs (not faked) are</span>
<a id="__codelineno-0-398" name="__codelineno-0-398"></a>    <span class="c1"># requested.</span>
<a id="__codelineno-0-399" name="__codelineno-0-399"></a>    <span class="k">elif</span> <span class="n">ray</span><span class="o">.</span><span class="n">is_initialized</span><span class="p">()</span> <span class="ow">and</span> \
<a id="__codelineno-0-400" name="__codelineno-0-400"></a>            <span class="n">ray</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">_mode</span><span class="p">()</span> <span class="o">==</span> <span class="n">ray</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">LOCAL_MODE</span> <span class="ow">and</span> \
<a id="__codelineno-0-401" name="__codelineno-0-401"></a>            <span class="n">num_gpus</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">policy_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_fake_gpus&quot;</span><span class="p">):</span>
<a id="__codelineno-0-402" name="__codelineno-0-402"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
<a id="__codelineno-0-403" name="__codelineno-0-403"></a>            <span class="s2">&quot;You are running ray with `local_mode=True`, but have &quot;</span>
<a id="__codelineno-0-404" name="__codelineno-0-404"></a>            <span class="sa">f</span><span class="s2">&quot;configured </span><span class="si">{</span><span class="n">num_gpus</span><span class="si">}</span><span class="s2"> GPUs to be used! In local mode, &quot;</span>
<a id="__codelineno-0-405" name="__codelineno-0-405"></a>            <span class="sa">f</span><span class="s2">&quot;Policies are placed on the CPU and the `num_gpus` setting &quot;</span>
<a id="__codelineno-0-406" name="__codelineno-0-406"></a>            <span class="sa">f</span><span class="s2">&quot;is ignored.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-407" name="__codelineno-0-407"></a>
<a id="__codelineno-0-408" name="__codelineno-0-408"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_build_policy_map</span><span class="p">(</span>
<a id="__codelineno-0-409" name="__codelineno-0-409"></a>        <span class="n">policy_dict</span><span class="p">,</span>
<a id="__codelineno-0-410" name="__codelineno-0-410"></a>        <span class="n">policy_config</span><span class="p">,</span>
<a id="__codelineno-0-411" name="__codelineno-0-411"></a>        <span class="n">session_creator</span><span class="o">=</span><span class="n">tf_session_creator</span><span class="p">,</span>
<a id="__codelineno-0-412" name="__codelineno-0-412"></a>        <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
<a id="__codelineno-0-413" name="__codelineno-0-413"></a>
<a id="__codelineno-0-414" name="__codelineno-0-414"></a>    <span class="c1"># Update Policy&#39;s view requirements from Model, only if Policy directly</span>
<a id="__codelineno-0-415" name="__codelineno-0-415"></a>    <span class="c1"># inherited from base `Policy` class. At this point here, the Policy</span>
<a id="__codelineno-0-416" name="__codelineno-0-416"></a>    <span class="c1"># must have it&#39;s Model (if any) defined and ready to output an initial</span>
<a id="__codelineno-0-417" name="__codelineno-0-417"></a>    <span class="c1"># state.</span>
<a id="__codelineno-0-418" name="__codelineno-0-418"></a>    <span class="k">for</span> <span class="n">pol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">policy_map</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
<a id="__codelineno-0-419" name="__codelineno-0-419"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">pol</span><span class="o">.</span><span class="n">_model_init_state_automatically_added</span><span class="p">:</span>
<a id="__codelineno-0-420" name="__codelineno-0-420"></a>            <span class="n">pol</span><span class="o">.</span><span class="n">_update_model_view_requirements_from_init_state</span><span class="p">()</span>
<a id="__codelineno-0-421" name="__codelineno-0-421"></a>
<a id="__codelineno-0-422" name="__codelineno-0-422"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">multiagent</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
<a id="__codelineno-0-423" name="__codelineno-0-423"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">policy_map</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">!=</span> <span class="p">{</span><span class="n">DEFAULT_POLICY_ID</span><span class="p">}</span>
<a id="__codelineno-0-424" name="__codelineno-0-424"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">multiagent</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-425" name="__codelineno-0-425"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">,</span>
<a id="__codelineno-0-426" name="__codelineno-0-426"></a>                          <span class="p">(</span><span class="n">BaseEnv</span><span class="p">,</span> <span class="n">ExternalMultiAgentEnv</span><span class="p">,</span> <span class="n">MultiAgentEnv</span><span class="p">,</span>
<a id="__codelineno-0-427" name="__codelineno-0-427"></a>                           <span class="n">ray</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">ActorHandle</span><span class="p">)):</span>
<a id="__codelineno-0-428" name="__codelineno-0-428"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-429" name="__codelineno-0-429"></a>                <span class="sa">f</span><span class="s2">&quot;Have multiple policies </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">policy_map</span><span class="si">}</span><span class="s2">, but the &quot;</span>
<a id="__codelineno-0-430" name="__codelineno-0-430"></a>                <span class="sa">f</span><span class="s2">&quot;env </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="si">}</span><span class="s2"> is not a subclass of BaseEnv, &quot;</span>
<a id="__codelineno-0-431" name="__codelineno-0-431"></a>                <span class="sa">f</span><span class="s2">&quot;MultiAgentEnv, ActorHandle, or ExternalMultiAgentEnv!&quot;</span><span class="p">)</span>
<a id="__codelineno-0-432" name="__codelineno-0-432"></a>
<a id="__codelineno-0-433" name="__codelineno-0-433"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">PolicyID</span><span class="p">,</span> <span class="n">Filter</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-434" name="__codelineno-0-434"></a>        <span class="n">policy_id</span><span class="p">:</span> <span class="n">get_filter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">observation_filter</span><span class="p">,</span>
<a id="__codelineno-0-435" name="__codelineno-0-435"></a>                              <span class="n">policy</span><span class="o">.</span><span class="n">observation_space</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<a id="__codelineno-0-436" name="__codelineno-0-436"></a>        <span class="k">for</span> <span class="p">(</span><span class="n">policy_id</span><span class="p">,</span> <span class="n">policy</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">policy_map</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
<a id="__codelineno-0-437" name="__codelineno-0-437"></a>    <span class="p">}</span>
<a id="__codelineno-0-438" name="__codelineno-0-438"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker_index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-439" name="__codelineno-0-439"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Built filter map: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="p">))</span>
<a id="__codelineno-0-440" name="__codelineno-0-440"></a>
<a id="__codelineno-0-441" name="__codelineno-0-441"></a>    <span class="c1"># Vectorize environment, if any.</span>
<a id="__codelineno-0-442" name="__codelineno-0-442"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">num_envs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">num_envs</span>
<a id="__codelineno-0-443" name="__codelineno-0-443"></a>    <span class="c1"># This RolloutWorker has no env.</span>
<a id="__codelineno-0-444" name="__codelineno-0-444"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-445" name="__codelineno-0-445"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">async_env</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-446" name="__codelineno-0-446"></a>    <span class="c1"># Use a custom env-vectorizer and call it providing self.env.</span>
<a id="__codelineno-0-447" name="__codelineno-0-447"></a>    <span class="k">elif</span> <span class="s2">&quot;custom_vector_env&quot;</span> <span class="ow">in</span> <span class="n">policy_config</span><span class="p">:</span>
<a id="__codelineno-0-448" name="__codelineno-0-448"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">async_env</span> <span class="o">=</span> <span class="n">policy_config</span><span class="p">[</span><span class="s2">&quot;custom_vector_env&quot;</span><span class="p">](</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">)</span>
<a id="__codelineno-0-449" name="__codelineno-0-449"></a>    <span class="c1"># Default: Vectorize self.env via the make_sub_env function. This adds</span>
<a id="__codelineno-0-450" name="__codelineno-0-450"></a>    <span class="c1"># further clones of self.env and creates a RLlib BaseEnv (which is</span>
<a id="__codelineno-0-451" name="__codelineno-0-451"></a>    <span class="c1"># vectorized under the hood).</span>
<a id="__codelineno-0-452" name="__codelineno-0-452"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-453" name="__codelineno-0-453"></a>        <span class="c1"># Always use vector env for consistency even if num_envs = 1.</span>
<a id="__codelineno-0-454" name="__codelineno-0-454"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">async_env</span><span class="p">:</span> <span class="n">BaseEnv</span> <span class="o">=</span> <span class="n">BaseEnv</span><span class="o">.</span><span class="n">to_base_env</span><span class="p">(</span>
<a id="__codelineno-0-455" name="__codelineno-0-455"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">,</span>
<a id="__codelineno-0-456" name="__codelineno-0-456"></a>            <span class="n">make_env</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">make_sub_env_fn</span><span class="p">,</span>
<a id="__codelineno-0-457" name="__codelineno-0-457"></a>            <span class="n">num_envs</span><span class="o">=</span><span class="n">num_envs</span><span class="p">,</span>
<a id="__codelineno-0-458" name="__codelineno-0-458"></a>            <span class="n">remote_envs</span><span class="o">=</span><span class="n">remote_worker_envs</span><span class="p">,</span>
<a id="__codelineno-0-459" name="__codelineno-0-459"></a>            <span class="n">remote_env_batch_wait_ms</span><span class="o">=</span><span class="n">remote_env_batch_wait_ms</span><span class="p">,</span>
<a id="__codelineno-0-460" name="__codelineno-0-460"></a>            <span class="n">policy_config</span><span class="o">=</span><span class="n">policy_config</span><span class="p">,</span>
<a id="__codelineno-0-461" name="__codelineno-0-461"></a>        <span class="p">)</span>
<a id="__codelineno-0-462" name="__codelineno-0-462"></a>
<a id="__codelineno-0-463" name="__codelineno-0-463"></a>    <span class="c1"># `truncate_episodes`: Allow a batch to contain more than one episode</span>
<a id="__codelineno-0-464" name="__codelineno-0-464"></a>    <span class="c1"># (fragments) and always make the batch `rollout_fragment_length`</span>
<a id="__codelineno-0-465" name="__codelineno-0-465"></a>    <span class="c1"># long.</span>
<a id="__codelineno-0-466" name="__codelineno-0-466"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_mode</span> <span class="o">==</span> <span class="s2">&quot;truncate_episodes&quot;</span><span class="p">:</span>
<a id="__codelineno-0-467" name="__codelineno-0-467"></a>        <span class="n">pack</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-468" name="__codelineno-0-468"></a>    <span class="c1"># `complete_episodes`: Never cut episodes and sampler will return</span>
<a id="__codelineno-0-469" name="__codelineno-0-469"></a>    <span class="c1"># exactly one (complete) episode per poll.</span>
<a id="__codelineno-0-470" name="__codelineno-0-470"></a>    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_mode</span> <span class="o">==</span> <span class="s2">&quot;complete_episodes&quot;</span><span class="p">:</span>
<a id="__codelineno-0-471" name="__codelineno-0-471"></a>        <span class="n">rollout_fragment_length</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">)</span>
<a id="__codelineno-0-472" name="__codelineno-0-472"></a>        <span class="n">pack</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-473" name="__codelineno-0-473"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-474" name="__codelineno-0-474"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unsupported batch mode: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
<a id="__codelineno-0-475" name="__codelineno-0-475"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">batch_mode</span><span class="p">))</span>
<a id="__codelineno-0-476" name="__codelineno-0-476"></a>
<a id="__codelineno-0-477" name="__codelineno-0-477"></a>    <span class="c1"># Create the IOContext for this worker.</span>
<a id="__codelineno-0-478" name="__codelineno-0-478"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">io_context</span><span class="p">:</span> <span class="n">IOContext</span> <span class="o">=</span> <span class="n">IOContext</span><span class="p">(</span><span class="n">log_dir</span><span class="p">,</span> <span class="n">policy_config</span><span class="p">,</span>
<a id="__codelineno-0-479" name="__codelineno-0-479"></a>                                           <span class="n">worker_index</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
<a id="__codelineno-0-480" name="__codelineno-0-480"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">reward_estimators</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">OffPolicyEstimator</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-481" name="__codelineno-0-481"></a>    <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="n">input_evaluation</span><span class="p">:</span>
<a id="__codelineno-0-482" name="__codelineno-0-482"></a>        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;simulation&quot;</span><span class="p">:</span>
<a id="__codelineno-0-483" name="__codelineno-0-483"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
<a id="__codelineno-0-484" name="__codelineno-0-484"></a>                <span class="s2">&quot;Requested &#39;simulation&#39; input evaluation method: &quot;</span>
<a id="__codelineno-0-485" name="__codelineno-0-485"></a>                <span class="s2">&quot;will discard all sampler outputs and keep only metrics.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-486" name="__codelineno-0-486"></a>            <span class="n">sample_async</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-487" name="__codelineno-0-487"></a>        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;is&quot;</span><span class="p">:</span>
<a id="__codelineno-0-488" name="__codelineno-0-488"></a>            <span class="n">ise</span> <span class="o">=</span> <span class="n">ImportanceSamplingEstimator</span><span class="o">.</span>\
<a id="__codelineno-0-489" name="__codelineno-0-489"></a>                <span class="n">create_from_io_context</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">io_context</span><span class="p">)</span>
<a id="__codelineno-0-490" name="__codelineno-0-490"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">reward_estimators</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ise</span><span class="p">)</span>
<a id="__codelineno-0-491" name="__codelineno-0-491"></a>        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;wis&quot;</span><span class="p">:</span>
<a id="__codelineno-0-492" name="__codelineno-0-492"></a>            <span class="n">wise</span> <span class="o">=</span> <span class="n">WeightedImportanceSamplingEstimator</span><span class="o">.</span>\
<a id="__codelineno-0-493" name="__codelineno-0-493"></a>                <span class="n">create_from_io_context</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">io_context</span><span class="p">)</span>
<a id="__codelineno-0-494" name="__codelineno-0-494"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">reward_estimators</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wise</span><span class="p">)</span>
<a id="__codelineno-0-495" name="__codelineno-0-495"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-496" name="__codelineno-0-496"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-497" name="__codelineno-0-497"></a>                <span class="s2">&quot;Unknown evaluation method: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">method</span><span class="p">))</span>
<a id="__codelineno-0-498" name="__codelineno-0-498"></a>
<a id="__codelineno-0-499" name="__codelineno-0-499"></a>    <span class="n">render</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-500" name="__codelineno-0-500"></a>    <span class="k">if</span> <span class="n">policy_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;render_env&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> \
<a id="__codelineno-0-501" name="__codelineno-0-501"></a>            <span class="p">(</span><span class="n">num_workers</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">worker_index</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
<a id="__codelineno-0-502" name="__codelineno-0-502"></a>        <span class="n">render</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-503" name="__codelineno-0-503"></a>
<a id="__codelineno-0-504" name="__codelineno-0-504"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-505" name="__codelineno-0-505"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sampler</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-506" name="__codelineno-0-506"></a>    <span class="k">elif</span> <span class="n">sample_async</span><span class="p">:</span>
<a id="__codelineno-0-507" name="__codelineno-0-507"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sampler</span> <span class="o">=</span> <span class="n">AsyncSampler</span><span class="p">(</span>
<a id="__codelineno-0-508" name="__codelineno-0-508"></a>            <span class="n">worker</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-509" name="__codelineno-0-509"></a>            <span class="n">env</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">async_env</span><span class="p">,</span>
<a id="__codelineno-0-510" name="__codelineno-0-510"></a>            <span class="n">clip_rewards</span><span class="o">=</span><span class="n">clip_rewards</span><span class="p">,</span>
<a id="__codelineno-0-511" name="__codelineno-0-511"></a>            <span class="n">rollout_fragment_length</span><span class="o">=</span><span class="n">rollout_fragment_length</span><span class="p">,</span>
<a id="__codelineno-0-512" name="__codelineno-0-512"></a>            <span class="n">count_steps_by</span><span class="o">=</span><span class="n">count_steps_by</span><span class="p">,</span>
<a id="__codelineno-0-513" name="__codelineno-0-513"></a>            <span class="n">callbacks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">,</span>
<a id="__codelineno-0-514" name="__codelineno-0-514"></a>            <span class="n">horizon</span><span class="o">=</span><span class="n">episode_horizon</span><span class="p">,</span>
<a id="__codelineno-0-515" name="__codelineno-0-515"></a>            <span class="n">multiple_episodes_in_batch</span><span class="o">=</span><span class="n">pack</span><span class="p">,</span>
<a id="__codelineno-0-516" name="__codelineno-0-516"></a>            <span class="n">normalize_actions</span><span class="o">=</span><span class="n">normalize_actions</span><span class="p">,</span>
<a id="__codelineno-0-517" name="__codelineno-0-517"></a>            <span class="n">clip_actions</span><span class="o">=</span><span class="n">clip_actions</span><span class="p">,</span>
<a id="__codelineno-0-518" name="__codelineno-0-518"></a>            <span class="n">blackhole_outputs</span><span class="o">=</span><span class="s2">&quot;simulation&quot;</span> <span class="ow">in</span> <span class="n">input_evaluation</span><span class="p">,</span>
<a id="__codelineno-0-519" name="__codelineno-0-519"></a>            <span class="n">soft_horizon</span><span class="o">=</span><span class="n">soft_horizon</span><span class="p">,</span>
<a id="__codelineno-0-520" name="__codelineno-0-520"></a>            <span class="n">no_done_at_end</span><span class="o">=</span><span class="n">no_done_at_end</span><span class="p">,</span>
<a id="__codelineno-0-521" name="__codelineno-0-521"></a>            <span class="n">observation_fn</span><span class="o">=</span><span class="n">observation_fn</span><span class="p">,</span>
<a id="__codelineno-0-522" name="__codelineno-0-522"></a>            <span class="n">sample_collector_class</span><span class="o">=</span><span class="n">policy_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sample_collector&quot;</span><span class="p">),</span>
<a id="__codelineno-0-523" name="__codelineno-0-523"></a>            <span class="n">render</span><span class="o">=</span><span class="n">render</span><span class="p">,</span>
<a id="__codelineno-0-524" name="__codelineno-0-524"></a>        <span class="p">)</span>
<a id="__codelineno-0-525" name="__codelineno-0-525"></a>        <span class="c1"># Start the Sampler thread.</span>
<a id="__codelineno-0-526" name="__codelineno-0-526"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sampler</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
<a id="__codelineno-0-527" name="__codelineno-0-527"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-528" name="__codelineno-0-528"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sampler</span> <span class="o">=</span> <span class="n">SyncSampler</span><span class="p">(</span>
<a id="__codelineno-0-529" name="__codelineno-0-529"></a>            <span class="n">worker</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-530" name="__codelineno-0-530"></a>            <span class="n">env</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">async_env</span><span class="p">,</span>
<a id="__codelineno-0-531" name="__codelineno-0-531"></a>            <span class="n">clip_rewards</span><span class="o">=</span><span class="n">clip_rewards</span><span class="p">,</span>
<a id="__codelineno-0-532" name="__codelineno-0-532"></a>            <span class="n">rollout_fragment_length</span><span class="o">=</span><span class="n">rollout_fragment_length</span><span class="p">,</span>
<a id="__codelineno-0-533" name="__codelineno-0-533"></a>            <span class="n">count_steps_by</span><span class="o">=</span><span class="n">count_steps_by</span><span class="p">,</span>
<a id="__codelineno-0-534" name="__codelineno-0-534"></a>            <span class="n">callbacks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">,</span>
<a id="__codelineno-0-535" name="__codelineno-0-535"></a>            <span class="n">horizon</span><span class="o">=</span><span class="n">episode_horizon</span><span class="p">,</span>
<a id="__codelineno-0-536" name="__codelineno-0-536"></a>            <span class="n">multiple_episodes_in_batch</span><span class="o">=</span><span class="n">pack</span><span class="p">,</span>
<a id="__codelineno-0-537" name="__codelineno-0-537"></a>            <span class="n">normalize_actions</span><span class="o">=</span><span class="n">normalize_actions</span><span class="p">,</span>
<a id="__codelineno-0-538" name="__codelineno-0-538"></a>            <span class="n">clip_actions</span><span class="o">=</span><span class="n">clip_actions</span><span class="p">,</span>
<a id="__codelineno-0-539" name="__codelineno-0-539"></a>            <span class="n">soft_horizon</span><span class="o">=</span><span class="n">soft_horizon</span><span class="p">,</span>
<a id="__codelineno-0-540" name="__codelineno-0-540"></a>            <span class="n">no_done_at_end</span><span class="o">=</span><span class="n">no_done_at_end</span><span class="p">,</span>
<a id="__codelineno-0-541" name="__codelineno-0-541"></a>            <span class="n">observation_fn</span><span class="o">=</span><span class="n">observation_fn</span><span class="p">,</span>
<a id="__codelineno-0-542" name="__codelineno-0-542"></a>            <span class="n">sample_collector_class</span><span class="o">=</span><span class="n">policy_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sample_collector&quot;</span><span class="p">),</span>
<a id="__codelineno-0-543" name="__codelineno-0-543"></a>            <span class="n">render</span><span class="o">=</span><span class="n">render</span><span class="p">,</span>
<a id="__codelineno-0-544" name="__codelineno-0-544"></a>        <span class="p">)</span>
<a id="__codelineno-0-545" name="__codelineno-0-545"></a>
<a id="__codelineno-0-546" name="__codelineno-0-546"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">input_reader</span><span class="p">:</span> <span class="n">InputReader</span> <span class="o">=</span> <span class="n">input_creator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">io_context</span><span class="p">)</span>
<a id="__codelineno-0-547" name="__codelineno-0-547"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">output_writer</span><span class="p">:</span> <span class="n">OutputWriter</span> <span class="o">=</span> <span class="n">output_creator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">io_context</span><span class="p">)</span>
<a id="__codelineno-0-548" name="__codelineno-0-548"></a>
<a id="__codelineno-0-549" name="__codelineno-0-549"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<a id="__codelineno-0-550" name="__codelineno-0-550"></a>        <span class="s2">&quot;Created rollout worker with env </span><span class="si">{}</span><span class="s2"> (</span><span class="si">{}</span><span class="s2">), policies </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
<a id="__codelineno-0-551" name="__codelineno-0-551"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">async_env</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">policy_map</span><span class="p">))</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="ray.rllib.evaluation.rollout_worker.RolloutWorker.add_policy">
<code class="highlight language-python"><span class="n">add_policy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">policy_id</span><span class="p">,</span> <span class="n">policy_cls</span><span class="p">,</span> <span class="n">observation_space</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">action_space</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">policy_mapping_fn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">policies_to_train</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Adds a new policy to this RolloutWorker.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>policy_id</code></td>
        <td><code>str</code></td>
        <td><p>ID of the policy to add.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>policy_cls</code></td>
        <td><code>Type[ray.rllib.policy.policy.Policy]</code></td>
        <td><p>The Policy class to use for constructing the new
Policy.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>observation_space</code></td>
        <td><code>Optional[gym.spaces.space.Space]</code></td>
        <td><p>The observation space of the policy to add.</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>action_space</code></td>
        <td><code>Optional[gym.spaces.space.Space]</code></td>
        <td><p>The action space of the policy to add.</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>config</code></td>
        <td><code>Optional[dict]</code></td>
        <td><p>The config overrides for the policy to add.</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>policy_config</code></td>
        <td></td>
        <td><p>The base config of the Trainer object owning this
RolloutWorker.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>policy_mapping_fn</code></td>
        <td><code>Optional[Callable[[Any, Episode], str]]</code></td>
        <td><p>An optional (updated) policy mapping function
to use from here on. Note that already ongoing episodes will
not change their mapping but will use the old mapping till
the end of the episode.</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>policies_to_train</code></td>
        <td><code>Optional[List[str]]</code></td>
        <td><p>An optional list of policy IDs to be trained.
If None, will keep the existing list in place. Policies,
whose IDs are not in the list will not be updated.</p></td>
        <td><code>None</code></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>Policy</code></td>
      <td><p>The newly added policy.</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>ray/rllib/evaluation/rollout_worker.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nd">@DeveloperAPI</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="k">def</span> <span class="nf">add_policy</span><span class="p">(</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>        <span class="o">*</span><span class="p">,</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a>        <span class="n">policy_id</span><span class="p">:</span> <span class="n">PolicyID</span><span class="p">,</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a>        <span class="n">policy_cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Policy</span><span class="p">],</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a>        <span class="n">observation_space</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">gym</span><span class="o">.</span><span class="n">spaces</span><span class="o">.</span><span class="n">Space</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a>        <span class="n">action_space</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">gym</span><span class="o">.</span><span class="n">spaces</span><span class="o">.</span><span class="n">Space</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a>        <span class="n">config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">PartialTrainerConfigDict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a>        <span class="n">policy_mapping_fn</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">AgentID</span><span class="p">,</span> <span class="s2">&quot;Episode&quot;</span><span class="p">],</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a>                                             <span class="n">PolicyID</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a>        <span class="n">policies_to_train</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">PolicyID</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Policy</span><span class="p">:</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a>    <span class="sd">&quot;&quot;&quot;Adds a new policy to this RolloutWorker.</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="sd">        policy_id: ID of the policy to add.</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="sd">        policy_cls: The Policy class to use for constructing the new</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="sd">            Policy.</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="sd">        observation_space: The observation space of the policy to add.</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a><span class="sd">        action_space: The action space of the policy to add.</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a><span class="sd">        config: The config overrides for the policy to add.</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a><span class="sd">        policy_config: The base config of the Trainer object owning this</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a><span class="sd">            RolloutWorker.</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a><span class="sd">        policy_mapping_fn: An optional (updated) policy mapping function</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a><span class="sd">            to use from here on. Note that already ongoing episodes will</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a><span class="sd">            not change their mapping but will use the old mapping till</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a><span class="sd">            the end of the episode.</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a><span class="sd">        policies_to_train: An optional list of policy IDs to be trained.</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a><span class="sd">            If None, will keep the existing list in place. Policies,</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a><span class="sd">            whose IDs are not in the list will not be updated.</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a><span class="sd">        The newly added policy.</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a>    <span class="k">if</span> <span class="n">policy_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">policy_map</span><span class="p">:</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Policy ID &#39;</span><span class="si">{</span><span class="n">policy_id</span><span class="si">}</span><span class="s2">&#39; already in policy map!&quot;</span><span class="p">)</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a>    <span class="n">policy_dict</span> <span class="o">=</span> <span class="n">_determine_spaces_for_multi_agent_dict</span><span class="p">(</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a>        <span class="p">{</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a>            <span class="n">policy_id</span><span class="p">:</span> <span class="n">PolicySpec</span><span class="p">(</span><span class="n">policy_cls</span><span class="p">,</span> <span class="n">observation_space</span><span class="p">,</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>                                  <span class="n">action_space</span><span class="p">,</span> <span class="n">config</span> <span class="ow">or</span> <span class="p">{})</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>        <span class="p">},</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">,</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>        <span class="n">spaces</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spaces</span><span class="p">,</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>        <span class="n">policy_config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">policy_config</span><span class="p">,</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>    <span class="p">)</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_build_policy_map</span><span class="p">(</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>        <span class="n">policy_dict</span><span class="p">,</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">policy_config</span><span class="p">,</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>        <span class="n">seed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">policy_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;seed&quot;</span><span class="p">))</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>    <span class="n">new_policy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">policy_map</span><span class="p">[</span><span class="n">policy_id</span><span class="p">]</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="p">[</span><span class="n">policy_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_filter</span><span class="p">(</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">observation_filter</span><span class="p">,</span> <span class="n">new_policy</span><span class="o">.</span><span class="n">observation_space</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">set_policy_mapping_fn</span><span class="p">(</span><span class="n">policy_mapping_fn</span><span class="p">)</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">set_policies_to_train</span><span class="p">(</span><span class="n">policies_to_train</span><span class="p">)</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>    <span class="k">return</span> <span class="n">new_policy</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="ray.rllib.evaluation.rollout_worker.RolloutWorker.apply">
<code class="highlight language-python"><span class="n">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Calls the given function with this rollout worker instance.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>func</code></td>
        <td><code>Callable[[RolloutWorker, Optional[Any]], ~T]</code></td>
        <td><p>The function to call with this RolloutWorker as first
argument.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>args</code></td>
        <td></td>
        <td><p>Optional additional args to pass to the function call.</p></td>
        <td><code>()</code></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>~T</code></td>
      <td><p>The return value of the function call.</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>ray/rllib/evaluation/rollout_worker.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nd">@DeveloperAPI</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="s2">&quot;RolloutWorker&quot;</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">T</span><span class="p">],</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>          <span class="o">*</span><span class="n">args</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">T</span><span class="p">:</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>    <span class="sd">&quot;&quot;&quot;Calls the given function with this rollout worker instance.</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="sd">        func: The function to call with this RolloutWorker as first</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="sd">            argument.</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="sd">        args: Optional additional args to pass to the function call.</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="sd">        The return value of the function call.</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a>    <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="ray.rllib.evaluation.rollout_worker.RolloutWorker.apply_gradients">
<code class="highlight language-python"><span class="n">apply_gradients</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">grads</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Applies the given gradients to this worker's models.</p>
<p>Uses the Policy's/ies' apply_gradients method(s) to perform the
operations.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>grads</code></td>
        <td><code>Union[List[Tuple[Any, Any]], List[Any], Dict[str, Union[List[Tuple[Any, Any]], List[Any]]]]</code></td>
        <td><p>Single ModelGradients (single-agent case) or a dict
mapping PolicyIDs to the respective model gradients
structs.</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
<p><strong>Examples:</strong></p>
    <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="o">&gt;&gt;&gt;</span> <span class="n">samples</span> <span class="o">=</span> <span class="n">worker</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="o">&gt;&gt;&gt;</span> <span class="n">grads</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">worker</span><span class="o">.</span><span class="n">compute_gradients</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="o">&gt;&gt;&gt;</span> <span class="n">worker</span><span class="o">.</span><span class="n">apply_gradients</span><span class="p">(</span><span class="n">grads</span><span class="p">)</span>
</code></pre></div>

        <details class="quote">
          <summary>Source code in <code>ray/rllib/evaluation/rollout_worker.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nd">@DeveloperAPI</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="k">def</span> <span class="nf">apply_gradients</span><span class="p">(</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>        <span class="n">grads</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">ModelGradients</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="n">PolicyID</span><span class="p">,</span> <span class="n">ModelGradients</span><span class="p">]],</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a>    <span class="sd">&quot;&quot;&quot;Applies the given gradients to this worker&#39;s models.</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="sd">    Uses the Policy&#39;s/ies&#39; apply_gradients method(s) to perform the</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="sd">    operations.</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="sd">        grads: Single ModelGradients (single-agent case) or a dict</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="sd">            mapping PolicyIDs to the respective model gradients</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="sd">            structs.</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="sd">    Examples:</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="sd">        &gt;&gt;&gt; samples = worker.sample()</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="sd">        &gt;&gt;&gt; grads, info = worker.compute_gradients(samples)</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="sd">        &gt;&gt;&gt; worker.apply_gradients(grads)</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a>    <span class="k">if</span> <span class="n">log_once</span><span class="p">(</span><span class="s2">&quot;apply_gradients&quot;</span><span class="p">):</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Apply gradients:</span><span class="se">\n\n</span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">summarize</span><span class="p">(</span><span class="n">grads</span><span class="p">)))</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a>    <span class="c1"># Grads is a dict (mapping PolicyIDs to ModelGradients).</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a>    <span class="c1"># Multi-agent case.</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">grads</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a>        <span class="k">for</span> <span class="n">pid</span><span class="p">,</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">grads</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a>            <span class="k">if</span> <span class="n">pid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">policies_to_train</span><span class="p">:</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">policy_map</span><span class="p">[</span><span class="n">pid</span><span class="p">]</span><span class="o">.</span><span class="n">apply_gradients</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a>    <span class="c1"># Grads is a ModelGradients type. Single-agent case.</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a>    <span class="k">elif</span> <span class="n">DEFAULT_POLICY_ID</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">policies_to_train</span><span class="p">:</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">policy_map</span><span class="p">[</span><span class="n">DEFAULT_POLICY_ID</span><span class="p">]</span><span class="o">.</span><span class="n">apply_gradients</span><span class="p">(</span><span class="n">grads</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="ray.rllib.evaluation.rollout_worker.RolloutWorker.as_remote">
<code class="highlight language-python"><span class="n">as_remote</span><span class="p">(</span><span class="n">num_cpus</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">num_gpus</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">memory</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">object_store_memory</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">resources</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-classmethod"><code>classmethod</code></small>
  </span>

</h3>

    <div class="doc doc-contents ">

      <p>Returns RolloutWorker class as a <code>@ray.remote using given options</code>.</p>
<p>The returned class can then be used to instantiate ray actors.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>num_cpus</code></td>
        <td><code>Optional[int]</code></td>
        <td><p>The number of CPUs to allocate for the remote actor.</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>num_gpus</code></td>
        <td><code>Union[int, float]</code></td>
        <td><p>The number of GPUs to allocate for the remote actor.
This could be a fraction as well.</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>memory</code></td>
        <td><code>Optional[int]</code></td>
        <td><p>The heap memory request for the remote actor.</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>object_store_memory</code></td>
        <td><code>Optional[int]</code></td>
        <td><p>The object store memory for the remote actor.</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>resources</code></td>
        <td><code>Optional[dict]</code></td>
        <td><p>The default custom resources to allocate for the remote
actor.</p></td>
        <td><code>None</code></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>type</code></td>
      <td><p>The <code>@ray.remote</code> decorated RolloutWorker class.</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>ray/rllib/evaluation/rollout_worker.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nd">@DeveloperAPI</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="nd">@classmethod</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="k">def</span> <span class="nf">as_remote</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>              <span class="n">num_cpus</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a>              <span class="n">num_gpus</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a>              <span class="n">memory</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a>              <span class="n">object_store_memory</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a>              <span class="n">resources</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">type</span><span class="p">:</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a>    <span class="sd">&quot;&quot;&quot;Returns RolloutWorker class as a `@ray.remote using given options`.</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="sd">    The returned class can then be used to instantiate ray actors.</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="sd">        num_cpus: The number of CPUs to allocate for the remote actor.</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="sd">        num_gpus: The number of GPUs to allocate for the remote actor.</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="sd">            This could be a fraction as well.</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="sd">        memory: The heap memory request for the remote actor.</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="sd">        object_store_memory: The object store memory for the remote actor.</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="sd">        resources: The default custom resources to allocate for the remote</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="sd">            actor.</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a><span class="sd">        The `@ray.remote` decorated RolloutWorker class.</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a>    <span class="k">return</span> <span class="n">ray</span><span class="o">.</span><span class="n">remote</span><span class="p">(</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a>        <span class="n">num_cpus</span><span class="o">=</span><span class="n">num_cpus</span><span class="p">,</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a>        <span class="n">num_gpus</span><span class="o">=</span><span class="n">num_gpus</span><span class="p">,</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a>        <span class="n">memory</span><span class="o">=</span><span class="n">memory</span><span class="p">,</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a>        <span class="n">object_store_memory</span><span class="o">=</span><span class="n">object_store_memory</span><span class="p">,</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a>        <span class="n">resources</span><span class="o">=</span><span class="n">resources</span><span class="p">)(</span><span class="bp">cls</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="ray.rllib.evaluation.rollout_worker.RolloutWorker.compute_gradients">
<code class="highlight language-python"><span class="n">compute_gradients</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">samples</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Returns a gradient computed w.r.t the specified samples.</p>
<p>Uses the Policy's/ies' compute_gradients method(s) to perform the
calculations.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>samples</code></td>
        <td><code>Union[SampleBatch, MultiAgentBatch]</code></td>
        <td><p>The SampleBatch or MultiAgentBatch to compute gradients
for using this worker's policies.</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>Tuple[Union[List[Tuple[Any, Any]], List[Any]], dict]</code></td>
      <td><p>In the single-agent case, a tuple consisting of ModelGradients and
info dict of the worker's policy.
In the multi-agent case, a tuple consisting of a dict mapping
PolicyID to ModelGradients and a dict mapping PolicyID to extra
metadata info.
Note that the first return value (grads) can be applied as is to a
compatible worker using the worker's <code>apply_gradients()</code> method.</p></td>
    </tr>
  </tbody>
</table>
<p><strong>Examples:</strong></p>
    <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="o">&gt;&gt;&gt;</span> <span class="n">batch</span> <span class="o">=</span> <span class="n">worker</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="o">&gt;&gt;&gt;</span> <span class="n">grads</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">worker</span><span class="o">.</span><span class="n">compute_gradients</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>
</code></pre></div>

        <details class="quote">
          <summary>Source code in <code>ray/rllib/evaluation/rollout_worker.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nd">@DeveloperAPI</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="k">def</span> <span class="nf">compute_gradients</span><span class="p">(</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">samples</span><span class="p">:</span> <span class="n">SampleBatchType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">ModelGradients</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]:</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>    <span class="sd">&quot;&quot;&quot;Returns a gradient computed w.r.t the specified samples.</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="sd">    Uses the Policy&#39;s/ies&#39; compute_gradients method(s) to perform the</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="sd">    calculations.</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="sd">        samples: The SampleBatch or MultiAgentBatch to compute gradients</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="sd">            for using this worker&#39;s policies.</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="sd">        In the single-agent case, a tuple consisting of ModelGradients and</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="sd">        info dict of the worker&#39;s policy.</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="sd">        In the multi-agent case, a tuple consisting of a dict mapping</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="sd">        PolicyID to ModelGradients and a dict mapping PolicyID to extra</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="sd">        metadata info.</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="sd">        Note that the first return value (grads) can be applied as is to a</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="sd">        compatible worker using the worker&#39;s `apply_gradients()` method.</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a><span class="sd">    Examples:</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a><span class="sd">        &gt;&gt;&gt; batch = worker.sample()</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a><span class="sd">        &gt;&gt;&gt; grads, info = worker.compute_gradients(samples)</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a>    <span class="k">if</span> <span class="n">log_once</span><span class="p">(</span><span class="s2">&quot;compute_gradients&quot;</span><span class="p">):</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Compute gradients on:</span><span class="se">\n\n</span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a>            <span class="n">summarize</span><span class="p">(</span><span class="n">samples</span><span class="p">)))</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a>    <span class="c1"># MultiAgentBatch -&gt; Calculate gradients for all policies.</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">MultiAgentBatch</span><span class="p">):</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a>        <span class="n">grad_out</span><span class="p">,</span> <span class="n">info_out</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{}</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">policy_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;framework&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;tf&quot;</span><span class="p">:</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a>            <span class="k">for</span> <span class="n">pid</span><span class="p">,</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">samples</span><span class="o">.</span><span class="n">policy_batches</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a>                <span class="k">if</span> <span class="n">pid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">policies_to_train</span><span class="p">:</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a>                    <span class="k">continue</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a>                <span class="n">policy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">policy_map</span><span class="p">[</span><span class="n">pid</span><span class="p">]</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a>                <span class="n">builder</span> <span class="o">=</span> <span class="n">TFRunBuilder</span><span class="p">(</span><span class="n">policy</span><span class="o">.</span><span class="n">get_session</span><span class="p">(),</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a>                                       <span class="s2">&quot;compute_gradients&quot;</span><span class="p">)</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a>                <span class="n">grad_out</span><span class="p">[</span><span class="n">pid</span><span class="p">],</span> <span class="n">info_out</span><span class="p">[</span><span class="n">pid</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a>                    <span class="n">policy</span><span class="o">.</span><span class="n">_build_compute_gradients</span><span class="p">(</span><span class="n">builder</span><span class="p">,</span> <span class="n">batch</span><span class="p">))</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>            <span class="n">grad_out</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">builder</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">grad_out</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>            <span class="n">info_out</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">builder</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">info_out</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>            <span class="k">for</span> <span class="n">pid</span><span class="p">,</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">samples</span><span class="o">.</span><span class="n">policy_batches</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>                <span class="k">if</span> <span class="n">pid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">policies_to_train</span><span class="p">:</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>                    <span class="k">continue</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>                <span class="n">grad_out</span><span class="p">[</span><span class="n">pid</span><span class="p">],</span> <span class="n">info_out</span><span class="p">[</span><span class="n">pid</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">policy_map</span><span class="p">[</span><span class="n">pid</span><span class="p">]</span><span class="o">.</span><span class="n">compute_gradients</span><span class="p">(</span><span class="n">batch</span><span class="p">))</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>    <span class="c1"># SampleBatch -&gt; Calculate gradients for the default policy.</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>        <span class="n">grad_out</span><span class="p">,</span> <span class="n">info_out</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">policy_map</span><span class="p">[</span><span class="n">DEFAULT_POLICY_ID</span><span class="p">]</span><span class="o">.</span><span class="n">compute_gradients</span><span class="p">(</span><span class="n">samples</span><span class="p">))</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>    <span class="n">info_out</span><span class="p">[</span><span class="s2">&quot;batch_count&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">samples</span><span class="o">.</span><span class="n">count</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>    <span class="k">if</span> <span class="n">log_once</span><span class="p">(</span><span class="s2">&quot;grad_out&quot;</span><span class="p">):</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Compute grad info:</span><span class="se">\n\n</span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>            <span class="n">summarize</span><span class="p">(</span><span class="n">info_out</span><span class="p">)))</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>    <span class="k">return</span> <span class="n">grad_out</span><span class="p">,</span> <span class="n">info_out</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="ray.rllib.evaluation.rollout_worker.RolloutWorker.creation_args">
<code class="highlight language-python"><span class="n">creation_args</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Returns the kwargs dict used to create this worker.</p>

        <details class="quote">
          <summary>Source code in <code>ray/rllib/evaluation/rollout_worker.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nd">@DeveloperAPI</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="k">def</span> <span class="nf">creation_args</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>    <span class="sd">&quot;&quot;&quot;Returns the kwargs dict used to create this worker.&quot;&quot;&quot;</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_original_kwargs</span>
</code></pre></div>
        </details>
    </div>

  </div>





  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="ray.rllib.evaluation.rollout_worker.RolloutWorker.find_free_port">
<code class="highlight language-python"><span class="n">find_free_port</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Finds a free port on the node that this worker runs on.</p>

        <details class="quote">
          <summary>Source code in <code>ray/rllib/evaluation/rollout_worker.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nd">@DeveloperAPI</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="k">def</span> <span class="nf">find_free_port</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>    <span class="sd">&quot;&quot;&quot;Finds a free port on the node that this worker runs on.&quot;&quot;&quot;</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>    <span class="kn">from</span> <span class="nn">ray.util.sgd</span> <span class="kn">import</span> <span class="n">utils</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a>    <span class="k">return</span> <span class="n">utils</span><span class="o">.</span><span class="n">find_free_port</span><span class="p">()</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="ray.rllib.evaluation.rollout_worker.RolloutWorker.for_policy">
<code class="highlight language-python"><span class="n">for_policy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">policy_id</span><span class="o">=</span><span class="s1">&#39;default_policy&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Calls the given function with the specified policy as first arg.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>func</code></td>
        <td><code>Callable[[ray.rllib.policy.policy.Policy, Optional[Any]], ~T]</code></td>
        <td><p>The function to call with the policy as first arg.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>policy_id</code></td>
        <td><code>Optional[str]</code></td>
        <td><p>The PolicyID of the policy to call the function with.</p></td>
        <td><code>&#39;default_policy&#39;</code></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>~T</code></td>
      <td><p>The return value of the function call.</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>ray/rllib/evaluation/rollout_worker.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nd">@DeveloperAPI</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="k">def</span> <span class="nf">for_policy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>               <span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Policy</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">T</span><span class="p">],</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>               <span class="n">policy_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">PolicyID</span><span class="p">]</span> <span class="o">=</span> <span class="n">DEFAULT_POLICY_ID</span><span class="p">,</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a>               <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">T</span><span class="p">:</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a>    <span class="sd">&quot;&quot;&quot;Calls the given function with the specified policy as first arg.</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="sd">        func: The function to call with the policy as first arg.</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="sd">        policy_id: The PolicyID of the policy to call the function with.</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="sd">    Keyword Args:</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="sd">        kwargs: Additional kwargs to be passed to the call.</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="sd">        The return value of the function call.</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a>    <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">policy_map</span><span class="p">[</span><span class="n">policy_id</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="ray.rllib.evaluation.rollout_worker.RolloutWorker.foreach_env">
<code class="highlight language-python"><span class="n">foreach_env</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Calls the given function with each sub-environment as arg.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>func</code></td>
        <td><code>Callable[[Any], ~T]</code></td>
        <td><p>The function to call for each underlying
sub-environment (as only arg).</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>List[~T]</code></td>
      <td><p>The list of return values of all calls to <code>func([env])</code>.</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>ray/rllib/evaluation/rollout_worker.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nd">@DeveloperAPI</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="k">def</span> <span class="nf">foreach_env</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">EnvType</span><span class="p">],</span> <span class="n">T</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">T</span><span class="p">]:</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>    <span class="sd">&quot;&quot;&quot;Calls the given function with each sub-environment as arg.</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="sd">        func: The function to call for each underlying</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="sd">            sub-environment (as only arg).</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="sd">         The list of return values of all calls to `func([env])`.</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">async_env</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a>        <span class="k">return</span> <span class="p">[]</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a>    <span class="n">envs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">async_env</span><span class="o">.</span><span class="n">get_sub_environments</span><span class="p">()</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a>    <span class="c1"># Empty list (not implemented): Call function directly on the</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a>    <span class="c1"># BaseEnv.</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">envs</span><span class="p">:</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a>        <span class="k">return</span> <span class="p">[</span><span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">async_env</span><span class="p">)]</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a>    <span class="c1"># Call function on all underlying (vectorized) sub environments.</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a>        <span class="k">return</span> <span class="p">[</span><span class="n">func</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">envs</span><span class="p">]</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="ray.rllib.evaluation.rollout_worker.RolloutWorker.foreach_env_with_context">
<code class="highlight language-python"><span class="n">foreach_env_with_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Calls given function with each sub-env plus env_ctx as args.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>func</code></td>
        <td><code>Callable[[Any, ray.rllib.env.env_context.EnvContext], ~T]</code></td>
        <td><p>The function to call for each underlying
sub-environment and its EnvContext (as the args).</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>List[~T]</code></td>
      <td><p>The list of return values of all calls to <code>func([env, ctx])</code>.</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>ray/rllib/evaluation/rollout_worker.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nd">@DeveloperAPI</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="k">def</span> <span class="nf">foreach_env_with_context</span><span class="p">(</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">EnvType</span><span class="p">,</span> <span class="n">EnvContext</span><span class="p">],</span> <span class="n">T</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">T</span><span class="p">]:</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>    <span class="sd">&quot;&quot;&quot;Calls given function with each sub-env plus env_ctx as args.</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="sd">        func: The function to call for each underlying</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="sd">            sub-environment and its EnvContext (as the args).</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="sd">         The list of return values of all calls to `func([env, ctx])`.</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">async_env</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a>        <span class="k">return</span> <span class="p">[]</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a>    <span class="n">envs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">async_env</span><span class="o">.</span><span class="n">get_sub_environments</span><span class="p">()</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a>    <span class="c1"># Empty list (not implemented): Call function directly on the</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a>    <span class="c1"># BaseEnv.</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">envs</span><span class="p">:</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a>        <span class="k">return</span> <span class="p">[</span><span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">async_env</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">env_context</span><span class="p">)]</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a>    <span class="c1"># Call function on all underlying (vectorized) sub environments.</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a>        <span class="n">ret</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">envs</span><span class="p">):</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a>            <span class="n">ctx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env_context</span><span class="o">.</span><span class="n">copy_with_overrides</span><span class="p">(</span><span class="n">vector_index</span><span class="o">=</span><span class="n">i</span><span class="p">)</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a>            <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">func</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">ctx</span><span class="p">))</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a>        <span class="k">return</span> <span class="n">ret</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="ray.rllib.evaluation.rollout_worker.RolloutWorker.foreach_policy">
<code class="highlight language-python"><span class="n">foreach_policy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Calls the given function with each (policy, policy_id) tuple.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>func</code></td>
        <td><code>Callable[[ray.rllib.policy.policy.Policy, str, Optional[Any]], ~T]</code></td>
        <td><p>The function to call with each (policy, policy ID) tuple.</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>List[~T]</code></td>
      <td><p>The list of return values of all calls to
   <code>func([policy, pid, **kwargs])</code>.</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>ray/rllib/evaluation/rollout_worker.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nd">@DeveloperAPI</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="k">def</span> <span class="nf">foreach_policy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>                   <span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Policy</span><span class="p">,</span> <span class="n">PolicyID</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">T</span><span class="p">],</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>                   <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">T</span><span class="p">]:</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a>    <span class="sd">&quot;&quot;&quot;Calls the given function with each (policy, policy_id) tuple.</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="sd">        func: The function to call with each (policy, policy ID) tuple.</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="sd">    Keyword Args:</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="sd">        kwargs: Additional kwargs to be passed to the call.</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="sd">         The list of return values of all calls to</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="sd">            `func([policy, pid, **kwargs])`.</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a>    <span class="k">return</span> <span class="p">[</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a>        <span class="n">func</span><span class="p">(</span><span class="n">policy</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a>        <span class="k">for</span> <span class="n">pid</span><span class="p">,</span> <span class="n">policy</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">policy_map</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a>    <span class="p">]</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="ray.rllib.evaluation.rollout_worker.RolloutWorker.foreach_trainable_policy">
<code class="highlight language-python"><span class="n">foreach_trainable_policy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Calls the given function with each (policy, policy_id) tuple.</p>
<p>Only those policies/IDs will be called on, which can be found in
<code>self.policies_to_train</code>.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>func</code></td>
        <td><code>Callable[[ray.rllib.policy.policy.Policy, str, Optional[Any]], ~T]</code></td>
        <td><p>The function to call with each (policy, policy ID) tuple,
for only those policies that are in <code>self.policies_to_train</code>.</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>List[~T]</code></td>
      <td><p>The list of return values of all calls to
<code>func([policy, pid, **kwargs])</code>.</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>ray/rllib/evaluation/rollout_worker.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nd">@DeveloperAPI</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="k">def</span> <span class="nf">foreach_trainable_policy</span><span class="p">(</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Policy</span><span class="p">,</span> <span class="n">PolicyID</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">T</span><span class="p">],</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>        <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">T</span><span class="p">]:</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a>    <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="sd">    Calls the given function with each (policy, policy_id) tuple.</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="sd">    Only those policies/IDs will be called on, which can be found in</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="sd">    `self.policies_to_train`.</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="sd">        func: The function to call with each (policy, policy ID) tuple,</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="sd">            for only those policies that are in `self.policies_to_train`.</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="sd">    Keyword Args:</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="sd">        kwargs: Additional kwargs to be passed to the call.</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="sd">        The list of return values of all calls to</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a><span class="sd">        `func([policy, pid, **kwargs])`.</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a>    <span class="k">return</span> <span class="p">[</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a>        <span class="n">func</span><span class="p">(</span><span class="n">policy</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a>        <span class="k">for</span> <span class="n">pid</span><span class="p">,</span> <span class="n">policy</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">policy_map</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a>        <span class="k">if</span> <span class="n">pid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">policies_to_train</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a>    <span class="p">]</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="ray.rllib.evaluation.rollout_worker.RolloutWorker.get_filters">
<code class="highlight language-python"><span class="n">get_filters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flush_after</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Returns a snapshot of filters.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>flush_after</code></td>
        <td><code>bool</code></td>
        <td><p>Clears the filter buffer state.</p></td>
        <td><code>False</code></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>Dict</code></td>
      <td><p>Dict for serializable filters</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>ray/rllib/evaluation/rollout_worker.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nd">@DeveloperAPI</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="k">def</span> <span class="nf">get_filters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flush_after</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>    <span class="sd">&quot;&quot;&quot;Returns a snapshot of filters.</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="sd">        flush_after: Clears the filter buffer state.</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="sd">        Dict for serializable filters</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a>    <span class="n">return_filters</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a>    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a>        <span class="n">return_filters</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">as_serializable</span><span class="p">()</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a>        <span class="k">if</span> <span class="n">flush_after</span><span class="p">:</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a>            <span class="n">f</span><span class="o">.</span><span class="n">clear_buffer</span><span class="p">()</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a>    <span class="k">return</span> <span class="n">return_filters</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="ray.rllib.evaluation.rollout_worker.RolloutWorker.get_global_vars">
<code class="highlight language-python"><span class="n">get_global_vars</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Returns the current global_vars dict of this worker.</p>

<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>dict</code></td>
      <td><p>The current global_vars dict of this worker.</p></td>
    </tr>
  </tbody>
</table>
<p><strong>Examples:</strong></p>
    <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="o">&gt;&gt;&gt;</span> <span class="n">global_vars</span> <span class="o">=</span> <span class="n">worker</span><span class="o">.</span><span class="n">get_global_vars</span><span class="p">()</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="o">&gt;&gt;&gt;</span> <span class="nb">print</span><span class="p">(</span><span class="n">global_vars</span><span class="p">)</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="p">{</span><span class="s2">&quot;timestep&quot;</span><span class="p">:</span> <span class="mi">424242</span><span class="p">}</span>
</code></pre></div>

        <details class="quote">
          <summary>Source code in <code>ray/rllib/evaluation/rollout_worker.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nd">@DeveloperAPI</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="k">def</span> <span class="nf">get_global_vars</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>    <span class="sd">&quot;&quot;&quot;Returns the current global_vars dict of this worker.</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="sd">        The current global_vars dict of this worker.</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="sd">    Examples:</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="sd">        &gt;&gt;&gt; global_vars = worker.get_global_vars()</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="sd">        &gt;&gt;&gt; print(global_vars)</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="sd">        {&quot;timestep&quot;: 424242}</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a>    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_vars</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="ray.rllib.evaluation.rollout_worker.RolloutWorker.get_host">
<code class="highlight language-python"><span class="n">get_host</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Returns the hostname of the process running this evaluator.</p>

        <details class="quote">
          <summary>Source code in <code>ray/rllib/evaluation/rollout_worker.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nd">@DeveloperAPI</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="k">def</span> <span class="nf">get_host</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>    <span class="sd">&quot;&quot;&quot;Returns the hostname of the process running this evaluator.&quot;&quot;&quot;</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>    <span class="k">return</span> <span class="n">platform</span><span class="o">.</span><span class="n">node</span><span class="p">()</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="ray.rllib.evaluation.rollout_worker.RolloutWorker.get_metrics">
<code class="highlight language-python"><span class="n">get_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Returns the thus-far collected metrics from this worker's rollouts.</p>

<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>List[Union[ray.rllib.evaluation.metrics.RolloutMetrics, ray.rllib.offline.off_policy_estimator.OffPolicyEstimate]]</code></td>
      <td><p>List of RolloutMetrics and/or OffPolicyEstimate objects
collected thus-far.</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>ray/rllib/evaluation/rollout_worker.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nd">@DeveloperAPI</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="k">def</span> <span class="nf">get_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">RolloutMetrics</span><span class="p">,</span> <span class="n">OffPolicyEstimate</span><span class="p">]]:</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>    <span class="sd">&quot;&quot;&quot;Returns the thus-far collected metrics from this worker&#39;s rollouts.</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="sd">         List of RolloutMetrics and/or OffPolicyEstimate objects</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="sd">         collected thus-far.</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a>    <span class="c1"># Get metrics from sampler (if any).</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sampler</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a>        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sampler</span><span class="o">.</span><span class="n">get_metrics</span><span class="p">()</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a>        <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a>    <span class="c1"># Get metrics from our reward-estimators (if any).</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a>    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">reward_estimators</span><span class="p">:</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a>        <span class="n">out</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">get_metrics</span><span class="p">())</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a>    <span class="k">return</span> <span class="n">out</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="ray.rllib.evaluation.rollout_worker.RolloutWorker.get_node_ip">
<code class="highlight language-python"><span class="n">get_node_ip</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Returns the IP address of the node that this worker runs on.</p>

        <details class="quote">
          <summary>Source code in <code>ray/rllib/evaluation/rollout_worker.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nd">@DeveloperAPI</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="k">def</span> <span class="nf">get_node_ip</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>    <span class="sd">&quot;&quot;&quot;Returns the IP address of the node that this worker runs on.&quot;&quot;&quot;</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>    <span class="k">return</span> <span class="n">ray</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">get_node_ip_address</span><span class="p">()</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="ray.rllib.evaluation.rollout_worker.RolloutWorker.get_policy">
<code class="highlight language-python"><span class="n">get_policy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">policy_id</span><span class="o">=</span><span class="s1">&#39;default_policy&#39;</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Return policy for the specified id, or None.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>policy_id</code></td>
        <td><code>str</code></td>
        <td><p>ID of the policy to return. None for DEFAULT_POLICY_ID
(in the single agent case).</p></td>
        <td><code>&#39;default_policy&#39;</code></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>Optional[ray.rllib.policy.policy.Policy]</code></td>
      <td><p>The policy under the given ID (or None if not found).</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>ray/rllib/evaluation/rollout_worker.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nd">@DeveloperAPI</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="k">def</span> <span class="nf">get_policy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">policy_id</span><span class="p">:</span> <span class="n">PolicyID</span> <span class="o">=</span> <span class="n">DEFAULT_POLICY_ID</span><span class="p">)</span> <span class="o">-&gt;</span> \
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>        <span class="n">Optional</span><span class="p">[</span><span class="n">Policy</span><span class="p">]:</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>    <span class="sd">&quot;&quot;&quot;Return policy for the specified id, or None.</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="sd">        policy_id: ID of the policy to return. None for DEFAULT_POLICY_ID</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="sd">            (in the single agent case).</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="sd">        The policy under the given ID (or None if not found).</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a>    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">policy_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">policy_id</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="ray.rllib.evaluation.rollout_worker.RolloutWorker.get_weights">
<code class="highlight language-python"><span class="n">get_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">policies</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Returns each policies' model weights of this worker.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>policies</code></td>
        <td><code>Optional[List[str]]</code></td>
        <td><p>List of PolicyIDs to get the weights from.
Use None for all policies.</p></td>
        <td><code>None</code></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>Dict[str, dict]</code></td>
      <td><p>Dict mapping PolicyIDs to ModelWeights.</p></td>
    </tr>
  </tbody>
</table>
<p><strong>Examples:</strong></p>
    <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="o">&gt;&gt;&gt;</span> <span class="n">weights</span> <span class="o">=</span> <span class="n">worker</span><span class="o">.</span><span class="n">get_weights</span><span class="p">()</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="o">&gt;&gt;&gt;</span> <span class="nb">print</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="p">{</span><span class="s2">&quot;default_policy&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;layer1&quot;</span><span class="p">:</span> <span class="n">array</span><span class="p">(</span><span class="o">...</span><span class="p">),</span> <span class="s2">&quot;layer2&quot;</span><span class="p">:</span> <span class="o">...</span><span class="p">}}</span>
</code></pre></div>

        <details class="quote">
          <summary>Source code in <code>ray/rllib/evaluation/rollout_worker.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nd">@DeveloperAPI</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="k">def</span> <span class="nf">get_weights</span><span class="p">(</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>        <span class="n">policies</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">PolicyID</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="n">PolicyID</span><span class="p">,</span> <span class="n">ModelWeights</span><span class="p">]:</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a>    <span class="sd">&quot;&quot;&quot;Returns each policies&#39; model weights of this worker.</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="sd">        policies: List of PolicyIDs to get the weights from.</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="sd">            Use None for all policies.</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="sd">        Dict mapping PolicyIDs to ModelWeights.</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="sd">    Examples:</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="sd">        &gt;&gt;&gt; weights = worker.get_weights()</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="sd">        &gt;&gt;&gt; print(weights)</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="sd">        {&quot;default_policy&quot;: {&quot;layer1&quot;: array(...), &quot;layer2&quot;: ...}}</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a>    <span class="k">if</span> <span class="n">policies</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a>        <span class="n">policies</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">policy_map</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a>    <span class="n">policies</span> <span class="o">=</span> <span class="n">force_list</span><span class="p">(</span><span class="n">policies</span><span class="p">)</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a>    <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a>        <span class="n">pid</span><span class="p">:</span> <span class="n">policy</span><span class="o">.</span><span class="n">get_weights</span><span class="p">()</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a>        <span class="k">for</span> <span class="n">pid</span><span class="p">,</span> <span class="n">policy</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">policy_map</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">pid</span> <span class="ow">in</span> <span class="n">policies</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a>    <span class="p">}</span>
</code></pre></div>
        </details>
    </div>

  </div>




  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="ray.rllib.evaluation.rollout_worker.RolloutWorker.learn_on_batch">
<code class="highlight language-python"><span class="n">learn_on_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">samples</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Update policies based on the given batch.</p>
<p>This is the equivalent to apply_gradients(compute_gradients(samples)),
but can be optimized to avoid pulling gradients into CPU memory.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>samples</code></td>
        <td><code>Union[SampleBatch, MultiAgentBatch]</code></td>
        <td><p>The SampleBatch or MultiAgentBatch to learn on.</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>Dict</code></td>
      <td><p>Dictionary of extra metadata from compute_gradients().</p></td>
    </tr>
  </tbody>
</table>
<p><strong>Examples:</strong></p>
    <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="o">&gt;&gt;&gt;</span> <span class="n">batch</span> <span class="o">=</span> <span class="n">worker</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="o">&gt;&gt;&gt;</span> <span class="n">info</span> <span class="o">=</span> <span class="n">worker</span><span class="o">.</span><span class="n">learn_on_batch</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>
</code></pre></div>

        <details class="quote">
          <summary>Source code in <code>ray/rllib/evaluation/rollout_worker.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nd">@DeveloperAPI</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="k">def</span> <span class="nf">learn_on_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">samples</span><span class="p">:</span> <span class="n">SampleBatchType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>    <span class="sd">&quot;&quot;&quot;Update policies based on the given batch.</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="sd">    This is the equivalent to apply_gradients(compute_gradients(samples)),</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="sd">    but can be optimized to avoid pulling gradients into CPU memory.</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="sd">        samples: The SampleBatch or MultiAgentBatch to learn on.</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="sd">        Dictionary of extra metadata from compute_gradients().</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="sd">    Examples:</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="sd">        &gt;&gt;&gt; batch = worker.sample()</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="sd">        &gt;&gt;&gt; info = worker.learn_on_batch(samples)</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a>    <span class="k">if</span> <span class="n">log_once</span><span class="p">(</span><span class="s2">&quot;learn_on_batch&quot;</span><span class="p">):</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a>            <span class="s2">&quot;Training on concatenated sample batches:</span><span class="se">\n\n</span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a>                <span class="n">summarize</span><span class="p">(</span><span class="n">samples</span><span class="p">)))</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">MultiAgentBatch</span><span class="p">):</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a>        <span class="n">info_out</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a>        <span class="n">builders</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a>        <span class="n">to_fetch</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a>        <span class="k">for</span> <span class="n">pid</span><span class="p">,</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">samples</span><span class="o">.</span><span class="n">policy_batches</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a>            <span class="k">if</span> <span class="n">pid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">policies_to_train</span><span class="p">:</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a>                <span class="k">continue</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a>            <span class="c1"># Decompress SampleBatch, in case some columns are compressed.</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a>            <span class="n">batch</span><span class="o">.</span><span class="n">decompress_if_needed</span><span class="p">()</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a>            <span class="n">policy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">policy_map</span><span class="p">[</span><span class="n">pid</span><span class="p">]</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a>            <span class="n">tf_session</span> <span class="o">=</span> <span class="n">policy</span><span class="o">.</span><span class="n">get_session</span><span class="p">()</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a>            <span class="k">if</span> <span class="n">tf_session</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">policy</span><span class="p">,</span> <span class="s2">&quot;_build_learn_on_batch&quot;</span><span class="p">):</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a>                <span class="n">builders</span><span class="p">[</span><span class="n">pid</span><span class="p">]</span> <span class="o">=</span> <span class="n">TFRunBuilder</span><span class="p">(</span><span class="n">tf_session</span><span class="p">,</span> <span class="s2">&quot;learn_on_batch&quot;</span><span class="p">)</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a>                <span class="n">to_fetch</span><span class="p">[</span><span class="n">pid</span><span class="p">]</span> <span class="o">=</span> <span class="n">policy</span><span class="o">.</span><span class="n">_build_learn_on_batch</span><span class="p">(</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a>                    <span class="n">builders</span><span class="p">[</span><span class="n">pid</span><span class="p">],</span> <span class="n">batch</span><span class="p">)</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a>                <span class="n">info_out</span><span class="p">[</span><span class="n">pid</span><span class="p">]</span> <span class="o">=</span> <span class="n">policy</span><span class="o">.</span><span class="n">learn_on_batch</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a>        <span class="n">info_out</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a>            <span class="p">{</span><span class="n">pid</span><span class="p">:</span> <span class="n">builders</span><span class="p">[</span><span class="n">pid</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>             <span class="k">for</span> <span class="n">pid</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">to_fetch</span><span class="o">.</span><span class="n">items</span><span class="p">()})</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>        <span class="n">info_out</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>            <span class="n">DEFAULT_POLICY_ID</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">policy_map</span><span class="p">[</span><span class="n">DEFAULT_POLICY_ID</span><span class="p">]</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>            <span class="o">.</span><span class="n">learn_on_batch</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>        <span class="p">}</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>    <span class="k">if</span> <span class="n">log_once</span><span class="p">(</span><span class="s2">&quot;learn_out&quot;</span><span class="p">):</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Training out:</span><span class="se">\n\n</span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">summarize</span><span class="p">(</span><span class="n">info_out</span><span class="p">)))</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>    <span class="k">return</span> <span class="n">info_out</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="ray.rllib.evaluation.rollout_worker.RolloutWorker.remove_policy">
<code class="highlight language-python"><span class="n">remove_policy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">policy_id</span><span class="o">=</span><span class="s1">&#39;default_policy&#39;</span><span class="p">,</span> <span class="n">policy_mapping_fn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">policies_to_train</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Removes a policy from this RolloutWorker.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>policy_id</code></td>
        <td><code>str</code></td>
        <td><p>ID of the policy to be removed. None for
DEFAULT_POLICY_ID.</p></td>
        <td><code>&#39;default_policy&#39;</code></td>
      </tr>
      <tr>
        <td><code>policy_mapping_fn</code></td>
        <td><code>Optional[Callable[[Any], str]]</code></td>
        <td><p>An optional (updated) policy mapping function
to use from here on. Note that already ongoing episodes will
not change their mapping but will use the old mapping till
the end of the episode.</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>policies_to_train</code></td>
        <td><code>Optional[List[str]]</code></td>
        <td><p>An optional list of policy IDs to be trained.
If None, will keep the existing list in place. Policies,
whose IDs are not in the list will not be updated.</p></td>
        <td><code>None</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>ray/rllib/evaluation/rollout_worker.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nd">@DeveloperAPI</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="k">def</span> <span class="nf">remove_policy</span><span class="p">(</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>        <span class="o">*</span><span class="p">,</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a>        <span class="n">policy_id</span><span class="p">:</span> <span class="n">PolicyID</span> <span class="o">=</span> <span class="n">DEFAULT_POLICY_ID</span><span class="p">,</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a>        <span class="n">policy_mapping_fn</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">AgentID</span><span class="p">],</span> <span class="n">PolicyID</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a>        <span class="n">policies_to_train</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">PolicyID</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a>    <span class="sd">&quot;&quot;&quot;Removes a policy from this RolloutWorker.</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="sd">        policy_id: ID of the policy to be removed. None for</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="sd">            DEFAULT_POLICY_ID.</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="sd">        policy_mapping_fn: An optional (updated) policy mapping function</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="sd">            to use from here on. Note that already ongoing episodes will</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="sd">            not change their mapping but will use the old mapping till</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="sd">            the end of the episode.</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="sd">        policies_to_train: An optional list of policy IDs to be trained.</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="sd">            If None, will keep the existing list in place. Policies,</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="sd">            whose IDs are not in the list will not be updated.</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a>    <span class="k">if</span> <span class="n">policy_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">policy_map</span><span class="p">:</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Policy ID &#39;</span><span class="si">{</span><span class="n">policy_id</span><span class="si">}</span><span class="s2">&#39; not in policy map!&quot;</span><span class="p">)</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a>    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">policy_map</span><span class="p">[</span><span class="n">policy_id</span><span class="p">]</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a>    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocessors</span><span class="p">[</span><span class="n">policy_id</span><span class="p">]</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">set_policy_mapping_fn</span><span class="p">(</span><span class="n">policy_mapping_fn</span><span class="p">)</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">set_policies_to_train</span><span class="p">(</span><span class="n">policies_to_train</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="ray.rllib.evaluation.rollout_worker.RolloutWorker.restore">
<code class="highlight language-python"><span class="n">restore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">objs</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Restores this RolloutWorker's state from a sequence of bytes.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>objs</code></td>
        <td><code>bytes</code></td>
        <td><p>The byte sequence to restore this worker's state from.</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
<p><strong>Examples:</strong></p>
    <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="o">&gt;&gt;&gt;</span> <span class="n">state</span> <span class="o">=</span> <span class="n">worker</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="o">&gt;&gt;&gt;</span> <span class="n">new_worker</span> <span class="o">=</span> <span class="n">RolloutWorker</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="o">&gt;&gt;&gt;</span> <span class="n">new_worker</span><span class="o">.</span><span class="n">restore</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</code></pre></div>

        <details class="quote">
          <summary>Source code in <code>ray/rllib/evaluation/rollout_worker.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nd">@DeveloperAPI</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="k">def</span> <span class="nf">restore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">objs</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>    <span class="sd">&quot;&quot;&quot;Restores this RolloutWorker&#39;s state from a sequence of bytes.</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="sd">        objs: The byte sequence to restore this worker&#39;s state from.</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="sd">    Examples:</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="sd">        &gt;&gt;&gt; state = worker.save()</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="sd">        &gt;&gt;&gt; new_worker = RolloutWorker(...)</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="sd">        &gt;&gt;&gt; new_worker.restore(state)</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a>    <span class="n">objs</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">objs</span><span class="p">)</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">sync_filters</span><span class="p">(</span><span class="n">objs</span><span class="p">[</span><span class="s2">&quot;filters&quot;</span><span class="p">])</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a>    <span class="k">for</span> <span class="n">pid</span><span class="p">,</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">objs</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a>        <span class="k">if</span> <span class="n">pid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">policy_map</span><span class="p">:</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a>            <span class="n">pol_spec</span> <span class="o">=</span> <span class="n">objs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;policy_specs&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">pol_spec</span><span class="p">:</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a>                    <span class="sa">f</span><span class="s2">&quot;PolicyID &#39;</span><span class="si">{</span><span class="n">pid</span><span class="si">}</span><span class="s2">&#39; was probably added on-the-fly (not&quot;</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a>                    <span class="s2">&quot; part of the static `multagent.policies` config) and&quot;</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a>                    <span class="s2">&quot; no PolicySpec objects found in the pickled policy &quot;</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a>                    <span class="s2">&quot;state. Will not add `</span><span class="si">{pid}</span><span class="s2">`, but ignore it for now.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">add_policy</span><span class="p">(</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a>                    <span class="n">policy_id</span><span class="o">=</span><span class="n">pid</span><span class="p">,</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a>                    <span class="n">policy_cls</span><span class="o">=</span><span class="n">pol_spec</span><span class="o">.</span><span class="n">policy_class</span><span class="p">,</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a>                    <span class="n">observation_space</span><span class="o">=</span><span class="n">pol_spec</span><span class="o">.</span><span class="n">observation_space</span><span class="p">,</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a>                    <span class="n">action_space</span><span class="o">=</span><span class="n">pol_spec</span><span class="o">.</span><span class="n">action_space</span><span class="p">,</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a>                    <span class="n">config</span><span class="o">=</span><span class="n">pol_spec</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a>                <span class="p">)</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">policy_map</span><span class="p">[</span><span class="n">pid</span><span class="p">]</span><span class="o">.</span><span class="n">set_state</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="ray.rllib.evaluation.rollout_worker.RolloutWorker.sample">
<code class="highlight language-python"><span class="n">sample</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Returns a batch of experience sampled from this worker.</p>
<p>This method must be implemented by subclasses.</p>

<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>Union[SampleBatch, MultiAgentBatch]</code></td>
      <td><p>A columnar batch of experiences (e.g., tensors).</p></td>
    </tr>
  </tbody>
</table>
<p><strong>Examples:</strong></p>
    <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="o">&gt;&gt;&gt;</span> <span class="nb">print</span><span class="p">(</span><span class="n">worker</span><span class="o">.</span><span class="n">sample</span><span class="p">())</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="n">SampleBatch</span><span class="p">({</span><span class="s2">&quot;obs&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="o">...</span><span class="p">})</span>
</code></pre></div>

        <details class="quote">
          <summary>Source code in <code>ray/rllib/evaluation/rollout_worker.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nd">@DeveloperAPI</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="k">def</span> <span class="nf">sample</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SampleBatchType</span><span class="p">:</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>    <span class="sd">&quot;&quot;&quot;Returns a batch of experience sampled from this worker.</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="sd">    This method must be implemented by subclasses.</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="sd">        A columnar batch of experiences (e.g., tensors).</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="sd">    Examples:</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="sd">        &gt;&gt;&gt; print(worker.sample())</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="sd">        SampleBatch({&quot;obs&quot;: [1, 2, 3], &quot;action&quot;: [0, 1, 0], ...})</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fake_sampler</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_batch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_batch</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a>    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_reader</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;RolloutWorker has no `input_reader` object! &quot;</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a>                         <span class="s2">&quot;Cannot call `sample()`. You can try setting &quot;</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a>                         <span class="s2">&quot;`create_env_on_driver` to True.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a>    <span class="k">if</span> <span class="n">log_once</span><span class="p">(</span><span class="s2">&quot;sample_start&quot;</span><span class="p">):</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Generating sample batch of size </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">rollout_fragment_length</span><span class="p">))</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a>    <span class="n">batches</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">input_reader</span><span class="o">.</span><span class="n">next</span><span class="p">()]</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a>    <span class="n">steps_so_far</span> <span class="o">=</span> <span class="n">batches</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">count</span> <span class="k">if</span> \
<a id="__codelineno-0-28" name="__codelineno-0-28"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">count_steps_by</span> <span class="o">==</span> <span class="s2">&quot;env_steps&quot;</span> <span class="k">else</span> \
<a id="__codelineno-0-29" name="__codelineno-0-29"></a>        <span class="n">batches</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">agent_steps</span><span class="p">()</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a>    <span class="c1"># In truncate_episodes mode, never pull more than 1 batch per env.</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a>    <span class="c1"># This avoids over-running the target batch size.</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_mode</span> <span class="o">==</span> <span class="s2">&quot;truncate_episodes&quot;</span><span class="p">:</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a>        <span class="n">max_batches</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_envs</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a>        <span class="n">max_batches</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">)</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a>    <span class="k">while</span> <span class="p">(</span><span class="n">steps_so_far</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">rollout_fragment_length</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a>           <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">batches</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">max_batches</span><span class="p">):</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a>        <span class="n">batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_reader</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>        <span class="n">steps_so_far</span> <span class="o">+=</span> <span class="n">batch</span><span class="o">.</span><span class="n">count</span> <span class="k">if</span> \
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">count_steps_by</span> <span class="o">==</span> <span class="s2">&quot;env_steps&quot;</span> <span class="k">else</span> \
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>            <span class="n">batch</span><span class="o">.</span><span class="n">agent_steps</span><span class="p">()</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>        <span class="n">batches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>    <span class="n">batch</span> <span class="o">=</span> <span class="n">batches</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">concat_samples</span><span class="p">(</span><span class="n">batches</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">batches</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> \
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>        <span class="n">batches</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">on_sample_end</span><span class="p">(</span><span class="n">worker</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">samples</span><span class="o">=</span><span class="n">batch</span><span class="p">)</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>    <span class="c1"># Always do writes prior to compression for consistency and to allow</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>    <span class="c1"># for better compression inside the writer.</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">output_writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>    <span class="c1"># Do off-policy estimation, if needed.</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reward_estimators</span><span class="p">:</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>        <span class="k">for</span> <span class="n">sub_batch</span> <span class="ow">in</span> <span class="n">batch</span><span class="o">.</span><span class="n">split_by_episode</span><span class="p">():</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>            <span class="k">for</span> <span class="n">estimator</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">reward_estimators</span><span class="p">:</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>                <span class="n">estimator</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">sub_batch</span><span class="p">)</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>    <span class="k">if</span> <span class="n">log_once</span><span class="p">(</span><span class="s2">&quot;sample_end&quot;</span><span class="p">):</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Completed sample batch:</span><span class="se">\n\n</span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>            <span class="n">summarize</span><span class="p">(</span><span class="n">batch</span><span class="p">)))</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compress_observations</span><span class="p">:</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>        <span class="n">batch</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">bulk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">compress_observations</span> <span class="o">==</span> <span class="s2">&quot;bulk&quot;</span><span class="p">)</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fake_sampler</span><span class="p">:</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">last_batch</span> <span class="o">=</span> <span class="n">batch</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>    <span class="k">return</span> <span class="n">batch</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="ray.rllib.evaluation.rollout_worker.RolloutWorker.sample_and_learn">
<code class="highlight language-python"><span class="n">sample_and_learn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expected_batch_size</span><span class="p">,</span> <span class="n">num_sgd_iter</span><span class="p">,</span> <span class="n">sgd_minibatch_size</span><span class="p">,</span> <span class="n">standardize_fields</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Sample and batch and learn on it.</p>
<p>This is typically used in combination with distributed allreduce.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>expected_batch_size</code></td>
        <td><code>int</code></td>
        <td><p>Expected number of samples to learn on.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>num_sgd_iter</code></td>
        <td><code>int</code></td>
        <td><p>Number of SGD iterations.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>sgd_minibatch_size</code></td>
        <td><code>str</code></td>
        <td><p>SGD minibatch size.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>standardize_fields</code></td>
        <td><code>List[str]</code></td>
        <td><p>List of sample fields to normalize.</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>Tuple[dict, int]</code></td>
      <td><p>A tuple consisting of a dictionary of extra metadata returned from
    the policies' <code>learn_on_batch()</code> and the number of samples
    learned on.</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>ray/rllib/evaluation/rollout_worker.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="k">def</span> <span class="nf">sample_and_learn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expected_batch_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">num_sgd_iter</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a>                     <span class="n">sgd_minibatch_size</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>                     <span class="n">standardize_fields</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>    <span class="sd">&quot;&quot;&quot;Sample and batch and learn on it.</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="sd">    This is typically used in combination with distributed allreduce.</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="sd">        expected_batch_size: Expected number of samples to learn on.</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="sd">        num_sgd_iter: Number of SGD iterations.</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="sd">        sgd_minibatch_size: SGD minibatch size.</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="sd">        standardize_fields: List of sample fields to normalize.</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="sd">        A tuple consisting of a dictionary of extra metadata returned from</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="sd">            the policies&#39; `learn_on_batch()` and the number of samples</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="sd">            learned on.</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a>    <span class="n">batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a>    <span class="k">assert</span> <span class="n">batch</span><span class="o">.</span><span class="n">count</span> <span class="o">==</span> <span class="n">expected_batch_size</span><span class="p">,</span> \
<a id="__codelineno-0-21" name="__codelineno-0-21"></a>        <span class="p">(</span><span class="s2">&quot;Batch size possibly out of sync between workers, expected:&quot;</span><span class="p">,</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a>         <span class="n">expected_batch_size</span><span class="p">,</span> <span class="s2">&quot;got:&quot;</span><span class="p">,</span> <span class="n">batch</span><span class="o">.</span><span class="n">count</span><span class="p">)</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Executing distributed minibatch SGD &quot;</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a>                <span class="s2">&quot;with epoch size </span><span class="si">{}</span><span class="s2">, minibatch size </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a>                    <span class="n">batch</span><span class="o">.</span><span class="n">count</span><span class="p">,</span> <span class="n">sgd_minibatch_size</span><span class="p">))</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a>    <span class="n">info</span> <span class="o">=</span> <span class="n">do_minibatch_sgd</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">policy_map</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">num_sgd_iter</span><span class="p">,</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a>                            <span class="n">sgd_minibatch_size</span><span class="p">,</span> <span class="n">standardize_fields</span><span class="p">)</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a>    <span class="k">return</span> <span class="n">info</span><span class="p">,</span> <span class="n">batch</span><span class="o">.</span><span class="n">count</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="ray.rllib.evaluation.rollout_worker.RolloutWorker.sample_with_count">
<code class="highlight language-python"><span class="n">sample_with_count</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Same as sample() but returns the count as a separate value.</p>

<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>Tuple[Union[SampleBatch, MultiAgentBatch], int]</code></td>
      <td><p>A columnar batch of experiences (e.g., tensors) and the
    size of the collected batch.</p></td>
    </tr>
  </tbody>
</table>
<p><strong>Examples:</strong></p>
    <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="o">&gt;&gt;&gt;</span> <span class="nb">print</span><span class="p">(</span><span class="n">worker</span><span class="o">.</span><span class="n">sample_with_count</span><span class="p">())</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="p">(</span><span class="n">SampleBatch</span><span class="p">({</span><span class="s2">&quot;obs&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="o">...</span><span class="p">}),</span> <span class="mi">3</span><span class="p">)</span>
</code></pre></div>

        <details class="quote">
          <summary>Source code in <code>ray/rllib/evaluation/rollout_worker.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nd">@DeveloperAPI</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="nd">@ray</span><span class="o">.</span><span class="n">method</span><span class="p">(</span><span class="n">num_returns</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="k">def</span> <span class="nf">sample_with_count</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">SampleBatchType</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>    <span class="sd">&quot;&quot;&quot;Same as sample() but returns the count as a separate value.</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="sd">        A columnar batch of experiences (e.g., tensors) and the</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="sd">            size of the collected batch.</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="sd">    Examples:</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="sd">        &gt;&gt;&gt; print(worker.sample_with_count())</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="sd">        (SampleBatch({&quot;obs&quot;: [1, 2, 3], &quot;action&quot;: [0, 1, 0], ...}), 3)</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a>    <span class="n">batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a>    <span class="k">return</span> <span class="n">batch</span><span class="p">,</span> <span class="n">batch</span><span class="o">.</span><span class="n">count</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="ray.rllib.evaluation.rollout_worker.RolloutWorker.save">
<code class="highlight language-python"><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Serializes this RolloutWorker's current state and returns it.</p>

<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>bytes</code></td>
      <td><p>The current state of this RolloutWorker as a serialized, pickled
byte sequence.</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>ray/rllib/evaluation/rollout_worker.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nd">@DeveloperAPI</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>    <span class="sd">&quot;&quot;&quot;Serializes this RolloutWorker&#39;s current state and returns it.</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="sd">        The current state of this RolloutWorker as a serialized, pickled</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="sd">        byte sequence.</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a>    <span class="n">filters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_filters</span><span class="p">(</span><span class="n">flush_after</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a>    <span class="n">state</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a>    <span class="n">policy_specs</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a>    <span class="k">for</span> <span class="n">pid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">policy_map</span><span class="p">:</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a>        <span class="n">state</span><span class="p">[</span><span class="n">pid</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">policy_map</span><span class="p">[</span><span class="n">pid</span><span class="p">]</span><span class="o">.</span><span class="n">get_state</span><span class="p">()</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a>        <span class="n">policy_specs</span><span class="p">[</span><span class="n">pid</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">policy_map</span><span class="o">.</span><span class="n">policy_specs</span><span class="p">[</span><span class="n">pid</span><span class="p">]</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a>    <span class="k">return</span> <span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a>        <span class="s2">&quot;filters&quot;</span><span class="p">:</span> <span class="n">filters</span><span class="p">,</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a>        <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="n">state</span><span class="p">,</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a>        <span class="s2">&quot;policy_specs&quot;</span><span class="p">:</span> <span class="n">policy_specs</span><span class="p">,</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a>    <span class="p">})</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="ray.rllib.evaluation.rollout_worker.RolloutWorker.set_global_vars">
<code class="highlight language-python"><span class="n">set_global_vars</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">global_vars</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Updates this worker's and all its policies' global vars.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>global_vars</code></td>
        <td><code>dict</code></td>
        <td><p>The new global_vars dict.</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
<p><strong>Examples:</strong></p>
    <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="o">&gt;&gt;&gt;</span> <span class="n">global_vars</span> <span class="o">=</span> <span class="n">worker</span><span class="o">.</span><span class="n">set_global_vars</span><span class="p">({</span><span class="s2">&quot;timestep&quot;</span><span class="p">:</span> <span class="mi">4242</span><span class="p">})</span>
</code></pre></div>

        <details class="quote">
          <summary>Source code in <code>ray/rllib/evaluation/rollout_worker.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nd">@DeveloperAPI</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="k">def</span> <span class="nf">set_global_vars</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">global_vars</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>    <span class="sd">&quot;&quot;&quot;Updates this worker&#39;s and all its policies&#39; global vars.</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="sd">        global_vars: The new global_vars dict.</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="sd">    Examples:</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="sd">        &gt;&gt;&gt; global_vars = worker.set_global_vars({&quot;timestep&quot;: 4242})</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">foreach_policy</span><span class="p">(</span><span class="k">lambda</span> <span class="n">p</span><span class="p">,</span> <span class="n">_</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">on_global_var_update</span><span class="p">(</span><span class="n">global_vars</span><span class="p">))</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">global_vars</span> <span class="o">=</span> <span class="n">global_vars</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="ray.rllib.evaluation.rollout_worker.RolloutWorker.set_policies_to_train">
<code class="highlight language-python"><span class="n">set_policies_to_train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">policies_to_train</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Sets <code>self.policies_to_train</code> to a new list of PolicyIDs.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>policies_to_train</code></td>
        <td><code>Optional[List[str]]</code></td>
        <td><p>The new list of policy IDs to train with.
If None, will keep the existing list in place.</p></td>
        <td><code>None</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>ray/rllib/evaluation/rollout_worker.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nd">@DeveloperAPI</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="k">def</span> <span class="nf">set_policies_to_train</span><span class="p">(</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">policies_to_train</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">PolicyID</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>    <span class="sd">&quot;&quot;&quot;Sets `self.policies_to_train` to a new list of PolicyIDs.</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="sd">        policies_to_train: The new list of policy IDs to train with.</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="sd">            If None, will keep the existing list in place.</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a>    <span class="k">if</span> <span class="n">policies_to_train</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">policies_to_train</span> <span class="o">=</span> <span class="n">policies_to_train</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="ray.rllib.evaluation.rollout_worker.RolloutWorker.set_policy_mapping_fn">
<code class="highlight language-python"><span class="n">set_policy_mapping_fn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">policy_mapping_fn</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Sets <code>self.policy_mapping_fn</code> to a new callable (if provided).</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>policy_mapping_fn</code></td>
        <td><code>Optional[Callable[[Any, Episode], str]]</code></td>
        <td><p>The new mapping function to use. If None,
will keep the existing mapping function in place.</p></td>
        <td><code>None</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>ray/rllib/evaluation/rollout_worker.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nd">@DeveloperAPI</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="k">def</span> <span class="nf">set_policy_mapping_fn</span><span class="p">(</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>        <span class="n">policy_mapping_fn</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">AgentID</span><span class="p">,</span> <span class="s2">&quot;Episode&quot;</span><span class="p">],</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a>                                             <span class="n">PolicyID</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a>    <span class="sd">&quot;&quot;&quot;Sets `self.policy_mapping_fn` to a new callable (if provided).</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="sd">        policy_mapping_fn: The new mapping function to use. If None,</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="sd">            will keep the existing mapping function in place.</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a>    <span class="k">if</span> <span class="n">policy_mapping_fn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">policy_mapping_fn</span> <span class="o">=</span> <span class="n">policy_mapping_fn</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">callable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">policy_mapping_fn</span><span class="p">):</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;`policy_mapping_fn` must be a callable!&quot;</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="ray.rllib.evaluation.rollout_worker.RolloutWorker.set_weights">
<code class="highlight language-python"><span class="n">set_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">global_vars</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Sets each policies' model weights of this worker.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>weights</code></td>
        <td><code>Dict[str, dict]</code></td>
        <td><p>Dict mapping PolicyIDs to the new weights to be used.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>global_vars</code></td>
        <td><code>Optional[Dict]</code></td>
        <td><p>An optional global vars dict to set this
worker to. If None, do not update the global_vars.</p></td>
        <td><code>None</code></td>
      </tr>
  </tbody>
</table>
<p><strong>Examples:</strong></p>
    <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="o">&gt;&gt;&gt;</span> <span class="n">weights</span> <span class="o">=</span> <span class="n">worker</span><span class="o">.</span><span class="n">get_weights</span><span class="p">()</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="o">&gt;&gt;&gt;</span> <span class="c1"># Set `global_vars` (timestep) as well.</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="o">&gt;&gt;&gt;</span> <span class="n">worker</span><span class="o">.</span><span class="n">set_weights</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;timestep&quot;</span><span class="p">:</span> <span class="mi">42</span><span class="p">})</span>
</code></pre></div>

        <details class="quote">
          <summary>Source code in <code>ray/rllib/evaluation/rollout_worker.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nd">@DeveloperAPI</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="k">def</span> <span class="nf">set_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>                <span class="n">weights</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">PolicyID</span><span class="p">,</span> <span class="n">ModelWeights</span><span class="p">],</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>                <span class="n">global_vars</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a>    <span class="sd">&quot;&quot;&quot;Sets each policies&#39; model weights of this worker.</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="sd">        weights: Dict mapping PolicyIDs to the new weights to be used.</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="sd">        global_vars: An optional global vars dict to set this</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="sd">            worker to. If None, do not update the global_vars.</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="sd">    Examples:</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="sd">        &gt;&gt;&gt; weights = worker.get_weights()</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="sd">        &gt;&gt;&gt; # Set `global_vars` (timestep) as well.</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="sd">        &gt;&gt;&gt; worker.set_weights(weights, {&quot;timestep&quot;: 42})</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a>    <span class="k">for</span> <span class="n">pid</span><span class="p">,</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">weights</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">policy_map</span><span class="p">[</span><span class="n">pid</span><span class="p">]</span><span class="o">.</span><span class="n">set_weights</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a>    <span class="k">if</span> <span class="n">global_vars</span><span class="p">:</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">set_global_vars</span><span class="p">(</span><span class="n">global_vars</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="ray.rllib.evaluation.rollout_worker.RolloutWorker.setup_torch_data_parallel">
<code class="highlight language-python"><span class="n">setup_torch_data_parallel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">world_rank</span><span class="p">,</span> <span class="n">world_size</span><span class="p">,</span> <span class="n">backend</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Join a torch process group for distributed SGD.</p>

        <details class="quote">
          <summary>Source code in <code>ray/rllib/evaluation/rollout_worker.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="k">def</span> <span class="nf">setup_torch_data_parallel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">world_rank</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a>                              <span class="n">world_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">backend</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>    <span class="sd">&quot;&quot;&quot;Join a torch process group for distributed SGD.&quot;&quot;&quot;</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Joining process group, url=</span><span class="si">{}</span><span class="s2">, world_rank=</span><span class="si">{}</span><span class="s2">, &quot;</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a>                <span class="s2">&quot;world_size=</span><span class="si">{}</span><span class="s2">, backend=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">world_rank</span><span class="p">,</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a>                                                   <span class="n">world_size</span><span class="p">,</span> <span class="n">backend</span><span class="p">))</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a>    <span class="n">torch</span><span class="o">.</span><span class="n">distributed</span><span class="o">.</span><span class="n">init_process_group</span><span class="p">(</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a>        <span class="n">backend</span><span class="o">=</span><span class="n">backend</span><span class="p">,</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a>        <span class="n">init_method</span><span class="o">=</span><span class="n">url</span><span class="p">,</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a>        <span class="n">rank</span><span class="o">=</span><span class="n">world_rank</span><span class="p">,</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a>        <span class="n">world_size</span><span class="o">=</span><span class="n">world_size</span><span class="p">)</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a>    <span class="k">for</span> <span class="n">pid</span><span class="p">,</span> <span class="n">policy</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">policy_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">policy</span><span class="p">,</span> <span class="n">TorchPolicy</span><span class="p">):</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a>                <span class="s2">&quot;This policy does not support torch distributed&quot;</span><span class="p">,</span> <span class="n">policy</span><span class="p">)</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a>        <span class="n">policy</span><span class="o">.</span><span class="n">distributed_world_size</span> <span class="o">=</span> <span class="n">world_size</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="ray.rllib.evaluation.rollout_worker.RolloutWorker.stop">
<code class="highlight language-python"><span class="n">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Releases all resources used by this RolloutWorker.</p>

        <details class="quote">
          <summary>Source code in <code>ray/rllib/evaluation/rollout_worker.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nd">@DeveloperAPI</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>    <span class="sd">&quot;&quot;&quot;Releases all resources used by this RolloutWorker.&quot;&quot;&quot;</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a>    <span class="c1"># If we have an env -&gt; Release its resources.</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">async_env</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a>    <span class="c1"># Close all policies&#39; sessions (if tf static graph).</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a>    <span class="k">for</span> <span class="n">policy</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">policy_map</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a>        <span class="n">sess</span> <span class="o">=</span> <span class="n">policy</span><span class="o">.</span><span class="n">get_session</span><span class="p">()</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a>        <span class="c1"># Closes the tf session, if any.</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a>        <span class="k">if</span> <span class="n">sess</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a>            <span class="n">sess</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="ray.rllib.evaluation.rollout_worker.RolloutWorker.sync_filters">
<code class="highlight language-python"><span class="n">sync_filters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_filters</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Changes self's filter to given and rebases any accumulated delta.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>new_filters</code></td>
        <td><code>dict</code></td>
        <td><p>Filters with new state to update local copy.</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>ray/rllib/evaluation/rollout_worker.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nd">@DeveloperAPI</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="k">def</span> <span class="nf">sync_filters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_filters</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>    <span class="sd">&quot;&quot;&quot;Changes self&#39;s filter to given and rebases any accumulated delta.</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="sd">        new_filters: Filters with new state to update local copy.</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a>    <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">k</span> <span class="ow">in</span> <span class="n">new_filters</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="p">)</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a>    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="p">:</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">sync</span><span class="p">(</span><span class="n">new_filters</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>

<h2 id="sample-batches">Sample Batches</h2>


  <div class="doc doc-object doc-class">



<h2 class="doc doc-heading" id="ray.rllib.policy.sample_batch.SampleBatch">
        <code>
ray.rllib.policy.sample_batch.SampleBatch            (<span title="dict">dict</span>)
        </code>



</h2>

    <div class="doc doc-contents first">

      <p>Wrapper around a dictionary with string keys and array-like values.</p>
<p>For example, {"obs": [1, 2, 3], "reward": [0, -1, 1]} is a batch of three
samples, each with an "obs" and "reward" attribute.</p>




  <div class="doc doc-children">





























  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="ray.rllib.policy.sample_batch.SampleBatch.__init__">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

</h3>

    <div class="doc doc-contents ">

      <p>Constructs a sample batch (same params as dict constructor).</p>
<p>Note: All <em>args and those </em>*kwargs not listed below will be passed
as-is to the parent dict constructor.</p>

        <details class="quote">
          <summary>Source code in <code>ray/rllib/policy/sample_batch.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nd">@PublicAPI</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>    <span class="sd">&quot;&quot;&quot;Constructs a sample batch (same params as dict constructor).</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="sd">    Note: All *args and those **kwargs not listed below will be passed</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="sd">    as-is to the parent dict constructor.</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="sd">    Keyword Args:</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="sd">        _time_major (Optinal[bool]): Whether data in this sample batch</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="sd">            is time-major. This is False by default and only relevant</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="sd">            if the data contains sequences.</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="sd">        _max_seq_len (Optional[bool]): The max sequence chunk length</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="sd">            if the data contains sequences.</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="sd">        _zero_padded (Optional[bool]): Whether the data in this batch</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="sd">            contains sequences AND these sequences are right-zero-padded</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="sd">            according to the `_max_seq_len` setting.</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="sd">        _is_training (Optional[bool]): Whether this batch is used for</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="sd">            training. If False, batch may be used for e.g. action</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="sd">            computations (inference).</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a>    <span class="c1"># Possible seq_lens (TxB or BxT) setup.</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">time_major</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;_time_major&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a>    <span class="c1"># Maximum seq len value.</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">max_seq_len</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;_max_seq_len&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a>    <span class="c1"># Is alredy right-zero-padded?</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">zero_padded</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;_zero_padded&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a>    <span class="c1"># Whether this batch is used for training (vs inference).</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_is_training</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;_is_training&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a>    <span class="c1"># Call super constructor. This will make the actual data accessible</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a>    <span class="c1"># by column name (str) via e.g. self[&quot;some-col&quot;].</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a>    <span class="nb">dict</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">accessed_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">added_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">deleted_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">intercepted_values</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">get_interceptor</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>    <span class="c1"># Clear out None seq-lens.</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>    <span class="n">seq_lens_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">SampleBatch</span><span class="o">.</span><span class="n">SEQ_LENS</span><span class="p">)</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>    <span class="k">if</span> <span class="n">seq_lens_</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> \
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>            <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">seq_lens_</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">seq_lens_</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">SampleBatch</span><span class="o">.</span><span class="n">SEQ_LENS</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>    <span class="c1"># Numpyfy seq_lens if list.</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">seq_lens_</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>        <span class="bp">self</span><span class="p">[</span><span class="n">SampleBatch</span><span class="o">.</span><span class="n">SEQ_LENS</span><span class="p">]</span> <span class="o">=</span> <span class="n">seq_lens_</span> <span class="o">=</span> \
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">seq_lens_</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_seq_len</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">seq_lens_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> \
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>            <span class="ow">not</span> <span class="p">(</span><span class="n">tf</span> <span class="ow">and</span> <span class="n">tf</span><span class="o">.</span><span class="n">is_tensor</span><span class="p">(</span><span class="n">seq_lens_</span><span class="p">))</span> <span class="ow">and</span> \
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>            <span class="nb">len</span><span class="p">(</span><span class="n">seq_lens_</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">max_seq_len</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">seq_lens_</span><span class="p">)</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_training</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_is_training</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;is_training&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>    <span class="n">lengths</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>    <span class="n">copy_</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="n">SampleBatch</span><span class="o">.</span><span class="n">SEQ_LENS</span><span class="p">}</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">copy_</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span> <span class="bp">self</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>        <span class="c1"># TODO: Drop support for lists as values.</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>        <span class="c1"># Convert lists of int|float into numpy arrays make sure all data</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>        <span class="c1"># has same length.</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>            <span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>        <span class="c1"># Try to infer the &quot;length&quot; of the SampleBatch by finding the first</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>        <span class="c1"># value that is actually a ndarray/tensor. This would fail if</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>        <span class="c1"># all values are nested dicts/tuples of more complex underlying</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>        <span class="c1"># structures.</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>        <span class="n">len_</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>            <span class="n">v</span><span class="p">,</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>            <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="n">torch</span> <span class="ow">and</span> <span class="n">torch</span><span class="o">.</span><span class="n">is_tensor</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="k">else</span> <span class="kc">None</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>        <span class="k">if</span> <span class="n">len_</span><span class="p">:</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>            <span class="n">lengths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">len_</span><span class="p">)</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">SampleBatch</span><span class="o">.</span><span class="n">SEQ_LENS</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> \
<a id="__codelineno-0-81" name="__codelineno-0-81"></a>            <span class="ow">not</span> <span class="p">(</span><span class="n">tf</span> <span class="ow">and</span> <span class="n">tf</span><span class="o">.</span><span class="n">is_tensor</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">SampleBatch</span><span class="o">.</span><span class="n">SEQ_LENS</span><span class="p">]))</span> <span class="ow">and</span> \
<a id="__codelineno-0-82" name="__codelineno-0-82"></a>            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">SampleBatch</span><span class="o">.</span><span class="n">SEQ_LENS</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">SampleBatch</span><span class="o">.</span><span class="n">SEQ_LENS</span><span class="p">])</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="n">lengths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">lengths</span> <span class="k">else</span> <span class="mi">0</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>    <span class="c1"># A convenience map for slicing this batch into sub-batches along</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>    <span class="c1"># the time axis. This helps reduce repeated iterations through the</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>    <span class="c1"># batch&#39;s seq_lens array to find good slicing points. Built lazily</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>    <span class="c1"># when needed.</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_slice_map</span> <span class="o">=</span> <span class="p">[]</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="ray.rllib.policy.sample_batch.SampleBatch.columns">
<code class="highlight language-python"><span class="n">columns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keys</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Returns a list of the batch-data in the specified columns.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>keys</code></td>
        <td><code>List[str]</code></td>
        <td><p>List of column names fo which to return the data.</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>List[any]</code></td>
      <td><p>The list of data items ordered by the order of column
    names in <code>keys</code>.</p></td>
    </tr>
  </tbody>
</table>
<p><strong>Examples:</strong></p>
    <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="o">&gt;&gt;&gt;</span> <span class="n">batch</span> <span class="o">=</span> <span class="n">SampleBatch</span><span class="p">({</span><span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;b&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="s2">&quot;c&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">]})</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="o">&gt;&gt;&gt;</span> <span class="nb">print</span><span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">columns</span><span class="p">([</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">]))</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="p">[[</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">]]</span>
</code></pre></div>

        <details class="quote">
          <summary>Source code in <code>ray/rllib/policy/sample_batch.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nd">@PublicAPI</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="k">def</span> <span class="nf">columns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keys</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">any</span><span class="p">]:</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>    <span class="sd">&quot;&quot;&quot;Returns a list of the batch-data in the specified columns.</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="sd">        keys (List[str]): List of column names fo which to return the data.</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="sd">        List[any]: The list of data items ordered by the order of column</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="sd">            names in `keys`.</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="sd">    Examples:</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="sd">        &gt;&gt;&gt; batch = SampleBatch({&quot;a&quot;: [1], &quot;b&quot;: [2], &quot;c&quot;: [3]})</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="sd">        &gt;&gt;&gt; print(batch.columns([&quot;a&quot;, &quot;b&quot;]))</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="sd">        [[1], [2]]</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a>    <span class="c1"># TODO: (sven) Make this work for nested data as well.</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a>    <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a>    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a>        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a>    <span class="k">return</span> <span class="n">out</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="ray.rllib.policy.sample_batch.SampleBatch.compress">
<code class="highlight language-python"><span class="n">compress</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bulk</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="nb">frozenset</span><span class="p">({</span><span class="s1">&#39;new_obs&#39;</span><span class="p">,</span> <span class="s1">&#39;obs&#39;</span><span class="p">}))</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Compresses the data buffers (by column) in place.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>bulk</code></td>
        <td><code>bool</code></td>
        <td><p>Whether to compress across the batch dimension (0)
as well. If False will compress n separate list items, where n
is the batch size.</p></td>
        <td><code>False</code></td>
      </tr>
      <tr>
        <td><code>columns</code></td>
        <td><code>Set[str]</code></td>
        <td><p>The columns to compress. Default: Only
compress the obs and new_obs columns.</p></td>
        <td><code>frozenset({&#39;new_obs&#39;, &#39;obs&#39;})</code></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>SampleBatch</code></td>
      <td><p>This very (now compressed) SampleBatch.</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>ray/rllib/policy/sample_batch.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nd">@DeveloperAPI</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="k">def</span> <span class="nf">compress</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>             <span class="n">bulk</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>             <span class="n">columns</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">([</span><span class="s2">&quot;obs&quot;</span><span class="p">,</span> <span class="s2">&quot;new_obs&quot;</span><span class="p">]))</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a>    <span class="sd">&quot;&quot;&quot;Compresses the data buffers (by column) in place.</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="sd">        bulk (bool): Whether to compress across the batch dimension (0)</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="sd">            as well. If False will compress n separate list items, where n</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="sd">            is the batch size.</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="sd">        columns (Set[str]): The columns to compress. Default: Only</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="sd">            compress the obs and new_obs columns.</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="sd">        SampleBatch: This very (now compressed) SampleBatch.</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a>    <span class="k">def</span> <span class="nf">_compress_in_place</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a>        <span class="k">if</span> <span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a>            <span class="k">return</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a>        <span class="n">curr</span> <span class="o">=</span> <span class="bp">self</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a>            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a>                <span class="k">if</span> <span class="n">bulk</span><span class="p">:</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a>                    <span class="n">curr</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">pack</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a>                    <span class="n">curr</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pack</span><span class="p">(</span><span class="n">o</span><span class="p">)</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">value</span><span class="p">])</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a>            <span class="n">curr</span> <span class="o">=</span> <span class="n">curr</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a>    <span class="n">tree</span><span class="o">.</span><span class="n">map_structure_with_path</span><span class="p">(</span><span class="n">_compress_in_place</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a>    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="ray.rllib.policy.sample_batch.SampleBatch.concat">
<code class="highlight language-python"><span class="n">concat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Concatenates <code>other</code> to this one and returns a new SampleBatch.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>other</code></td>
        <td><code>SampleBatch</code></td>
        <td><p>The other SampleBatch object to concat to this
one.</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>SampleBatch</code></td>
      <td><p>The new SampleBatch, resulting from concating <code>other</code>
    to <code>self</code>.</p></td>
    </tr>
  </tbody>
</table>
<p><strong>Examples:</strong></p>
    <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="o">&gt;&gt;&gt;</span> <span class="n">b1</span> <span class="o">=</span> <span class="n">SampleBatch</span><span class="p">({</span><span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])})</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="o">&gt;&gt;&gt;</span> <span class="n">b2</span> <span class="o">=</span> <span class="n">SampleBatch</span><span class="p">({</span><span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">])})</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="o">&gt;&gt;&gt;</span> <span class="nb">print</span><span class="p">(</span><span class="n">b1</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">b2</span><span class="p">))</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="p">{</span><span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">])}</span>
</code></pre></div>

        <details class="quote">
          <summary>Source code in <code>ray/rllib/policy/sample_batch.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nd">@PublicAPI</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="k">def</span> <span class="nf">concat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="s2">&quot;SampleBatch&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;SampleBatch&quot;</span><span class="p">:</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>    <span class="sd">&quot;&quot;&quot;Concatenates `other` to this one and returns a new SampleBatch.</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="sd">        other (SampleBatch): The other SampleBatch object to concat to this</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="sd">            one.</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="sd">        SampleBatch: The new SampleBatch, resulting from concating `other`</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="sd">            to `self`.</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="sd">    Examples:</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="sd">        &gt;&gt;&gt; b1 = SampleBatch({&quot;a&quot;: np.array([1, 2])})</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="sd">        &gt;&gt;&gt; b2 = SampleBatch({&quot;a&quot;: np.array([3, 4, 5])})</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="sd">        &gt;&gt;&gt; print(b1.concat(b2))</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="sd">        {&quot;a&quot;: np.array([1, 2, 3, 4, 5])}</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a>    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">concat_samples</span><span class="p">([</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">])</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="ray.rllib.policy.sample_batch.SampleBatch.concat_samples">
<code class="highlight language-python"><span class="n">concat_samples</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-staticmethod"><code>staticmethod</code></small>
  </span>

</h3>

    <div class="doc doc-contents ">

      <p>Concatenates n SampleBatches or MultiAgentBatches.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>samples</code></td>
        <td><code>Union[List[SampleBatch], List[MultiAgentBatch]]</code></td>
        <td><p>List of
SampleBatches or MultiAgentBatches to be concatenated.</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>Union[SampleBatch, MultiAgentBatch]</code></td>
      <td><p>A new (concatenated)
    SampleBatch or MultiAgentBatch.</p></td>
    </tr>
  </tbody>
</table>
<p><strong>Examples:</strong></p>
    <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="o">&gt;&gt;&gt;</span> <span class="n">b1</span> <span class="o">=</span> <span class="n">SampleBatch</span><span class="p">({</span><span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]),</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="o">...</span>                   <span class="s2">&quot;b&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">])})</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="o">&gt;&gt;&gt;</span> <span class="n">b2</span> <span class="o">=</span> <span class="n">SampleBatch</span><span class="p">({</span><span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">3</span><span class="p">]),</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="o">...</span>                   <span class="s2">&quot;b&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">12</span><span class="p">])})</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="o">&gt;&gt;&gt;</span> <span class="nb">print</span><span class="p">(</span><span class="n">SampleBatch</span><span class="o">.</span><span class="n">concat_samples</span><span class="p">([</span><span class="n">b1</span><span class="p">,</span> <span class="n">b2</span><span class="p">]))</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="p">{</span><span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]),</span> <span class="s2">&quot;b&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">])}</span>
</code></pre></div>

        <details class="quote">
          <summary>Source code in <code>ray/rllib/policy/sample_batch.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nd">@staticmethod</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="nd">@PublicAPI</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="k">def</span> <span class="nf">concat_samples</span><span class="p">(</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>        <span class="n">samples</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="s2">&quot;SampleBatch&quot;</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="s2">&quot;MultiAgentBatch&quot;</span><span class="p">]],</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="s2">&quot;SampleBatch&quot;</span><span class="p">,</span> <span class="s2">&quot;MultiAgentBatch&quot;</span><span class="p">]:</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a>    <span class="sd">&quot;&quot;&quot;Concatenates n SampleBatches or MultiAgentBatches.</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="sd">        samples (Union[List[SampleBatch], List[MultiAgentBatch]]): List of</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="sd">            SampleBatches or MultiAgentBatches to be concatenated.</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="sd">        Union[SampleBatch, MultiAgentBatch]: A new (concatenated)</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="sd">            SampleBatch or MultiAgentBatch.</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="sd">    Examples:</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="sd">        &gt;&gt;&gt; b1 = SampleBatch({&quot;a&quot;: np.array([1, 2]),</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="sd">        ...                   &quot;b&quot;: np.array([10, 11])})</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="sd">        &gt;&gt;&gt; b2 = SampleBatch({&quot;a&quot;: np.array([3]),</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="sd">        ...                   &quot;b&quot;: np.array([12])})</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a><span class="sd">        &gt;&gt;&gt; print(SampleBatch.concat_samples([b1, b2]))</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a><span class="sd">        {&quot;a&quot;: np.array([1, 2, 3]), &quot;b&quot;: np.array([10, 11, 12])}</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a>    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">MultiAgentBatch</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">samples</span><span class="p">):</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a>        <span class="k">return</span> <span class="n">MultiAgentBatch</span><span class="o">.</span><span class="n">concat_samples</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a>    <span class="n">concatd_seq_lens</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a>    <span class="n">concat_samples</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a>    <span class="n">zero_padded</span> <span class="o">=</span> <span class="n">samples</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">zero_padded</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a>    <span class="n">max_seq_len</span> <span class="o">=</span> <span class="n">samples</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">max_seq_len</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a>    <span class="n">time_major</span> <span class="o">=</span> <span class="n">samples</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">time_major</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a>    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">samples</span><span class="p">:</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a>        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a>            <span class="k">assert</span> <span class="n">s</span><span class="o">.</span><span class="n">zero_padded</span> <span class="o">==</span> <span class="n">zero_padded</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a>            <span class="k">assert</span> <span class="n">s</span><span class="o">.</span><span class="n">time_major</span> <span class="o">==</span> <span class="n">time_major</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a>            <span class="k">if</span> <span class="n">zero_padded</span><span class="p">:</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a>                <span class="k">assert</span> <span class="n">s</span><span class="o">.</span><span class="n">max_seq_len</span> <span class="o">==</span> <span class="n">max_seq_len</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a>            <span class="n">concat_samples</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a>            <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">SampleBatch</span><span class="o">.</span><span class="n">SEQ_LENS</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a>                <span class="n">concatd_seq_lens</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">SampleBatch</span><span class="o">.</span><span class="n">SEQ_LENS</span><span class="p">])</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>    <span class="c1"># If we don&#39;t have any samples (0 or only empty SampleBatches),</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>    <span class="c1"># return an empty SampleBatch here.</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">concat_samples</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>        <span class="k">return</span> <span class="n">SampleBatch</span><span class="p">()</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>    <span class="c1"># Collect the concat&#39;d data.</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>    <span class="n">concatd_data</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>    <span class="k">def</span> <span class="nf">concat_key</span><span class="p">(</span><span class="o">*</span><span class="n">values</span><span class="p">):</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>        <span class="k">return</span> <span class="n">concat_aligned</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">time_major</span><span class="p">)</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">concat_samples</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>            <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="s2">&quot;infos&quot;</span><span class="p">:</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>                <span class="n">concatd_data</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">concat_aligned</span><span class="p">(</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>                    <span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">concat_samples</span><span class="p">],</span> <span class="n">time_major</span><span class="o">=</span><span class="n">time_major</span><span class="p">)</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>                <span class="n">concatd_data</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">map_structure</span><span class="p">(</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>                    <span class="n">concat_key</span><span class="p">,</span> <span class="o">*</span><span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">concat_samples</span><span class="p">])</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot concat data under key &#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&#39;, b/c &quot;</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>                         <span class="s2">&quot;sub-structures under that key don&#39;t match. &quot;</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>                         <span class="sa">f</span><span class="s2">&quot;`samples`=</span><span class="si">{</span><span class="n">samples</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>    <span class="c1"># Return a new (concat&#39;d) SampleBatch.</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>    <span class="k">return</span> <span class="n">SampleBatch</span><span class="p">(</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a>        <span class="n">concatd_data</span><span class="p">,</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>        <span class="n">seq_lens</span><span class="o">=</span><span class="n">concatd_seq_lens</span><span class="p">,</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>        <span class="n">_time_major</span><span class="o">=</span><span class="n">time_major</span><span class="p">,</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>        <span class="n">_zero_padded</span><span class="o">=</span><span class="n">zero_padded</span><span class="p">,</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>        <span class="n">_max_seq_len</span><span class="o">=</span><span class="n">max_seq_len</span><span class="p">,</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="ray.rllib.policy.sample_batch.SampleBatch.copy">
<code class="highlight language-python"><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shallow</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Creates a deep or shallow copy of this SampleBatch and returns it.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>shallow</code></td>
        <td><code>bool</code></td>
        <td><p>Whether the copying should be done shallowly.</p></td>
        <td><code>False</code></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>SampleBatch</code></td>
      <td><p>A deep or shallow copy of this SampleBatch object.</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>ray/rllib/policy/sample_batch.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nd">@PublicAPI</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shallow</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;SampleBatch&quot;</span><span class="p">:</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>    <span class="sd">&quot;&quot;&quot;Creates a deep or shallow copy of this SampleBatch and returns it.</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="sd">        shallow (bool): Whether the copying should be done shallowly.</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="sd">        SampleBatch: A deep or shallow copy of this SampleBatch object.</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a>    <span class="n">copy_</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a>    <span class="n">data</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">map_structure</span><span class="p">(</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a>        <span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="ow">not</span> <span class="n">shallow</span><span class="p">)</span> <span class="k">if</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a>                   <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="k">else</span> <span class="n">v</span><span class="p">),</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a>        <span class="n">copy_</span><span class="p">,</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a>    <span class="p">)</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a>    <span class="n">copy_</span> <span class="o">=</span> <span class="n">SampleBatch</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a>    <span class="n">copy_</span><span class="o">.</span><span class="n">set_get_interceptor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_interceptor</span><span class="p">)</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a>    <span class="n">copy_</span><span class="o">.</span><span class="n">added_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">added_keys</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a>    <span class="n">copy_</span><span class="o">.</span><span class="n">deleted_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deleted_keys</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a>    <span class="n">copy_</span><span class="o">.</span><span class="n">accessed_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">accessed_keys</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a>    <span class="k">return</span> <span class="n">copy_</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="ray.rllib.policy.sample_batch.SampleBatch.decompress_if_needed">
<code class="highlight language-python"><span class="n">decompress_if_needed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="nb">frozenset</span><span class="p">({</span><span class="s1">&#39;new_obs&#39;</span><span class="p">,</span> <span class="s1">&#39;obs&#39;</span><span class="p">}))</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Decompresses data buffers (per column if not compressed) in place.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>columns</code></td>
        <td><code>Set[str]</code></td>
        <td><p>The columns to decompress. Default: Only
decompress the obs and new_obs columns.</p></td>
        <td><code>frozenset({&#39;new_obs&#39;, &#39;obs&#39;})</code></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>SampleBatch</code></td>
      <td><p>This very (now uncompressed) SampleBatch.</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>ray/rllib/policy/sample_batch.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nd">@DeveloperAPI</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="k">def</span> <span class="nf">decompress_if_needed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>                         <span class="n">columns</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">(</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>                             <span class="p">[</span><span class="s2">&quot;obs&quot;</span><span class="p">,</span> <span class="s2">&quot;new_obs&quot;</span><span class="p">]))</span> <span class="o">-&gt;</span> <span class="s2">&quot;SampleBatch&quot;</span><span class="p">:</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a>    <span class="sd">&quot;&quot;&quot;Decompresses data buffers (per column if not compressed) in place.</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="sd">        columns (Set[str]): The columns to decompress. Default: Only</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="sd">            decompress the obs and new_obs columns.</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="sd">        SampleBatch: This very (now uncompressed) SampleBatch.</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a>    <span class="k">def</span> <span class="nf">_decompress_in_place</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a>        <span class="k">if</span> <span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a>            <span class="k">return</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a>        <span class="n">curr</span> <span class="o">=</span> <span class="bp">self</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a>        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">path</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a>            <span class="n">curr</span> <span class="o">=</span> <span class="n">curr</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a>        <span class="c1"># Bulk compressed.</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a>        <span class="k">if</span> <span class="n">is_compressed</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a>            <span class="n">curr</span><span class="p">[</span><span class="n">path</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a>        <span class="c1"># Non bulk compressed.</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a>        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">is_compressed</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a>            <span class="n">curr</span><span class="p">[</span><span class="n">path</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">unpack</span><span class="p">(</span><span class="n">o</span><span class="p">)</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">value</span><span class="p">])</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a>    <span class="n">tree</span><span class="o">.</span><span class="n">map_structure_with_path</span><span class="p">(</span><span class="n">_decompress_in_place</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a>    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="ray.rllib.policy.sample_batch.SampleBatch.get">
<code class="highlight language-python"><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Return the value for key if key is in the dictionary, else default.</p>

        <details class="quote">
          <summary>Source code in <code>ray/rllib/policy/sample_batch.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a>        <span class="k">return</span> <span class="n">default</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="ray.rllib.policy.sample_batch.SampleBatch.get_single_step_input_dict">
<code class="highlight language-python"><span class="n">get_single_step_input_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">view_requirements</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="s1">&#39;last&#39;</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Creates single ts SampleBatch at given index from <code>self</code>.</p>
<p>For usage as input-dict for model (action or value function) calls.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>view_requirements</code></td>
        <td><code>Dict[str, ViewRequirement]</code></td>
        <td><p>A view requirements dict from the model for
which to produce the input_dict.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>index</code></td>
        <td><code>Union[str, int]</code></td>
        <td><p>An integer index value indicating the
position in the trajectory for which to generate the
compute_actions input dict. Set to "last" to generate the dict
at the very end of the trajectory (e.g. for value estimation).
Note that "last" is different from -1, as "last" will use the
final NEXT_OBS as observation input.</p></td>
        <td><code>&#39;last&#39;</code></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>SampleBatch</code></td>
      <td><p>The (single-timestep) input dict for ModelV2 calls.</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>ray/rllib/policy/sample_batch.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nd">@ExperimentalAPI</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="k">def</span> <span class="nf">get_single_step_input_dict</span><span class="p">(</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>        <span class="n">view_requirements</span><span class="p">:</span> <span class="n">ViewRequirementsDict</span><span class="p">,</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a>        <span class="n">index</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;last&quot;</span><span class="p">,</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;SampleBatch&quot;</span><span class="p">:</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a>    <span class="sd">&quot;&quot;&quot;Creates single ts SampleBatch at given index from `self`.</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="sd">    For usage as input-dict for model (action or value function) calls.</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="sd">        view_requirements: A view requirements dict from the model for</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="sd">            which to produce the input_dict.</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="sd">        index: An integer index value indicating the</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="sd">            position in the trajectory for which to generate the</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="sd">            compute_actions input dict. Set to &quot;last&quot; to generate the dict</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="sd">            at the very end of the trajectory (e.g. for value estimation).</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="sd">            Note that &quot;last&quot; is different from -1, as &quot;last&quot; will use the</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="sd">            final NEXT_OBS as observation input.</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a><span class="sd">        The (single-timestep) input dict for ModelV2 calls.</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a>    <span class="n">last_mappings</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a>        <span class="n">SampleBatch</span><span class="o">.</span><span class="n">OBS</span><span class="p">:</span> <span class="n">SampleBatch</span><span class="o">.</span><span class="n">NEXT_OBS</span><span class="p">,</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a>        <span class="n">SampleBatch</span><span class="o">.</span><span class="n">PREV_ACTIONS</span><span class="p">:</span> <span class="n">SampleBatch</span><span class="o">.</span><span class="n">ACTIONS</span><span class="p">,</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a>        <span class="n">SampleBatch</span><span class="o">.</span><span class="n">PREV_REWARDS</span><span class="p">:</span> <span class="n">SampleBatch</span><span class="o">.</span><span class="n">REWARDS</span><span class="p">,</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a>    <span class="p">}</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a>    <span class="n">input_dict</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a>    <span class="k">for</span> <span class="n">view_col</span><span class="p">,</span> <span class="n">view_req</span> <span class="ow">in</span> <span class="n">view_requirements</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a>        <span class="k">if</span> <span class="n">view_req</span><span class="o">.</span><span class="n">used_for_compute_actions</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a>            <span class="k">continue</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a>        <span class="c1"># Create batches of size 1 (single-agent input-dict).</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a>        <span class="n">data_col</span> <span class="o">=</span> <span class="n">view_req</span><span class="o">.</span><span class="n">data_col</span> <span class="ow">or</span> <span class="n">view_col</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a>        <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="s2">&quot;last&quot;</span><span class="p">:</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a>            <span class="n">data_col</span> <span class="o">=</span> <span class="n">last_mappings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">data_col</span><span class="p">,</span> <span class="n">data_col</span><span class="p">)</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a>            <span class="c1"># Range needed.</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a>            <span class="k">if</span> <span class="n">view_req</span><span class="o">.</span><span class="n">shift_from</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>                <span class="c1"># Batch repeat value &gt; 1: We have single frames in the</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>                <span class="c1"># batch at each timestep (for the `data_col`).</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">view_col</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>                <span class="n">traj_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">data_col</span><span class="p">])</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>                <span class="n">missing_at_end</span> <span class="o">=</span> <span class="n">traj_len</span> <span class="o">%</span> <span class="n">view_req</span><span class="o">.</span><span class="n">batch_repeat_value</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>                <span class="c1"># Index into the observations column must be shifted by</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>                <span class="c1"># -1 b/c index=0 for observations means the current (last</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>                <span class="c1"># seen) observation (after having taken an action).</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>                <span class="n">obs_shift</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="n">data_col</span> <span class="ow">in</span> <span class="p">[</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>                    <span class="n">SampleBatch</span><span class="o">.</span><span class="n">OBS</span><span class="p">,</span> <span class="n">SampleBatch</span><span class="o">.</span><span class="n">NEXT_OBS</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>                <span class="p">]</span> <span class="k">else</span> <span class="mi">0</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>                <span class="n">from_</span> <span class="o">=</span> <span class="n">view_req</span><span class="o">.</span><span class="n">shift_from</span> <span class="o">+</span> <span class="n">obs_shift</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>                <span class="n">to_</span> <span class="o">=</span> <span class="n">view_req</span><span class="o">.</span><span class="n">shift_to</span> <span class="o">+</span> <span class="n">obs_shift</span> <span class="o">+</span> <span class="mi">1</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>                <span class="k">if</span> <span class="n">to_</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>                    <span class="n">to_</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>                <span class="n">input_dict</span><span class="p">[</span><span class="n">view_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>                    <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>                        <span class="p">[</span><span class="n">data</span><span class="p">,</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>                         <span class="bp">self</span><span class="p">[</span><span class="n">data_col</span><span class="p">][</span><span class="o">-</span><span class="n">missing_at_end</span><span class="p">:]])[</span><span class="n">from_</span><span class="p">:</span><span class="n">to_</span><span class="p">]</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>                <span class="p">])</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>            <span class="c1"># Single index.</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>                <span class="n">input_dict</span><span class="p">[</span><span class="n">view_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">map_structure</span><span class="p">(</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>                    <span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:],</span>  <span class="c1"># keep as array (w/ 1 element)</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>                    <span class="bp">self</span><span class="p">[</span><span class="n">data_col</span><span class="p">],</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>                <span class="p">)</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a>        <span class="c1"># Single index somewhere inside the trajectory (non-last).</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>            <span class="n">input_dict</span><span class="p">[</span><span class="n">view_col</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">data_col</span><span class="p">][</span><span class="n">index</span><span class="p">:</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>                                                  <span class="k">if</span> <span class="n">index</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="k">else</span> <span class="kc">None</span><span class="p">]</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>    <span class="k">return</span> <span class="n">SampleBatch</span><span class="p">(</span><span class="n">input_dict</span><span class="p">,</span> <span class="n">seq_lens</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">))</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="ray.rllib.policy.sample_batch.SampleBatch.right_zero_pad">
<code class="highlight language-python"><span class="n">right_zero_pad</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_seq_len</span><span class="p">,</span> <span class="n">exclude_states</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Right (adding zeros at end) zero-pads this SampleBatch in-place.</p>
<p>This will set the <code>self.zero_padded</code> flag to True and
<code>self.max_seq_len</code> to the given <code>max_seq_len</code> value.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>max_seq_len</code></td>
        <td><code>int</code></td>
        <td><p>The max (total) length to zero pad to.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>exclude_states</code></td>
        <td><code>bool</code></td>
        <td><p>If False, also right-zero-pad all
<code>state_in_x</code> data. If True, leave <code>state_in_x</code> keys
as-is.</p></td>
        <td><code>True</code></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>SampleBatch</code></td>
      <td><p>This very (now right-zero-padded) SampleBatch.</p></td>
    </tr>
  </tbody>
</table>
<p><strong>Exceptions:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>ValueError</code></td>
        <td><p>If self[SampleBatch.SEQ_LENS] is None (not defined).</p></td>
      </tr>
  </tbody>
</table>
<p><strong>Examples:</strong></p>
    <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="o">&gt;&gt;&gt;</span> <span class="n">batch</span> <span class="o">=</span> <span class="n">SampleBatch</span><span class="p">({</span><span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="s2">&quot;seq_lens&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]})</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="o">&gt;&gt;&gt;</span> <span class="nb">print</span><span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">right_zero_pad</span><span class="p">(</span><span class="n">max_seq_len</span><span class="o">=</span><span class="mi">4</span><span class="p">))</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="p">{</span><span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;seq_lens&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]}</span>
</code></pre></div>
    <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="o">&gt;&gt;&gt;</span> <span class="n">batch</span> <span class="o">=</span> <span class="n">SampleBatch</span><span class="p">({</span><span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="o">...</span>                      <span class="s2">&quot;state_in_0&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">],</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="o">...</span>                      <span class="s2">&quot;seq_lens&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]})</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="o">&gt;&gt;&gt;</span> <span class="nb">print</span><span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">right_zero_pad</span><span class="p">(</span><span class="n">max_seq_len</span><span class="o">=</span><span class="mi">5</span><span class="p">))</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="p">{</span><span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a> <span class="s2">&quot;state_in_0&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">],</span>  <span class="c1"># &lt;- all state-ins remain as-is</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a> <span class="s2">&quot;seq_lens&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]}</span>
</code></pre></div>

        <details class="quote">
          <summary>Source code in <code>ray/rllib/policy/sample_batch.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="k">def</span> <span class="nf">right_zero_pad</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_seq_len</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">exclude_states</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot;Right (adding zeros at end) zero-pads this SampleBatch in-place.</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="sd">    This will set the `self.zero_padded` flag to True and</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="sd">    `self.max_seq_len` to the given `max_seq_len` value.</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="sd">        max_seq_len: The max (total) length to zero pad to.</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="sd">        exclude_states: If False, also right-zero-pad all</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="sd">            `state_in_x` data. If True, leave `state_in_x` keys</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="sd">            as-is.</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="sd">        SampleBatch: This very (now right-zero-padded) SampleBatch.</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="sd">    Raises:</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="sd">        ValueError: If self[SampleBatch.SEQ_LENS] is None (not defined).</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="sd">    Examples:</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="sd">        &gt;&gt;&gt; batch = SampleBatch({&quot;a&quot;: [1, 2, 3], &quot;seq_lens&quot;: [1, 2]})</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a><span class="sd">        &gt;&gt;&gt; print(batch.right_zero_pad(max_seq_len=4))</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a><span class="sd">        {&quot;a&quot;: [1, 0, 0, 0, 2, 3, 0, 0], &quot;seq_lens&quot;: [1, 2]}</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a><span class="sd">        &gt;&gt;&gt; batch = SampleBatch({&quot;a&quot;: [1, 2, 3],</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a><span class="sd">        ...                      &quot;state_in_0&quot;: [1.0, 3.0],</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a><span class="sd">        ...                      &quot;seq_lens&quot;: [1, 2]})</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a><span class="sd">        &gt;&gt;&gt; print(batch.right_zero_pad(max_seq_len=5))</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a><span class="sd">        {&quot;a&quot;: [1, 0, 0, 0, 0, 2, 3, 0, 0, 0],</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a><span class="sd">         &quot;state_in_0&quot;: [1.0, 3.0],  # &lt;- all state-ins remain as-is</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a><span class="sd">         &quot;seq_lens&quot;: [1, 2]}</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a>    <span class="n">seq_lens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">SampleBatch</span><span class="o">.</span><span class="n">SEQ_LENS</span><span class="p">)</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a>    <span class="k">if</span> <span class="n">seq_lens</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a>            <span class="s2">&quot;Cannot right-zero-pad SampleBatch if no `seq_lens` field &quot;</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a>            <span class="s2">&quot;present! SampleBatch=</span><span class="si">{self}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a>    <span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">seq_lens</span><span class="p">)</span> <span class="o">*</span> <span class="n">max_seq_len</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a>    <span class="k">def</span> <span class="nf">_zero_pad_in_place</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>        <span class="c1"># Skip &quot;state_in_...&quot; columns and &quot;seq_lens&quot;.</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">exclude_states</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;state_in_&quot;</span><span class="p">))</span> \
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>                <span class="ow">or</span> <span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">SampleBatch</span><span class="o">.</span><span class="n">SEQ_LENS</span><span class="p">:</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>            <span class="k">return</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>        <span class="c1"># Generate zero-filled primer of len=max_seq_len.</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>        <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">object</span> <span class="ow">or</span> <span class="n">value</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="n">np</span><span class="o">.</span><span class="n">str_</span><span class="p">:</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>            <span class="n">f_pad</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">length</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>            <span class="c1"># Make sure type doesn&#39;t change.</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>            <span class="n">f_pad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>                <span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">value</span><span class="p">)[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">value</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>        <span class="c1"># Fill primer with data.</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>        <span class="n">f_pad_base</span> <span class="o">=</span> <span class="n">f_base</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>        <span class="k">for</span> <span class="n">len_</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span><span class="n">SampleBatch</span><span class="o">.</span><span class="n">SEQ_LENS</span><span class="p">]:</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>            <span class="n">f_pad</span><span class="p">[</span><span class="n">f_pad_base</span><span class="p">:</span><span class="n">f_pad_base</span> <span class="o">+</span> <span class="n">len_</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="n">f_base</span><span class="p">:</span><span class="n">f_base</span> <span class="o">+</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>                                                        <span class="n">len_</span><span class="p">]</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>            <span class="n">f_pad_base</span> <span class="o">+=</span> <span class="n">max_seq_len</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>            <span class="n">f_base</span> <span class="o">+=</span> <span class="n">len_</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>        <span class="k">assert</span> <span class="n">f_base</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="n">value</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>        <span class="c1"># Update our data in-place.</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>        <span class="n">curr</span> <span class="o">=</span> <span class="bp">self</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>                <span class="n">curr</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">f_pad</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>            <span class="n">curr</span> <span class="o">=</span> <span class="n">curr</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>    <span class="n">self_as_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>    <span class="n">tree</span><span class="o">.</span><span class="n">map_structure_with_path</span><span class="p">(</span><span class="n">_zero_pad_in_place</span><span class="p">,</span> <span class="n">self_as_dict</span><span class="p">)</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>    <span class="c1"># Set flags to indicate, we are now zero-padded (and to what extend).</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">zero_padded</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">max_seq_len</span> <span class="o">=</span> <span class="n">max_seq_len</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="ray.rllib.policy.sample_batch.SampleBatch.rows">
<code class="highlight language-python"><span class="n">rows</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Returns an iterator over data rows, i.e. dicts with column values.</p>
<p>Note that if <code>seq_lens</code> is set in self, we set it to [1] in the rows.</p>
<p>!!! yields
    Dict[str, TensorType]: The column values of the row in this
        iteration.</p>

<p><strong>Examples:</strong></p>
    <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="o">&gt;&gt;&gt;</span> <span class="n">batch</span> <span class="o">=</span> <span class="n">SampleBatch</span><span class="p">({</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="o">...</span>    <span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="o">...</span>    <span class="s2">&quot;b&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">],</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="o">...</span>    <span class="s2">&quot;seq_lens&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="o">...</span> <span class="p">})</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="o">&gt;&gt;&gt;</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">batch</span><span class="o">.</span><span class="n">rows</span><span class="p">():</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a>       <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="p">{</span><span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s2">&quot;seq_lens&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">]}</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="p">{</span><span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s2">&quot;seq_lens&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">]}</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="p">{</span><span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span> <span class="s2">&quot;seq_lens&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">]}</span>
</code></pre></div>

        <details class="quote">
          <summary>Source code in <code>ray/rllib/policy/sample_batch.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nd">@PublicAPI</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="k">def</span> <span class="nf">rows</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">TensorType</span><span class="p">]]:</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>    <span class="sd">&quot;&quot;&quot;Returns an iterator over data rows, i.e. dicts with column values.</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="sd">    Note that if `seq_lens` is set in self, we set it to [1] in the rows.</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="sd">    Yields:</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="sd">        Dict[str, TensorType]: The column values of the row in this</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="sd">            iteration.</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="sd">    Examples:</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="sd">        &gt;&gt;&gt; batch = SampleBatch({</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="sd">        ...    &quot;a&quot;: [1, 2, 3],</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="sd">        ...    &quot;b&quot;: [4, 5, 6],</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="sd">        ...    &quot;seq_lens&quot;: [1, 2]</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="sd">        ... })</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="sd">        &gt;&gt;&gt; for row in batch.rows():</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="sd">               print(row)</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="sd">        {&quot;a&quot;: 1, &quot;b&quot;: 4, &quot;seq_lens&quot;: [1]}</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="sd">        {&quot;a&quot;: 2, &quot;b&quot;: 5, &quot;seq_lens&quot;: [1]}</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a><span class="sd">        {&quot;a&quot;: 3, &quot;b&quot;: 6, &quot;seq_lens&quot;: [1]}</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a>    <span class="c1"># Do we add seq_lens=[1] to each row?</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a>    <span class="n">seq_lens</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a>        <span class="n">SampleBatch</span><span class="o">.</span><span class="n">SEQ_LENS</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">])</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a>    <span class="n">self_as_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count</span><span class="p">):</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a>        <span class="k">yield</span> <span class="n">tree</span><span class="o">.</span><span class="n">map_structure_with_path</span><span class="p">(</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a>            <span class="k">lambda</span> <span class="n">p</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">if</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SEQ_LENS</span> <span class="k">else</span> <span class="n">seq_lens</span><span class="p">,</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a>            <span class="n">self_as_dict</span><span class="p">,</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a>        <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="ray.rllib.policy.sample_batch.SampleBatch.shuffle">
<code class="highlight language-python"><span class="n">shuffle</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Shuffles the rows of this batch in-place.</p>

<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>SampleBatch</code></td>
      <td><p>This very (now shuffled) SampleBatch.</p></td>
    </tr>
  </tbody>
</table>
<p><strong>Exceptions:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>ValueError</code></td>
        <td><p>If self[SampleBatch.SEQ_LENS] is defined.</p></td>
      </tr>
  </tbody>
</table>
<p><strong>Examples:</strong></p>
    <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="o">&gt;&gt;&gt;</span> <span class="n">batch</span> <span class="o">=</span> <span class="n">SampleBatch</span><span class="p">({</span><span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]})</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="o">&gt;&gt;&gt;</span> <span class="nb">print</span><span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">shuffle</span><span class="p">())</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="p">{</span><span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">]}</span>
</code></pre></div>

        <details class="quote">
          <summary>Source code in <code>ray/rllib/policy/sample_batch.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nd">@PublicAPI</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="k">def</span> <span class="nf">shuffle</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>    <span class="sd">&quot;&quot;&quot;Shuffles the rows of this batch in-place.</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="sd">        SampleBatch: This very (now shuffled) SampleBatch.</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="sd">    Raises:</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="sd">        ValueError: If self[SampleBatch.SEQ_LENS] is defined.</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="sd">    Examples:</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="sd">        &gt;&gt;&gt; batch = SampleBatch({&quot;a&quot;: [1, 2, 3, 4]})</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="sd">        &gt;&gt;&gt; print(batch.shuffle())</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="sd">        {&quot;a&quot;: [4, 1, 3, 2]}</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a>    <span class="c1"># Shuffling the data when we have `seq_lens` defined is probably</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a>    <span class="c1"># a bad idea!</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">SampleBatch</span><span class="o">.</span><span class="n">SEQ_LENS</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a>            <span class="s2">&quot;SampleBatch.shuffle not possible when your data has &quot;</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a>            <span class="s2">&quot;`seq_lens` defined!&quot;</span><span class="p">)</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a>    <span class="c1"># Get a permutation over the single items once and use the same</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a>    <span class="c1"># permutation for all the data (otherwise, data would become</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a>    <span class="c1"># meaningless).</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a>    <span class="n">permutation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">permutation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count</span><span class="p">)</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a>    <span class="k">def</span> <span class="nf">_permutate_in_place</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a>        <span class="n">curr</span> <span class="o">=</span> <span class="bp">self</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a>            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a>                <span class="n">curr</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="n">permutation</span><span class="p">]</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a>            <span class="c1"># Translate into list (tuples are immutable).</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">curr</span><span class="p">[</span><span class="n">p</span><span class="p">],</span> <span class="nb">tuple</span><span class="p">):</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a>                <span class="n">curr</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">curr</span><span class="p">[</span><span class="n">p</span><span class="p">])</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a>            <span class="n">curr</span> <span class="o">=</span> <span class="n">curr</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a>    <span class="n">tree</span><span class="o">.</span><span class="n">map_structure_with_path</span><span class="p">(</span><span class="n">_permutate_in_place</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="ray.rllib.policy.sample_batch.SampleBatch.size_bytes">
<code class="highlight language-python"><span class="n">size_bytes</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Returns sum over number of bytes of all data buffers.</p>
<p>For numpy arrays, we use <code>.nbytes</code>. For all other value types, we use
sys.getsizeof(...).</p>

<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>int</code></td>
      <td><p>The overall size in bytes of the data buffer (all columns).</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>ray/rllib/policy/sample_batch.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nd">@PublicAPI</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="k">def</span> <span class="nf">size_bytes</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>    <span class="sd">&quot;&quot;&quot;Returns sum over number of bytes of all data buffers.</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="sd">    For numpy arrays, we use `.nbytes`. For all other value types, we use</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="sd">    sys.getsizeof(...).</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="sd">        int: The overall size in bytes of the data buffer (all columns).</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a>    <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a>        <span class="n">v</span><span class="o">.</span><span class="n">nbytes</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="k">else</span> <span class="n">sys</span><span class="o">.</span><span class="n">getsizeof</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a>        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">tree</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
</code></pre></div>
        </details>
    </div>

  </div>




  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="ray.rllib.policy.sample_batch.SampleBatch.split_by_episode">
<code class="highlight language-python"><span class="n">split_by_episode</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Splits by <code>eps_id</code> column and returns list of new batches.</p>

<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>List[SampleBatch]</code></td>
      <td><p>List of batches, one per distinct episode.</p></td>
    </tr>
  </tbody>
</table>
<p><strong>Exceptions:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>KeyError</code></td>
        <td><p>If the <code>eps_id</code> AND <code>dones</code> columns are not present.</p></td>
      </tr>
  </tbody>
</table>
<p><strong>Examples:</strong></p>
    <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="o">&gt;&gt;&gt;</span> <span class="n">batch</span> <span class="o">=</span> <span class="n">SampleBatch</span><span class="p">({</span><span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="s2">&quot;eps_id&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]})</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="o">&gt;&gt;&gt;</span> <span class="nb">print</span><span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">split_by_episode</span><span class="p">())</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="p">[{</span><span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="s2">&quot;eps_id&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]},</span> <span class="p">{</span><span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="s2">&quot;eps_id&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">]}]</span>
</code></pre></div>

        <details class="quote">
          <summary>Source code in <code>ray/rllib/policy/sample_batch.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nd">@PublicAPI</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="k">def</span> <span class="nf">split_by_episode</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="s2">&quot;SampleBatch&quot;</span><span class="p">]:</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>    <span class="sd">&quot;&quot;&quot;Splits by `eps_id` column and returns list of new batches.</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="sd">        List[SampleBatch]: List of batches, one per distinct episode.</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="sd">    Raises:</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="sd">        KeyError: If the `eps_id` AND `dones` columns are not present.</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="sd">    Examples:</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="sd">        &gt;&gt;&gt; batch = SampleBatch({&quot;a&quot;: [1, 2, 3], &quot;eps_id&quot;: [0, 0, 1]})</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="sd">        &gt;&gt;&gt; print(batch.split_by_episode())</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="sd">        [{&quot;a&quot;: [1, 2], &quot;eps_id&quot;: [0, 0]}, {&quot;a&quot;: [3], &quot;eps_id&quot;: [1]}]</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a>    <span class="c1"># No eps_id in data -&gt; Make sure there are no &quot;dones&quot; in the middle</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a>    <span class="c1"># and add eps_id automatically.</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a>    <span class="k">if</span> <span class="n">SampleBatch</span><span class="o">.</span><span class="n">EPS_ID</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a>        <span class="c1"># TODO: (sven) Shouldn&#39;t we rather split by DONEs then and not</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a>        <span class="c1">#  add fake eps-ids (0s) at all?</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a>        <span class="k">if</span> <span class="n">SampleBatch</span><span class="o">.</span><span class="n">DONES</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a>            <span class="k">assert</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">SampleBatch</span><span class="o">.</span><span class="n">DONES</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a>        <span class="bp">self</span><span class="p">[</span><span class="n">SampleBatch</span><span class="o">.</span><span class="n">EPS_ID</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">count</span><span class="p">)</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a>        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="p">]</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a>    <span class="c1"># Produce a new slice whenever we find a new episode ID.</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a>    <span class="n">slices</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a>    <span class="n">cur_eps_id</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">SampleBatch</span><span class="o">.</span><span class="n">EPS_ID</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a>    <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count</span><span class="p">):</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a>        <span class="n">next_eps_id</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">SampleBatch</span><span class="o">.</span><span class="n">EPS_ID</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a>        <span class="k">if</span> <span class="n">next_eps_id</span> <span class="o">!=</span> <span class="n">cur_eps_id</span><span class="p">:</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a>            <span class="n">slices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">offset</span><span class="p">:</span><span class="n">i</span><span class="p">])</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a>            <span class="n">offset</span> <span class="o">=</span> <span class="n">i</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a>            <span class="n">cur_eps_id</span> <span class="o">=</span> <span class="n">next_eps_id</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a>    <span class="c1"># Add final slice.</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a>    <span class="n">slices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">offset</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">count</span><span class="p">])</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a>    <span class="c1"># TODO: (sven) Are these checks necessary? Should be all ok according</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>    <span class="c1">#  to above logic.</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">slices</span><span class="p">:</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>        <span class="n">slen</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">SampleBatch</span><span class="o">.</span><span class="n">EPS_ID</span><span class="p">]))</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>        <span class="k">assert</span> <span class="n">slen</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">slen</span><span class="p">)</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>    <span class="k">assert</span> <span class="nb">sum</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">count</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">slices</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">count</span><span class="p">,</span> <span class="p">(</span><span class="n">slices</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">count</span><span class="p">)</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>    <span class="k">return</span> <span class="n">slices</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="ray.rllib.policy.sample_batch.SampleBatch.timeslices">
<code class="highlight language-python"><span class="n">timeslices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">num_slices</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Returns SampleBatches, each one representing a k-slice of this one.</p>
<p>Will start from timestep 0 and produce slices of size=k.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>size</code></td>
        <td><code>Optional[int]</code></td>
        <td><p>The size (in timesteps) of each returned
SampleBatch.</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>num_slices</code></td>
        <td><code>Optional[int]</code></td>
        <td><p>The number of slices to produce.</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>k</code></td>
        <td><code>int</code></td>
        <td><p>The size (in timesteps) of each returned SampleBatch.</p></td>
        <td><code>None</code></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>List[SampleBatch]</code></td>
      <td><p>The list of <code>num_slices</code> (new) SampleBatches
    or n (new) SampleBatches each one of size <code>size</code>.</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>ray/rllib/policy/sample_batch.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nd">@PublicAPI</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="k">def</span> <span class="nf">timeslices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>               <span class="n">size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>               <span class="n">num_slices</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a>               <span class="n">k</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="s2">&quot;SampleBatch&quot;</span><span class="p">]:</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a>    <span class="sd">&quot;&quot;&quot;Returns SampleBatches, each one representing a k-slice of this one.</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="sd">    Will start from timestep 0 and produce slices of size=k.</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="sd">        size (Optional[int]): The size (in timesteps) of each returned</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="sd">            SampleBatch.</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="sd">        num_slices (Optional[int]): The number of slices to produce.</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="sd">        k (int): Obsoleted: Use size or num_slices instead!</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="sd">            The size (in timesteps) of each returned SampleBatch.</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="sd">        List[SampleBatch]: The list of `num_slices` (new) SampleBatches</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="sd">            or n (new) SampleBatches each one of size `size`.</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a>    <span class="k">if</span> <span class="n">size</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">num_slices</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a>        <span class="n">deprecation_warning</span><span class="p">(</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="s2">&quot;size or num_slices&quot;</span><span class="p">)</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a>        <span class="k">assert</span> <span class="n">k</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a>        <span class="n">size</span> <span class="o">=</span> <span class="n">k</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a>    <span class="k">if</span> <span class="n">size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a>        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">num_slices</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a>        <span class="n">slices</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a>        <span class="n">left</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a>        <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a>        <span class="k">while</span> <span class="n">left</span><span class="p">:</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a>            <span class="n">len_</span> <span class="o">=</span> <span class="n">left</span> <span class="o">//</span> <span class="p">(</span><span class="n">num_slices</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">slices</span><span class="p">))</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a>            <span class="n">stop</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">len_</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a>            <span class="n">slices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">])</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a>            <span class="n">left</span> <span class="o">-=</span> <span class="n">len_</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a>            <span class="n">start</span> <span class="o">=</span> <span class="n">stop</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a>        <span class="k">return</span> <span class="n">slices</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>        <span class="n">slices</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>        <span class="n">left</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>        <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>        <span class="k">while</span> <span class="n">left</span><span class="p">:</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>            <span class="n">stop</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">size</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>            <span class="n">slices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">])</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>            <span class="n">left</span> <span class="o">-=</span> <span class="n">size</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>            <span class="n">start</span> <span class="o">=</span> <span class="n">stop</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>        <span class="k">return</span> <span class="n">slices</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="ray.rllib.policy.sample_batch.SampleBatch.to_device">
<code class="highlight language-python"><span class="n">to_device</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">framework</span><span class="o">=</span><span class="s1">&#39;torch&#39;</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      

        <details class="quote">
          <summary>Source code in <code>ray/rllib/policy/sample_batch.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="k">def</span> <span class="nf">to_device</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">framework</span><span class="o">=</span><span class="s2">&quot;torch&quot;</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot;TODO: transfer batch to given device as framework tensor.&quot;&quot;&quot;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>    <span class="k">if</span> <span class="n">framework</span> <span class="o">==</span> <span class="s2">&quot;torch&quot;</span><span class="p">:</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>        <span class="k">assert</span> <span class="n">torch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a>        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="n">v</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">object</span><span class="p">:</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a>                <span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a>        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a>    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div>
        </details>
    </div>

  </div>






  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h2 class="doc doc-heading" id="ray.rllib.evaluation.sample_batch_builder.SampleBatchBuilder">
        <code>
ray.rllib.evaluation.sample_batch_builder.SampleBatchBuilder        </code>



</h2>

    <div class="doc doc-contents first">

      <p>Util to build a SampleBatch incrementally.</p>
<p>For efficiency, SampleBatches hold values in column form (as arrays).
However, it is useful to add data one row (dict) at a time.</p>




  <div class="doc doc-children">










  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="ray.rllib.evaluation.sample_batch_builder.SampleBatchBuilder.add_batch">
<code class="highlight language-python"><span class="n">add_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Add the given batch of values to this batch.</p>

        <details class="quote">
          <summary>Source code in <code>ray/rllib/evaluation/sample_batch_builder.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="k">def</span> <span class="nf">add_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">:</span> <span class="n">SampleBatch</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot;Add the given batch of values to this batch.&quot;&quot;&quot;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">batch</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">buffers</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">column</span><span class="p">)</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">+=</span> <span class="n">batch</span><span class="o">.</span><span class="n">count</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="ray.rllib.evaluation.sample_batch_builder.SampleBatchBuilder.add_values">
<code class="highlight language-python"><span class="n">add_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">values</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Add the given dictionary (row) of values to this batch.</p>

        <details class="quote">
          <summary>Source code in <code>ray/rllib/evaluation/sample_batch_builder.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="k">def</span> <span class="nf">add_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">values</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot;Add the given dictionary (row) of values to this batch.&quot;&quot;&quot;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">values</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">buffers</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="ray.rllib.evaluation.sample_batch_builder.SampleBatchBuilder.build_and_reset">
<code class="highlight language-python"><span class="n">build_and_reset</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Returns a sample batch including all previously added values.</p>

        <details class="quote">
          <summary>Source code in <code>ray/rllib/evaluation/sample_batch_builder.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="k">def</span> <span class="nf">build_and_reset</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SampleBatch</span><span class="p">:</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot;Returns a sample batch including all previously added values.&quot;&quot;&quot;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>    <span class="n">batch</span> <span class="o">=</span> <span class="n">SampleBatch</span><span class="p">(</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a>        <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">to_float_array</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a>         <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffers</span><span class="o">.</span><span class="n">items</span><span class="p">()})</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a>    <span class="k">if</span> <span class="n">SampleBatch</span><span class="o">.</span><span class="n">UNROLL_ID</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">:</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a>        <span class="n">batch</span><span class="p">[</span><span class="n">SampleBatch</span><span class="o">.</span><span class="n">UNROLL_ID</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a>            <span class="n">SampleBatchBuilder</span><span class="o">.</span><span class="n">_next_unroll_id</span><span class="p">,</span> <span class="n">batch</span><span class="o">.</span><span class="n">count</span><span class="p">)</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a>        <span class="n">SampleBatchBuilder</span><span class="o">.</span><span class="n">_next_unroll_id</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">buffers</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a>    <span class="k">return</span> <span class="n">batch</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h2 class="doc doc-heading" id="ray.rllib.policy.sample_batch.MultiAgentBatch">
        <code>
ray.rllib.policy.sample_batch.MultiAgentBatch        </code>



</h2>

    <div class="doc doc-contents first">

      <p>A batch of experiences from multiple agents in the environment.</p>

<p><strong>Attributes:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>policy_batches</code></td>
        <td><code>Dict[PolicyID, SampleBatch]</code></td>
        <td><p>Mapping from policy
ids to SampleBatches of experiences.</p></td>
      </tr>
      <tr>
        <td><code>count</code></td>
        <td><code>int</code></td>
        <td><p>The number of env steps in this batch.</p></td>
      </tr>
  </tbody>
</table>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="ray.rllib.policy.sample_batch.MultiAgentBatch.__init__">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">policy_batches</span><span class="p">,</span> <span class="n">env_steps</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

</h3>

    <div class="doc doc-contents ">

      <p>Initialize a MultiAgentBatch object.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>policy_batches</code></td>
        <td><code>Dict[PolicyID, SampleBatch]</code></td>
        <td><p>Mapping from policy
ids to SampleBatches of experiences.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>env_steps</code></td>
        <td><code>int</code></td>
        <td><p>The number of environment steps in the environment
this batch contains. This will be less than the number of
transitions this batch contains across all policies in total.</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>ray/rllib/policy/sample_batch.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nd">@PublicAPI</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">policy_batches</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">PolicyID</span><span class="p">,</span> <span class="n">SampleBatch</span><span class="p">],</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>             <span class="n">env_steps</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>    <span class="sd">&quot;&quot;&quot;Initialize a MultiAgentBatch object.</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="sd">        policy_batches (Dict[PolicyID, SampleBatch]): Mapping from policy</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="sd">            ids to SampleBatches of experiences.</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="sd">        env_steps (int): The number of environment steps in the environment</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="sd">            this batch contains. This will be less than the number of</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="sd">            transitions this batch contains across all policies in total.</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a>    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">policy_batches</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a>        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">SampleBatch</span><span class="p">)</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">policy_batches</span> <span class="o">=</span> <span class="n">policy_batches</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a>    <span class="c1"># Called &quot;count&quot; for uniformity with SampleBatch.</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a>    <span class="c1"># Prefer to access this via the `env_steps()` method when possible</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a>    <span class="c1"># for clarity.</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="n">env_steps</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="ray.rllib.policy.sample_batch.MultiAgentBatch.agent_steps">
<code class="highlight language-python"><span class="n">agent_steps</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>The number of agent steps (there are &gt;= 1 agent steps per env step).</p>

<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>int</code></td>
      <td><p>The number of agent steps total in this batch.</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>ray/rllib/policy/sample_batch.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nd">@PublicAPI</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="k">def</span> <span class="nf">agent_steps</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>    <span class="sd">&quot;&quot;&quot;The number of agent steps (there are &gt;= 1 agent steps per env step).</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="sd">        int: The number of agent steps total in this batch.</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a>    <span class="n">ct</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a>    <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">policy_batches</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a>        <span class="n">ct</span> <span class="o">+=</span> <span class="n">batch</span><span class="o">.</span><span class="n">count</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a>    <span class="k">return</span> <span class="n">ct</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="ray.rllib.policy.sample_batch.MultiAgentBatch.compress">
<code class="highlight language-python"><span class="n">compress</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bulk</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="nb">frozenset</span><span class="p">({</span><span class="s1">&#39;new_obs&#39;</span><span class="p">,</span> <span class="s1">&#39;obs&#39;</span><span class="p">}))</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Compresses each policy batch (per column) in place.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>bulk</code></td>
        <td><code>bool</code></td>
        <td><p>Whether to compress across the batch dimension (0)
as well. If False will compress n separate list items, where n
is the batch size.</p></td>
        <td><code>False</code></td>
      </tr>
      <tr>
        <td><code>columns</code></td>
        <td><code>Set[str]</code></td>
        <td><p>Set of column names to compress.</p></td>
        <td><code>frozenset({&#39;new_obs&#39;, &#39;obs&#39;})</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>ray/rllib/policy/sample_batch.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nd">@DeveloperAPI</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="k">def</span> <span class="nf">compress</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>             <span class="n">bulk</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>             <span class="n">columns</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">([</span><span class="s2">&quot;obs&quot;</span><span class="p">,</span> <span class="s2">&quot;new_obs&quot;</span><span class="p">]))</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a>    <span class="sd">&quot;&quot;&quot;Compresses each policy batch (per column) in place.</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="sd">        bulk (bool): Whether to compress across the batch dimension (0)</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="sd">            as well. If False will compress n separate list items, where n</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="sd">            is the batch size.</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="sd">        columns (Set[str]): Set of column names to compress.</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a>    <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">policy_batches</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a>        <span class="n">batch</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">bulk</span><span class="o">=</span><span class="n">bulk</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">columns</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="ray.rllib.policy.sample_batch.MultiAgentBatch.concat_samples">
<code class="highlight language-python"><span class="n">concat_samples</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-staticmethod"><code>staticmethod</code></small>
  </span>

</h3>

    <div class="doc doc-contents ">

      <p>Concatenates a list of MultiAgentBatches into a new MultiAgentBatch.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>samples</code></td>
        <td><code>List[MultiAgentBatch]</code></td>
        <td><p>List of MultiagentBatch objects
to concatenate.</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>MultiAgentBatch</code></td>
      <td><p>A new MultiAgentBatch consisting of the
    concatenated inputs.</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>ray/rllib/policy/sample_batch.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nd">@staticmethod</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="nd">@PublicAPI</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="k">def</span> <span class="nf">concat_samples</span><span class="p">(</span><span class="n">samples</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="s2">&quot;MultiAgentBatch&quot;</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s2">&quot;MultiAgentBatch&quot;</span><span class="p">:</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>    <span class="sd">&quot;&quot;&quot;Concatenates a list of MultiAgentBatches into a new MultiAgentBatch.</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="sd">        samples (List[MultiAgentBatch]): List of MultiagentBatch objects</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="sd">            to concatenate.</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="sd">        MultiAgentBatch: A new MultiAgentBatch consisting of the</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="sd">            concatenated inputs.</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a>    <span class="n">policy_batches</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a>    <span class="n">env_steps</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a>    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">samples</span><span class="p">:</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a>        <span class="c1"># Some batches in `samples` are not MultiAgentBatch.</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">MultiAgentBatch</span><span class="p">):</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a>            <span class="c1"># If empty SampleBatch: ok (just ignore).</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">SampleBatch</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a>                <span class="k">continue</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a>            <span class="c1"># Otherwise: Error.</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a>                <span class="s2">&quot;`MultiAgentBatch.concat_samples()` can only concat &quot;</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a>                <span class="s2">&quot;MultiAgentBatch types, not </span><span class="si">{}</span><span class="s2">!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">))</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a>        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">policy_batches</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a>            <span class="n">policy_batches</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a>        <span class="n">env_steps</span> <span class="o">+=</span> <span class="n">s</span><span class="o">.</span><span class="n">env_steps</span><span class="p">()</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a>    <span class="n">out</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a>    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">batches</span> <span class="ow">in</span> <span class="n">policy_batches</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a>        <span class="n">out</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">SampleBatch</span><span class="o">.</span><span class="n">concat_samples</span><span class="p">(</span><span class="n">batches</span><span class="p">)</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a>    <span class="k">return</span> <span class="n">MultiAgentBatch</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">env_steps</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="ray.rllib.policy.sample_batch.MultiAgentBatch.copy">
<code class="highlight language-python"><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Deep-copies self into a new MultiAgentBatch.</p>

<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>MultiAgentBatch</code></td>
      <td><p>The copy of self with deep-copied data.</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>ray/rllib/policy/sample_batch.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nd">@PublicAPI</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;MultiAgentBatch&quot;</span><span class="p">:</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>    <span class="sd">&quot;&quot;&quot;Deep-copies self into a new MultiAgentBatch.</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="sd">        MultiAgentBatch: The copy of self with deep-copied data.</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a>    <span class="k">return</span> <span class="n">MultiAgentBatch</span><span class="p">(</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a>        <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a>         <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">policy_batches</span><span class="o">.</span><span class="n">items</span><span class="p">()},</span> <span class="bp">self</span><span class="o">.</span><span class="n">count</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="ray.rllib.policy.sample_batch.MultiAgentBatch.decompress_if_needed">
<code class="highlight language-python"><span class="n">decompress_if_needed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="nb">frozenset</span><span class="p">({</span><span class="s1">&#39;new_obs&#39;</span><span class="p">,</span> <span class="s1">&#39;obs&#39;</span><span class="p">}))</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Decompresses each policy batch (per column), if already compressed.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>columns</code></td>
        <td><code>Set[str]</code></td>
        <td><p>Set of column names to decompress.</p></td>
        <td><code>frozenset({&#39;new_obs&#39;, &#39;obs&#39;})</code></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>MultiAgentBatch</code></td>
      <td><p>This very MultiAgentBatch.</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>ray/rllib/policy/sample_batch.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nd">@DeveloperAPI</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="k">def</span> <span class="nf">decompress_if_needed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>                         <span class="n">columns</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">(</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>                             <span class="p">[</span><span class="s2">&quot;obs&quot;</span><span class="p">,</span> <span class="s2">&quot;new_obs&quot;</span><span class="p">]))</span> <span class="o">-&gt;</span> <span class="s2">&quot;MultiAgentBatch&quot;</span><span class="p">:</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a>    <span class="sd">&quot;&quot;&quot;Decompresses each policy batch (per column), if already compressed.</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="sd">        columns (Set[str]): Set of column names to decompress.</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="sd">        MultiAgentBatch: This very MultiAgentBatch.</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a>    <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">policy_batches</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a>        <span class="n">batch</span><span class="o">.</span><span class="n">decompress_if_needed</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a>    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="ray.rllib.policy.sample_batch.MultiAgentBatch.env_steps">
<code class="highlight language-python"><span class="n">env_steps</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>The number of env steps (there are &gt;= 1 agent steps per env step).</p>

<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>int</code></td>
      <td><p>The number of environment steps contained in this batch.</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>ray/rllib/policy/sample_batch.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nd">@PublicAPI</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="k">def</span> <span class="nf">env_steps</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>    <span class="sd">&quot;&quot;&quot;The number of env steps (there are &gt;= 1 agent steps per env step).</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="sd">        int: The number of environment steps contained in this batch.</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a>    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">count</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="ray.rllib.policy.sample_batch.MultiAgentBatch.size_bytes">
<code class="highlight language-python"><span class="n">size_bytes</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">


<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>int</code></td>
      <td><p>The overall size in bytes of all policy batches (all columns).</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>ray/rllib/policy/sample_batch.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nd">@PublicAPI</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="k">def</span> <span class="nf">size_bytes</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>    <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="sd">        int: The overall size in bytes of all policy batches (all columns).</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a>    <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">size_bytes</span><span class="p">()</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">policy_batches</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="ray.rllib.policy.sample_batch.MultiAgentBatch.timeslices">
<code class="highlight language-python"><span class="n">timeslices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Returns k-step batches holding data for each agent at those steps.</p>
<p>For examples, suppose we have agent1 observations [a1t1, a1t2, a1t3],
for agent2, [a2t1, a2t3], and for agent3, [a3t3] only.</p>
<p>Calling timeslices(1) would return three MultiAgentBatches containing
[a1t1, a2t1], [a1t2], and [a1t3, a2t3, a3t3].</p>
<p>Calling timeslices(2) would return two MultiAgentBatches containing
[a1t1, a1t2, a2t1], and [a1t3, a2t3, a3t3].</p>
<p>This method is used to implement "lockstep" replay mode. Note that this
method does not guarantee each batch contains only data from a single
unroll. Batches might contain data from multiple different envs.</p>

        <details class="quote">
          <summary>Source code in <code>ray/rllib/policy/sample_batch.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nd">@PublicAPI</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="k">def</span> <span class="nf">timeslices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="s2">&quot;MultiAgentBatch&quot;</span><span class="p">]:</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>    <span class="sd">&quot;&quot;&quot;Returns k-step batches holding data for each agent at those steps.</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="sd">    For examples, suppose we have agent1 observations [a1t1, a1t2, a1t3],</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="sd">    for agent2, [a2t1, a2t3], and for agent3, [a3t3] only.</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="sd">    Calling timeslices(1) would return three MultiAgentBatches containing</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="sd">    [a1t1, a2t1], [a1t2], and [a1t3, a2t3, a3t3].</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="sd">    Calling timeslices(2) would return two MultiAgentBatches containing</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="sd">    [a1t1, a1t2, a2t1], and [a1t3, a2t3, a3t3].</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="sd">    This method is used to implement &quot;lockstep&quot; replay mode. Note that this</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="sd">    method does not guarantee each batch contains only data from a single</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="sd">    unroll. Batches might contain data from multiple different envs.</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a>    <span class="kn">from</span> <span class="nn">ray.rllib.evaluation.sample_batch_builder</span> <span class="kn">import</span> \
<a id="__codelineno-0-19" name="__codelineno-0-19"></a>        <span class="n">SampleBatchBuilder</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a>    <span class="c1"># Build a sorted set of (eps_id, t, policy_id, data...)</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a>    <span class="n">steps</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a>    <span class="k">for</span> <span class="n">policy_id</span><span class="p">,</span> <span class="n">batch</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">policy_batches</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a>        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">batch</span><span class="o">.</span><span class="n">rows</span><span class="p">():</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a>            <span class="n">steps</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">row</span><span class="p">[</span><span class="n">SampleBatch</span><span class="o">.</span><span class="n">EPS_ID</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="n">SampleBatch</span><span class="o">.</span><span class="n">T</span><span class="p">],</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a>                          <span class="n">row</span><span class="p">[</span><span class="n">SampleBatch</span><span class="o">.</span><span class="n">AGENT_INDEX</span><span class="p">],</span> <span class="n">policy_id</span><span class="p">,</span> <span class="n">row</span><span class="p">))</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a>    <span class="n">steps</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a>    <span class="n">finished_slices</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a>    <span class="n">cur_slice</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="n">SampleBatchBuilder</span><span class="p">)</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a>    <span class="n">cur_slice_size</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a>    <span class="k">def</span> <span class="nf">finish_slice</span><span class="p">():</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a>        <span class="k">nonlocal</span> <span class="n">cur_slice_size</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a>        <span class="k">assert</span> <span class="n">cur_slice_size</span> <span class="o">&gt;</span> <span class="mi">0</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a>        <span class="n">batch</span> <span class="o">=</span> <span class="n">MultiAgentBatch</span><span class="p">(</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a>            <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">build_and_reset</span><span class="p">()</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a>             <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">cur_slice</span><span class="o">.</span><span class="n">items</span><span class="p">()},</span> <span class="n">cur_slice_size</span><span class="p">)</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a>        <span class="n">cur_slice_size</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a>        <span class="n">finished_slices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>    <span class="c1"># For each unique env timestep.</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">steps</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[:</span><span class="mi">2</span><span class="p">]):</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>        <span class="c1"># Accumulate into the current slice.</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">policy_id</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">group</span><span class="p">:</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>            <span class="n">cur_slice</span><span class="p">[</span><span class="n">policy_id</span><span class="p">]</span><span class="o">.</span><span class="n">add_values</span><span class="p">(</span><span class="o">**</span><span class="n">row</span><span class="p">)</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>        <span class="n">cur_slice_size</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>        <span class="c1"># Slice has reached target number of env steps.</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>        <span class="k">if</span> <span class="n">cur_slice_size</span> <span class="o">&gt;=</span> <span class="n">k</span><span class="p">:</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>            <span class="n">finish_slice</span><span class="p">()</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>            <span class="k">assert</span> <span class="n">cur_slice_size</span> <span class="o">==</span> <span class="mi">0</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>    <span class="k">if</span> <span class="n">cur_slice_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>        <span class="n">finish_slice</span><span class="p">()</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">finished_slices</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">finished_slices</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>    <span class="k">return</span> <span class="n">finished_slices</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="ray.rllib.policy.sample_batch.MultiAgentBatch.wrap_as_needed">
<code class="highlight language-python"><span class="n">wrap_as_needed</span><span class="p">(</span><span class="n">policy_batches</span><span class="p">,</span> <span class="n">env_steps</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-staticmethod"><code>staticmethod</code></small>
  </span>

</h3>

    <div class="doc doc-contents ">

      <p>Returns SampleBatch or MultiAgentBatch, depending on given policies.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>policy_batches</code></td>
        <td><code>Dict[PolicyID, SampleBatch]</code></td>
        <td><p>Mapping from policy
ids to SampleBatch.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>env_steps</code></td>
        <td><code>int</code></td>
        <td><p>Number of env steps in the batch.</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>Union[SampleBatch, MultiAgentBatch]</code></td>
      <td><p>The single default policy's
    SampleBatch or a MultiAgentBatch (more than one policy).</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>ray/rllib/policy/sample_batch.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nd">@staticmethod</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="nd">@PublicAPI</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="k">def</span> <span class="nf">wrap_as_needed</span><span class="p">(</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>        <span class="n">policy_batches</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">PolicyID</span><span class="p">,</span> <span class="n">SampleBatch</span><span class="p">],</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a>        <span class="n">env_steps</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">SampleBatch</span><span class="p">,</span> <span class="s2">&quot;MultiAgentBatch&quot;</span><span class="p">]:</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a>    <span class="sd">&quot;&quot;&quot;Returns SampleBatch or MultiAgentBatch, depending on given policies.</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="sd">        policy_batches (Dict[PolicyID, SampleBatch]): Mapping from policy</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="sd">            ids to SampleBatch.</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="sd">        env_steps (int): Number of env steps in the batch.</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="sd">        Union[SampleBatch, MultiAgentBatch]: The single default policy&#39;s</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="sd">            SampleBatch or a MultiAgentBatch (more than one policy).</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">policy_batches</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">DEFAULT_POLICY_ID</span> <span class="ow">in</span> <span class="n">policy_batches</span><span class="p">:</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a>        <span class="k">return</span> <span class="n">policy_batches</span><span class="p">[</span><span class="n">DEFAULT_POLICY_ID</span><span class="p">]</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a>    <span class="k">return</span> <span class="n">MultiAgentBatch</span><span class="p">(</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a>        <span class="n">policy_batches</span><span class="o">=</span><span class="n">policy_batches</span><span class="p">,</span> <span class="n">env_steps</span><span class="o">=</span><span class="n">env_steps</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h2 class="doc doc-heading" id="ray.rllib.evaluation.sample_batch_builder.MultiAgentSampleBatchBuilder">
        <code>
ray.rllib.evaluation.sample_batch_builder.MultiAgentSampleBatchBuilder        </code>



</h2>

    <div class="doc doc-contents first">

      <p>Util to build SampleBatches for each policy in a multi-agent env.</p>
<p>Input data is per-agent, while output data is per-policy. There is an M:N
mapping between agents and policies. We retain one local batch builder
per agent. When an agent is done, then its local batch is appended into the
corresponding policy batch for the agent's policy.</p>




  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="ray.rllib.evaluation.sample_batch_builder.MultiAgentSampleBatchBuilder.__init__">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">policy_map</span><span class="p">,</span> <span class="n">clip_rewards</span><span class="p">,</span> <span class="n">callbacks</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

</h3>

    <div class="doc doc-contents ">

      <p>Initialize a MultiAgentSampleBatchBuilder.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>policy_map</code></td>
        <td><code>Dict[str,Policy]</code></td>
        <td><p>Maps policy ids to policy instances.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>clip_rewards</code></td>
        <td><code>Union[bool,float]</code></td>
        <td><p>Whether to clip rewards before
postprocessing (at +/-1.0) or the actual value to +/- clip.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>callbacks</code></td>
        <td><code>DefaultCallbacks</code></td>
        <td><p>RLlib callbacks.</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>ray/rllib/evaluation/sample_batch_builder.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">policy_map</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">PolicyID</span><span class="p">,</span> <span class="n">Policy</span><span class="p">],</span> <span class="n">clip_rewards</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a>             <span class="n">callbacks</span><span class="p">:</span> <span class="s2">&quot;DefaultCallbacks&quot;</span><span class="p">):</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>    <span class="sd">&quot;&quot;&quot;Initialize a MultiAgentSampleBatchBuilder.</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="sd">        policy_map (Dict[str,Policy]): Maps policy ids to policy instances.</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="sd">        clip_rewards (Union[bool,float]): Whether to clip rewards before</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="sd">            postprocessing (at +/-1.0) or the actual value to +/- clip.</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="sd">        callbacks (DefaultCallbacks): RLlib callbacks.</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a>    <span class="k">if</span> <span class="n">log_once</span><span class="p">(</span><span class="s2">&quot;MultiAgentSampleBatchBuilder&quot;</span><span class="p">):</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a>        <span class="n">deprecation_warning</span><span class="p">(</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a>            <span class="n">old</span><span class="o">=</span><span class="s2">&quot;MultiAgentSampleBatchBuilder&quot;</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">policy_map</span> <span class="o">=</span> <span class="n">policy_map</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">clip_rewards</span> <span class="o">=</span> <span class="n">clip_rewards</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a>    <span class="c1"># Build the Policies&#39; SampleBatchBuilders.</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">policy_builders</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a>        <span class="n">k</span><span class="p">:</span> <span class="n">SampleBatchBuilder</span><span class="p">()</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a>        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">policy_map</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a>    <span class="p">}</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a>    <span class="c1"># Whenever we observe a new agent, add a new SampleBatchBuilder for</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a>    <span class="c1"># this agent.</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">agent_builders</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a>    <span class="c1"># Internal agent-to-policy map.</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">agent_to_policy</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span> <span class="o">=</span> <span class="n">callbacks</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a>    <span class="c1"># Number of &quot;inference&quot; steps taken in the environment.</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a>    <span class="c1"># Regardless of the number of agents involved in each of these steps.</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="ray.rllib.evaluation.sample_batch_builder.MultiAgentSampleBatchBuilder.add_values">
<code class="highlight language-python"><span class="n">add_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent_id</span><span class="p">,</span> <span class="n">policy_id</span><span class="p">,</span> <span class="o">**</span><span class="n">values</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Add the given dictionary (row) of values to this batch.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>agent_id</code></td>
        <td><code>obj</code></td>
        <td><p>Unique id for the agent we are adding values for.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>policy_id</code></td>
        <td><code>obj</code></td>
        <td><p>Unique id for policy controlling the agent.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>values</code></td>
        <td><code>dict</code></td>
        <td><p>Row of values to add for this agent.</p></td>
        <td><code>{}</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>ray/rllib/evaluation/sample_batch_builder.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nd">@DeveloperAPI</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="k">def</span> <span class="nf">add_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent_id</span><span class="p">:</span> <span class="n">AgentID</span><span class="p">,</span> <span class="n">policy_id</span><span class="p">:</span> <span class="n">AgentID</span><span class="p">,</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>               <span class="o">**</span><span class="n">values</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>    <span class="sd">&quot;&quot;&quot;Add the given dictionary (row) of values to this batch.</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="sd">        agent_id (obj): Unique id for the agent we are adding values for.</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="sd">        policy_id (obj): Unique id for policy controlling the agent.</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="sd">        values (dict): Row of values to add for this agent.</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a>    <span class="k">if</span> <span class="n">agent_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent_builders</span><span class="p">:</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">agent_builders</span><span class="p">[</span><span class="n">agent_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">SampleBatchBuilder</span><span class="p">()</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">agent_to_policy</span><span class="p">[</span><span class="n">agent_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">policy_id</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a>    <span class="c1"># Include the current agent id for multi-agent algorithms.</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a>    <span class="k">if</span> <span class="n">agent_id</span> <span class="o">!=</span> <span class="n">_DUMMY_AGENT_ID</span><span class="p">:</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a>        <span class="n">values</span><span class="p">[</span><span class="s2">&quot;agent_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">agent_id</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">agent_builders</span><span class="p">[</span><span class="n">agent_id</span><span class="p">]</span><span class="o">.</span><span class="n">add_values</span><span class="p">(</span><span class="o">**</span><span class="n">values</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="ray.rllib.evaluation.sample_batch_builder.MultiAgentSampleBatchBuilder.build_and_reset">
<code class="highlight language-python"><span class="n">build_and_reset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">episode</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Returns the accumulated sample batches for each policy.</p>
<p>Any unprocessed rows will be first postprocessed with a policy
postprocessor. The internal state of this builder will be reset.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>episode</code></td>
        <td><code>Optional[Episode]</code></td>
        <td><p>The Episode object that
holds this MultiAgentBatchBuilder object or None.</p></td>
        <td><code>None</code></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>MultiAgentBatch</code></td>
      <td><p>Returns the accumulated sample batches for each
    policy.</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>ray/rllib/evaluation/sample_batch_builder.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nd">@DeveloperAPI</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="k">def</span> <span class="nf">build_and_reset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>                    <span class="n">episode</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Episode</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MultiAgentBatch</span><span class="p">:</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>    <span class="sd">&quot;&quot;&quot;Returns the accumulated sample batches for each policy.</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="sd">    Any unprocessed rows will be first postprocessed with a policy</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="sd">    postprocessor. The internal state of this builder will be reset.</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="sd">        episode (Optional[Episode]): The Episode object that</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="sd">            holds this MultiAgentBatchBuilder object or None.</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="sd">        MultiAgentBatch: Returns the accumulated sample batches for each</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="sd">            policy.</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">postprocess_batch_so_far</span><span class="p">(</span><span class="n">episode</span><span class="p">)</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a>    <span class="n">policy_batches</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a>    <span class="k">for</span> <span class="n">policy_id</span><span class="p">,</span> <span class="n">builder</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">policy_builders</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a>        <span class="k">if</span> <span class="n">builder</span><span class="o">.</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a>            <span class="n">policy_batches</span><span class="p">[</span><span class="n">policy_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">build_and_reset</span><span class="p">()</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a>    <span class="n">old_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">count</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a>    <span class="k">return</span> <span class="n">MultiAgentBatch</span><span class="o">.</span><span class="n">wrap_as_needed</span><span class="p">(</span><span class="n">policy_batches</span><span class="p">,</span> <span class="n">old_count</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>




  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="ray.rllib.evaluation.sample_batch_builder.MultiAgentSampleBatchBuilder.has_pending_agent_data">
<code class="highlight language-python"><span class="n">has_pending_agent_data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Returns whether there is pending unprocessed data.</p>

<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>bool</code></td>
      <td><p>True if there is at least one per-agent builder (with data
    in it).</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>ray/rllib/evaluation/sample_batch_builder.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="k">def</span> <span class="nf">has_pending_agent_data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot;Returns whether there is pending unprocessed data.</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="sd">        bool: True if there is at least one per-agent builder (with data</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="sd">            in it).</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a>    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent_builders</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="ray.rllib.evaluation.sample_batch_builder.MultiAgentSampleBatchBuilder.postprocess_batch_so_far">
<code class="highlight language-python"><span class="n">postprocess_batch_so_far</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">episode</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Apply policy postprocessors to any unprocessed rows.</p>
<p>This pushes the postprocessed per-agent batches onto the per-policy
builders, clearing per-agent state.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>episode</code></td>
        <td><code>Optional[Episode]</code></td>
        <td><p>The Episode object that
holds this MultiAgentBatchBuilder object.</p></td>
        <td><code>None</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>ray/rllib/evaluation/sample_batch_builder.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="k">def</span> <span class="nf">postprocess_batch_so_far</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a>                             <span class="n">episode</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Episode</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>    <span class="sd">&quot;&quot;&quot;Apply policy postprocessors to any unprocessed rows.</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="sd">    This pushes the postprocessed per-agent batches onto the per-policy</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="sd">    builders, clearing per-agent state.</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="sd">        episode (Optional[Episode]): The Episode object that</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="sd">            holds this MultiAgentBatchBuilder object.</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a>    <span class="c1"># Materialize the batches so far.</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a>    <span class="n">pre_batches</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a>    <span class="k">for</span> <span class="n">agent_id</span><span class="p">,</span> <span class="n">builder</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent_builders</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a>        <span class="n">pre_batches</span><span class="p">[</span><span class="n">agent_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">policy_map</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">agent_to_policy</span><span class="p">[</span><span class="n">agent_id</span><span class="p">]],</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a>            <span class="n">builder</span><span class="o">.</span><span class="n">build_and_reset</span><span class="p">())</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a>    <span class="c1"># Apply postprocessor.</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a>    <span class="n">post_batches</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">clip_rewards</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a>        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">pre_batch</span><span class="p">)</span> <span class="ow">in</span> <span class="n">pre_batches</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a>            <span class="n">pre_batch</span><span class="p">[</span><span class="s2">&quot;rewards&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">pre_batch</span><span class="p">[</span><span class="s2">&quot;rewards&quot;</span><span class="p">])</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a>    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">clip_rewards</span><span class="p">:</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a>        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">pre_batch</span><span class="p">)</span> <span class="ow">in</span> <span class="n">pre_batches</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a>            <span class="n">pre_batch</span><span class="p">[</span><span class="s2">&quot;rewards&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a>                <span class="n">pre_batch</span><span class="p">[</span><span class="s2">&quot;rewards&quot;</span><span class="p">],</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a>                <span class="n">a_min</span><span class="o">=-</span><span class="bp">self</span><span class="o">.</span><span class="n">clip_rewards</span><span class="p">,</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a>                <span class="n">a_max</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">clip_rewards</span><span class="p">)</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a>    <span class="k">for</span> <span class="n">agent_id</span><span class="p">,</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">pre_batch</span><span class="p">)</span> <span class="ow">in</span> <span class="n">pre_batches</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a>        <span class="n">other_batches</span> <span class="o">=</span> <span class="n">pre_batches</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a>        <span class="k">del</span> <span class="n">other_batches</span><span class="p">[</span><span class="n">agent_id</span><span class="p">]</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a>        <span class="n">policy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">policy_map</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">agent_to_policy</span><span class="p">[</span><span class="n">agent_id</span><span class="p">]]</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a>        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">pre_batch</span><span class="p">[</span><span class="s2">&quot;dones&quot;</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a>                <span class="n">pre_batch</span><span class="p">[</span><span class="s2">&quot;eps_id&quot;</span><span class="p">]))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a>                <span class="s2">&quot;Batches sent to postprocessing must only contain steps &quot;</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a>                <span class="s2">&quot;from a single trajectory.&quot;</span><span class="p">,</span> <span class="n">pre_batch</span><span class="p">)</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a>        <span class="c1"># Call the Policy&#39;s Exploration&#39;s postprocess method.</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>        <span class="n">post_batches</span><span class="p">[</span><span class="n">agent_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">pre_batch</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">policy</span><span class="p">,</span> <span class="s2">&quot;exploration&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>            <span class="n">policy</span><span class="o">.</span><span class="n">exploration</span><span class="o">.</span><span class="n">postprocess_trajectory</span><span class="p">(</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>                <span class="n">policy</span><span class="p">,</span> <span class="n">post_batches</span><span class="p">[</span><span class="n">agent_id</span><span class="p">],</span> <span class="n">policy</span><span class="o">.</span><span class="n">get_session</span><span class="p">())</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>        <span class="n">post_batches</span><span class="p">[</span><span class="n">agent_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">policy</span><span class="o">.</span><span class="n">postprocess_trajectory</span><span class="p">(</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>            <span class="n">post_batches</span><span class="p">[</span><span class="n">agent_id</span><span class="p">],</span> <span class="n">other_batches</span><span class="p">,</span> <span class="n">episode</span><span class="p">)</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>    <span class="k">if</span> <span class="n">log_once</span><span class="p">(</span><span class="s2">&quot;after_post&quot;</span><span class="p">):</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>            <span class="s2">&quot;Trajectory fragment after postprocess_trajectory():</span><span class="se">\n\n</span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>            <span class="nb">format</span><span class="p">(</span><span class="n">summarize</span><span class="p">(</span><span class="n">post_batches</span><span class="p">)))</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>    <span class="c1"># Append into policy batches and reset</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>    <span class="kn">from</span> <span class="nn">ray.rllib.evaluation.rollout_worker</span> <span class="kn">import</span> <span class="n">get_global_worker</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>    <span class="k">for</span> <span class="n">agent_id</span><span class="p">,</span> <span class="n">post_batch</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">post_batches</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">on_postprocess_trajectory</span><span class="p">(</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>            <span class="n">worker</span><span class="o">=</span><span class="n">get_global_worker</span><span class="p">(),</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>            <span class="n">episode</span><span class="o">=</span><span class="n">episode</span><span class="p">,</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>            <span class="n">agent_id</span><span class="o">=</span><span class="n">agent_id</span><span class="p">,</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>            <span class="n">policy_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">agent_to_policy</span><span class="p">[</span><span class="n">agent_id</span><span class="p">],</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>            <span class="n">policies</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">policy_map</span><span class="p">,</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>            <span class="n">postprocessed_batch</span><span class="o">=</span><span class="n">post_batch</span><span class="p">,</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>            <span class="n">original_batches</span><span class="o">=</span><span class="n">pre_batches</span><span class="p">)</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">policy_builders</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">agent_to_policy</span><span class="p">[</span><span class="n">agent_id</span><span class="p">]]</span><span class="o">.</span><span class="n">add_batch</span><span class="p">(</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>            <span class="n">post_batch</span><span class="p">)</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">agent_builders</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">agent_to_policy</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="ray.rllib.evaluation.sample_batch_builder.MultiAgentSampleBatchBuilder.total">
<code class="highlight language-python"><span class="n">total</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Returns the total number of steps taken in the env (all agents).</p>

<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>int</code></td>
      <td><p>The number of steps taken in total in the environment over all
    agents.</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>ray/rllib/evaluation/sample_batch_builder.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="k">def</span> <span class="nf">total</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot;Returns the total number of steps taken in the env (all agents).</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="sd">        int: The number of steps taken in total in the environment over all</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="sd">            agents.</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a>    <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">count</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent_builders</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>

<h2 id="samplers">Samplers</h2>


  <div class="doc doc-object doc-class">



<h2 class="doc doc-heading" id="ray.rllib.evaluation.sampler.SyncSampler">
        <code>
ray.rllib.evaluation.sampler.SyncSampler            (<span title="ray.rllib.evaluation.sampler.SamplerInput">SamplerInput</span>)
        </code>



</h2>

    <div class="doc doc-contents first">

      <p>Sync SamplerInput that collects experiences when <code>get_data()</code> is called.</p>




  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="ray.rllib.evaluation.sampler.SyncSampler.__init__">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">worker</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">clip_rewards</span><span class="p">,</span> <span class="n">rollout_fragment_length</span><span class="p">,</span> <span class="n">count_steps_by</span><span class="o">=</span><span class="s1">&#39;env_steps&#39;</span><span class="p">,</span> <span class="n">callbacks</span><span class="p">,</span> <span class="n">horizon</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">multiple_episodes_in_batch</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">normalize_actions</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">clip_actions</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">soft_horizon</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">no_done_at_end</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">observation_fn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sample_collector_class</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">render</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">policies</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">policy_mapping_fn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">preprocessors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">obs_filters</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tf_sess</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

</h3>

    <div class="doc doc-contents ">

      <p>Initializes a SyncSampler instance.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>worker</code></td>
        <td><code>RolloutWorker</code></td>
        <td><p>The RolloutWorker that will use this Sampler for sampling.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>env</code></td>
        <td><code>BaseEnv</code></td>
        <td><p>Any Env object. Will be converted into an RLlib BaseEnv.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>clip_rewards</code></td>
        <td><code>Union[bool, float]</code></td>
        <td><p>True for +/-1.0 clipping,
actual float value for +/- value clipping. False for no
clipping.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>rollout_fragment_length</code></td>
        <td><code>int</code></td>
        <td><p>The length of a fragment to collect
before building a SampleBatch from the data and resetting
the SampleBatchBuilder object.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>count_steps_by</code></td>
        <td><code>str</code></td>
        <td><p>One of "env_steps" (default) or "agent_steps".
Use "agent_steps", if you want rollout lengths to be counted
by individual agent steps. In a multi-agent env,
a single env_step contains one or more agent_steps, depending
on how many agents are present at any given time in the
ongoing episode.</p></td>
        <td><code>&#39;env_steps&#39;</code></td>
      </tr>
      <tr>
        <td><code>callbacks</code></td>
        <td><code>DefaultCallbacks</code></td>
        <td><p>The Callbacks object to use when episode
events happen during rollout.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>horizon</code></td>
        <td><code>int</code></td>
        <td><p>Hard-reset the Env after this many timesteps.</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>multiple_episodes_in_batch</code></td>
        <td><code>bool</code></td>
        <td><p>Whether to pack multiple
episodes into each batch. This guarantees batches will be
exactly <code>rollout_fragment_length</code> in size.</p></td>
        <td><code>False</code></td>
      </tr>
      <tr>
        <td><code>normalize_actions</code></td>
        <td><code>bool</code></td>
        <td><p>Whether to normalize actions to the
action space's bounds.</p></td>
        <td><code>True</code></td>
      </tr>
      <tr>
        <td><code>clip_actions</code></td>
        <td><code>bool</code></td>
        <td><p>Whether to clip actions according to the
given action_space's bounds.</p></td>
        <td><code>False</code></td>
      </tr>
      <tr>
        <td><code>soft_horizon</code></td>
        <td><code>bool</code></td>
        <td><p>If True, calculate bootstrapped values as if
episode had ended, but don't physically reset the environment
when the horizon is hit.</p></td>
        <td><code>False</code></td>
      </tr>
      <tr>
        <td><code>no_done_at_end</code></td>
        <td><code>bool</code></td>
        <td><p>Ignore the done=True at the end of the
episode and instead record done=False.</p></td>
        <td><code>False</code></td>
      </tr>
      <tr>
        <td><code>observation_fn</code></td>
        <td><code>Optional[ObservationFunction]</code></td>
        <td><p>Optional multi-agent observation func to use for
preprocessing observations.</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>sample_collector_class</code></td>
        <td><code>Optional[Type[ray.rllib.evaluation.collectors.sample_collector.SampleCollector]]</code></td>
        <td><p>An optional Samplecollector sub-class to
use to collect, store, and retrieve environment-, model-,
and sampler data.</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>render</code></td>
        <td><code>bool</code></td>
        <td><p>Whether to try to render the environment after each step.</p></td>
        <td><code>False</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>ray/rllib/evaluation/sampler.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>        <span class="o">*</span><span class="p">,</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>        <span class="n">worker</span><span class="p">:</span> <span class="s2">&quot;RolloutWorker&quot;</span><span class="p">,</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a>        <span class="n">env</span><span class="p">:</span> <span class="n">BaseEnv</span><span class="p">,</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a>        <span class="n">clip_rewards</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a>        <span class="n">rollout_fragment_length</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a>        <span class="n">count_steps_by</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;env_steps&quot;</span><span class="p">,</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a>        <span class="n">callbacks</span><span class="p">:</span> <span class="s2">&quot;DefaultCallbacks&quot;</span><span class="p">,</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a>        <span class="n">horizon</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a>        <span class="n">multiple_episodes_in_batch</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a>        <span class="n">normalize_actions</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a>        <span class="n">clip_actions</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a>        <span class="n">soft_horizon</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a>        <span class="n">no_done_at_end</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a>        <span class="n">observation_fn</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;ObservationFunction&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a>        <span class="n">sample_collector_class</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">SampleCollector</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a>        <span class="n">render</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a>        <span class="c1"># Obsolete.</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a>        <span class="n">policies</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a>        <span class="n">policy_mapping_fn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a>        <span class="n">preprocessors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a>        <span class="n">obs_filters</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a>        <span class="n">tf_sess</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a><span class="p">):</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a>    <span class="sd">&quot;&quot;&quot;Initializes a SyncSampler instance.</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a><span class="sd">        worker: The RolloutWorker that will use this Sampler for sampling.</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a><span class="sd">        env: Any Env object. Will be converted into an RLlib BaseEnv.</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a><span class="sd">        clip_rewards: True for +/-1.0 clipping,</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a><span class="sd">            actual float value for +/- value clipping. False for no</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a><span class="sd">            clipping.</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a><span class="sd">        rollout_fragment_length: The length of a fragment to collect</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a><span class="sd">            before building a SampleBatch from the data and resetting</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a><span class="sd">            the SampleBatchBuilder object.</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a><span class="sd">        count_steps_by: One of &quot;env_steps&quot; (default) or &quot;agent_steps&quot;.</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a><span class="sd">            Use &quot;agent_steps&quot;, if you want rollout lengths to be counted</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a><span class="sd">            by individual agent steps. In a multi-agent env,</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a><span class="sd">            a single env_step contains one or more agent_steps, depending</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a><span class="sd">            on how many agents are present at any given time in the</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a><span class="sd">            ongoing episode.</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a><span class="sd">        callbacks: The Callbacks object to use when episode</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a><span class="sd">            events happen during rollout.</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a><span class="sd">        horizon: Hard-reset the Env after this many timesteps.</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a><span class="sd">        multiple_episodes_in_batch: Whether to pack multiple</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a><span class="sd">            episodes into each batch. This guarantees batches will be</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a><span class="sd">            exactly `rollout_fragment_length` in size.</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a><span class="sd">        normalize_actions: Whether to normalize actions to the</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a><span class="sd">            action space&#39;s bounds.</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a><span class="sd">        clip_actions: Whether to clip actions according to the</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a><span class="sd">            given action_space&#39;s bounds.</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a><span class="sd">        soft_horizon: If True, calculate bootstrapped values as if</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a><span class="sd">            episode had ended, but don&#39;t physically reset the environment</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a><span class="sd">            when the horizon is hit.</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a><span class="sd">        no_done_at_end: Ignore the done=True at the end of the</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a><span class="sd">            episode and instead record done=False.</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a><span class="sd">        observation_fn: Optional multi-agent observation func to use for</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a><span class="sd">            preprocessing observations.</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a><span class="sd">        sample_collector_class: An optional Samplecollector sub-class to</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a><span class="sd">            use to collect, store, and retrieve environment-, model-,</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a><span class="sd">            and sampler data.</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a><span class="sd">        render: Whether to try to render the environment after each step.</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>    <span class="c1"># All of the following arguments are deprecated. They will instead be</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>    <span class="c1"># provided via the passed in `worker` arg, e.g. `worker.policy_map`.</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a>    <span class="k">if</span> <span class="n">log_once</span><span class="p">(</span><span class="s2">&quot;deprecated_sync_sampler_args&quot;</span><span class="p">):</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>        <span class="k">if</span> <span class="n">policies</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>            <span class="n">deprecation_warning</span><span class="p">(</span><span class="n">old</span><span class="o">=</span><span class="s2">&quot;policies&quot;</span><span class="p">)</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>        <span class="k">if</span> <span class="n">policy_mapping_fn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>            <span class="n">deprecation_warning</span><span class="p">(</span><span class="n">old</span><span class="o">=</span><span class="s2">&quot;policy_mapping_fn&quot;</span><span class="p">)</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>        <span class="k">if</span> <span class="n">preprocessors</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>            <span class="n">deprecation_warning</span><span class="p">(</span><span class="n">old</span><span class="o">=</span><span class="s2">&quot;preprocessors&quot;</span><span class="p">)</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>        <span class="k">if</span> <span class="n">obs_filters</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>            <span class="n">deprecation_warning</span><span class="p">(</span><span class="n">old</span><span class="o">=</span><span class="s2">&quot;obs_filters&quot;</span><span class="p">)</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>        <span class="k">if</span> <span class="n">tf_sess</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>            <span class="n">deprecation_warning</span><span class="p">(</span><span class="n">old</span><span class="o">=</span><span class="s2">&quot;tf_sess&quot;</span><span class="p">)</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">base_env</span> <span class="o">=</span> <span class="n">BaseEnv</span><span class="o">.</span><span class="n">to_base_env</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">rollout_fragment_length</span> <span class="o">=</span> <span class="n">rollout_fragment_length</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">horizon</span> <span class="o">=</span> <span class="n">horizon</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">extra_batches</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">perf_stats</span> <span class="o">=</span> <span class="n">_PerfStats</span><span class="p">()</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">sample_collector_class</span><span class="p">:</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>        <span class="n">sample_collector_class</span> <span class="o">=</span> <span class="n">SimpleListCollector</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">sample_collector</span> <span class="o">=</span> <span class="n">sample_collector_class</span><span class="p">(</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>        <span class="n">worker</span><span class="o">.</span><span class="n">policy_map</span><span class="p">,</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>        <span class="n">clip_rewards</span><span class="p">,</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>        <span class="n">callbacks</span><span class="p">,</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>        <span class="n">multiple_episodes_in_batch</span><span class="p">,</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>        <span class="n">rollout_fragment_length</span><span class="p">,</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>        <span class="n">count_steps_by</span><span class="o">=</span><span class="n">count_steps_by</span><span class="p">)</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">render</span> <span class="o">=</span> <span class="n">render</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>    <span class="c1"># Create the rollout generator to use for calls to `get_data()`.</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_env_runner</span> <span class="o">=</span> <span class="n">_env_runner</span><span class="p">(</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>        <span class="n">worker</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_env</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">extra_batches</span><span class="o">.</span><span class="n">put</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">horizon</span><span class="p">,</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>        <span class="n">normalize_actions</span><span class="p">,</span> <span class="n">clip_actions</span><span class="p">,</span> <span class="n">multiple_episodes_in_batch</span><span class="p">,</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>        <span class="n">callbacks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">perf_stats</span><span class="p">,</span> <span class="n">soft_horizon</span><span class="p">,</span> <span class="n">no_done_at_end</span><span class="p">,</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>        <span class="n">observation_fn</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_collector</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">render</span><span class="p">)</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">metrics_queue</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="ray.rllib.evaluation.sampler.SyncSampler.get_data">
<code class="highlight language-python"><span class="n">get_data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Called by <code>self.next()</code> to return the next batch of data.</p>
<p>Override this in child classes.</p>

<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>Union[SampleBatch, MultiAgentBatch]</code></td>
      <td><p>The next batch of data.</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>ray/rllib/evaluation/sampler.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nd">@override</span><span class="p">(</span><span class="n">SamplerInput</span><span class="p">)</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="k">def</span> <span class="nf">get_data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SampleBatchType</span><span class="p">:</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>        <span class="n">item</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_env_runner</span><span class="p">)</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">RolloutMetrics</span><span class="p">):</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">metrics_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a>            <span class="k">return</span> <span class="n">item</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="ray.rllib.evaluation.sampler.SyncSampler.get_extra_batches">
<code class="highlight language-python"><span class="n">get_extra_batches</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Returns list of extra batches since the last call to this method.</p>
<p>The list will contain all SampleBatches or
MultiAgentBatches that the user has provided thus-far. Users can
add these "extra batches" to an episode by calling the episode's
<code>add_extra_batch([SampleBatchType])</code> method. This can be done from
inside an overridden <code>Policy.compute_actions_from_input_dict(...,
episodes)</code> or from a custom callback's <code>on_episode_[start|step|end]()</code>
methods.</p>

<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>List[Union[SampleBatch, MultiAgentBatch]]</code></td>
      <td><p>List of SamplesBatches or MultiAgentBatches provided thus-far by
the user since the last call to this method.</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>ray/rllib/evaluation/sampler.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nd">@override</span><span class="p">(</span><span class="n">SamplerInput</span><span class="p">)</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="k">def</span> <span class="nf">get_extra_batches</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">SampleBatchType</span><span class="p">]:</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>    <span class="n">extra</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a>            <span class="n">extra</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">extra_batches</span><span class="o">.</span><span class="n">get_nowait</span><span class="p">())</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a>        <span class="k">except</span> <span class="n">queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a>            <span class="k">break</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a>    <span class="k">return</span> <span class="n">extra</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="ray.rllib.evaluation.sampler.SyncSampler.get_metrics">
<code class="highlight language-python"><span class="n">get_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Returns list of episode metrics since the last call to this method.</p>
<p>The list will contain one RolloutMetrics object per completed episode.</p>

<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>List[ray.rllib.evaluation.metrics.RolloutMetrics]</code></td>
      <td><p>List of RolloutMetrics objects, one per completed episode since
the last call to this method.</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>ray/rllib/evaluation/sampler.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nd">@override</span><span class="p">(</span><span class="n">SamplerInput</span><span class="p">)</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="k">def</span> <span class="nf">get_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">RolloutMetrics</span><span class="p">]:</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>    <span class="n">completed</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a>            <span class="n">completed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics_queue</span><span class="o">.</span><span class="n">get_nowait</span><span class="p">()</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a>                <span class="n">perf_stats</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">perf_stats</span><span class="o">.</span><span class="n">get</span><span class="p">()))</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a>        <span class="k">except</span> <span class="n">queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a>            <span class="k">break</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a>    <span class="k">return</span> <span class="n">completed</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h2 class="doc doc-heading" id="ray.rllib.evaluation.sampler.AsyncSampler">
        <code>
ray.rllib.evaluation.sampler.AsyncSampler            (<span title="threading.Thread">Thread</span>, <span title="ray.rllib.evaluation.sampler.SamplerInput">SamplerInput</span>)
        </code>



</h2>

    <div class="doc doc-contents first">

      <p>Async SamplerInput that collects experiences in thread and queues them.</p>
<p>Once started, experiences are continuously collected in the background
and put into a Queue, from where they can be unqueued by the caller
of <code>get_data()</code>.</p>




  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="ray.rllib.evaluation.sampler.AsyncSampler.__init__">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">worker</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">clip_rewards</span><span class="p">,</span> <span class="n">rollout_fragment_length</span><span class="p">,</span> <span class="n">count_steps_by</span><span class="o">=</span><span class="s1">&#39;env_steps&#39;</span><span class="p">,</span> <span class="n">callbacks</span><span class="p">,</span> <span class="n">horizon</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">multiple_episodes_in_batch</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">normalize_actions</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">clip_actions</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">soft_horizon</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">no_done_at_end</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">observation_fn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sample_collector_class</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">render</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">blackhole_outputs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">policies</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">policy_mapping_fn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">preprocessors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">obs_filters</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tf_sess</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

</h3>

    <div class="doc doc-contents ">

      <p>Initializes an AsyncSampler instance.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>worker</code></td>
        <td><code>RolloutWorker</code></td>
        <td><p>The RolloutWorker that will use this Sampler for sampling.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>env</code></td>
        <td><code>BaseEnv</code></td>
        <td><p>Any Env object. Will be converted into an RLlib BaseEnv.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>clip_rewards</code></td>
        <td><code>Union[bool, float]</code></td>
        <td><p>True for +/-1.0 clipping,
actual float value for +/- value clipping. False for no
clipping.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>rollout_fragment_length</code></td>
        <td><code>int</code></td>
        <td><p>The length of a fragment to collect
before building a SampleBatch from the data and resetting
the SampleBatchBuilder object.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>count_steps_by</code></td>
        <td><code>str</code></td>
        <td><p>One of "env_steps" (default) or "agent_steps".
Use "agent_steps", if you want rollout lengths to be counted
by individual agent steps. In a multi-agent env,
a single env_step contains one or more agent_steps, depending
on how many agents are present at any given time in the
ongoing episode.</p></td>
        <td><code>&#39;env_steps&#39;</code></td>
      </tr>
      <tr>
        <td><code>horizon</code></td>
        <td><code>Optional[int]</code></td>
        <td><p>Hard-reset the Env after this many timesteps.</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>multiple_episodes_in_batch</code></td>
        <td><code>bool</code></td>
        <td><p>Whether to pack multiple
episodes into each batch. This guarantees batches will be
exactly <code>rollout_fragment_length</code> in size.</p></td>
        <td><code>False</code></td>
      </tr>
      <tr>
        <td><code>normalize_actions</code></td>
        <td><code>bool</code></td>
        <td><p>Whether to normalize actions to the
action space's bounds.</p></td>
        <td><code>True</code></td>
      </tr>
      <tr>
        <td><code>clip_actions</code></td>
        <td><code>bool</code></td>
        <td><p>Whether to clip actions according to the
given action_space's bounds.</p></td>
        <td><code>False</code></td>
      </tr>
      <tr>
        <td><code>blackhole_outputs</code></td>
        <td><code>bool</code></td>
        <td><p>Whether to collect samples, but then
not further process or store them (throw away all samples).</p></td>
        <td><code>False</code></td>
      </tr>
      <tr>
        <td><code>soft_horizon</code></td>
        <td><code>bool</code></td>
        <td><p>If True, calculate bootstrapped values as if
episode had ended, but don't physically reset the environment
when the horizon is hit.</p></td>
        <td><code>False</code></td>
      </tr>
      <tr>
        <td><code>no_done_at_end</code></td>
        <td><code>bool</code></td>
        <td><p>Ignore the done=True at the end of the
episode and instead record done=False.</p></td>
        <td><code>False</code></td>
      </tr>
      <tr>
        <td><code>observation_fn</code></td>
        <td><code>Optional[ObservationFunction]</code></td>
        <td><p>Optional multi-agent observation func to use for
preprocessing observations.</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>sample_collector_class</code></td>
        <td><code>Optional[Type[ray.rllib.evaluation.collectors.sample_collector.SampleCollector]]</code></td>
        <td><p>An optional SampleCollector sub-class to
use to collect, store, and retrieve environment-, model-,
and sampler data.</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>render</code></td>
        <td><code>bool</code></td>
        <td><p>Whether to try to render the environment after each step.</p></td>
        <td><code>False</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>ray/rllib/evaluation/sampler.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>        <span class="o">*</span><span class="p">,</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>        <span class="n">worker</span><span class="p">:</span> <span class="s2">&quot;RolloutWorker&quot;</span><span class="p">,</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a>        <span class="n">env</span><span class="p">:</span> <span class="n">BaseEnv</span><span class="p">,</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a>        <span class="n">clip_rewards</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a>        <span class="n">rollout_fragment_length</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a>        <span class="n">count_steps_by</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;env_steps&quot;</span><span class="p">,</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a>        <span class="n">callbacks</span><span class="p">:</span> <span class="s2">&quot;DefaultCallbacks&quot;</span><span class="p">,</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a>        <span class="n">horizon</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a>        <span class="n">multiple_episodes_in_batch</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a>        <span class="n">normalize_actions</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a>        <span class="n">clip_actions</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a>        <span class="n">soft_horizon</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a>        <span class="n">no_done_at_end</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a>        <span class="n">observation_fn</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;ObservationFunction&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a>        <span class="n">sample_collector_class</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">SampleCollector</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a>        <span class="n">render</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a>        <span class="n">blackhole_outputs</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a>        <span class="c1"># Obsolete.</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a>        <span class="n">policies</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a>        <span class="n">policy_mapping_fn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a>        <span class="n">preprocessors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a>        <span class="n">obs_filters</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a>        <span class="n">tf_sess</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a><span class="p">):</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a>    <span class="sd">&quot;&quot;&quot;Initializes an AsyncSampler instance.</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a><span class="sd">        worker: The RolloutWorker that will use this Sampler for sampling.</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a><span class="sd">        env: Any Env object. Will be converted into an RLlib BaseEnv.</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a><span class="sd">        clip_rewards: True for +/-1.0 clipping,</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a><span class="sd">            actual float value for +/- value clipping. False for no</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a><span class="sd">            clipping.</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a><span class="sd">        rollout_fragment_length: The length of a fragment to collect</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a><span class="sd">            before building a SampleBatch from the data and resetting</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a><span class="sd">            the SampleBatchBuilder object.</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a><span class="sd">        count_steps_by: One of &quot;env_steps&quot; (default) or &quot;agent_steps&quot;.</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a><span class="sd">            Use &quot;agent_steps&quot;, if you want rollout lengths to be counted</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a><span class="sd">            by individual agent steps. In a multi-agent env,</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a><span class="sd">            a single env_step contains one or more agent_steps, depending</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a><span class="sd">            on how many agents are present at any given time in the</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a><span class="sd">            ongoing episode.</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a><span class="sd">        horizon: Hard-reset the Env after this many timesteps.</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a><span class="sd">        multiple_episodes_in_batch: Whether to pack multiple</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a><span class="sd">            episodes into each batch. This guarantees batches will be</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a><span class="sd">            exactly `rollout_fragment_length` in size.</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a><span class="sd">        normalize_actions: Whether to normalize actions to the</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a><span class="sd">            action space&#39;s bounds.</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a><span class="sd">        clip_actions: Whether to clip actions according to the</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a><span class="sd">            given action_space&#39;s bounds.</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a><span class="sd">        blackhole_outputs: Whether to collect samples, but then</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a><span class="sd">            not further process or store them (throw away all samples).</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a><span class="sd">        soft_horizon: If True, calculate bootstrapped values as if</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a><span class="sd">            episode had ended, but don&#39;t physically reset the environment</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a><span class="sd">            when the horizon is hit.</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a><span class="sd">        no_done_at_end: Ignore the done=True at the end of the</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a><span class="sd">            episode and instead record done=False.</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a><span class="sd">        observation_fn: Optional multi-agent observation func to use for</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a><span class="sd">            preprocessing observations.</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a><span class="sd">        sample_collector_class: An optional SampleCollector sub-class to</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a><span class="sd">            use to collect, store, and retrieve environment-, model-,</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a><span class="sd">            and sampler data.</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a><span class="sd">        render: Whether to try to render the environment after each step.</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>    <span class="c1"># All of the following arguments are deprecated. They will instead be</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a>    <span class="c1"># provided via the passed in `worker` arg, e.g. `worker.policy_map`.</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>    <span class="k">if</span> <span class="n">log_once</span><span class="p">(</span><span class="s2">&quot;deprecated_async_sampler_args&quot;</span><span class="p">):</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>        <span class="k">if</span> <span class="n">policies</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>            <span class="n">deprecation_warning</span><span class="p">(</span><span class="n">old</span><span class="o">=</span><span class="s2">&quot;policies&quot;</span><span class="p">)</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>        <span class="k">if</span> <span class="n">policy_mapping_fn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>            <span class="n">deprecation_warning</span><span class="p">(</span><span class="n">old</span><span class="o">=</span><span class="s2">&quot;policy_mapping_fn&quot;</span><span class="p">)</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>        <span class="k">if</span> <span class="n">preprocessors</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>            <span class="n">deprecation_warning</span><span class="p">(</span><span class="n">old</span><span class="o">=</span><span class="s2">&quot;preprocessors&quot;</span><span class="p">)</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>        <span class="k">if</span> <span class="n">obs_filters</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>            <span class="n">deprecation_warning</span><span class="p">(</span><span class="n">old</span><span class="o">=</span><span class="s2">&quot;obs_filters&quot;</span><span class="p">)</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>        <span class="k">if</span> <span class="n">tf_sess</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>            <span class="n">deprecation_warning</span><span class="p">(</span><span class="n">old</span><span class="o">=</span><span class="s2">&quot;tf_sess&quot;</span><span class="p">)</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">worker</span> <span class="o">=</span> <span class="n">worker</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a>    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">worker</span><span class="o">.</span><span class="n">filters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>        <span class="k">assert</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s2">&quot;is_concurrent&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span> \
<a id="__codelineno-0-84" name="__codelineno-0-84"></a>            <span class="s2">&quot;Observation Filter must support concurrent updates.&quot;</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">base_env</span> <span class="o">=</span> <span class="n">BaseEnv</span><span class="o">.</span><span class="n">to_base_env</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>    <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">queue</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">extra_batches</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">metrics_queue</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">rollout_fragment_length</span> <span class="o">=</span> <span class="n">rollout_fragment_length</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">horizon</span> <span class="o">=</span> <span class="n">horizon</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">clip_rewards</span> <span class="o">=</span> <span class="n">clip_rewards</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">multiple_episodes_in_batch</span> <span class="o">=</span> <span class="n">multiple_episodes_in_batch</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span> <span class="o">=</span> <span class="n">callbacks</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">normalize_actions</span> <span class="o">=</span> <span class="n">normalize_actions</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">clip_actions</span> <span class="o">=</span> <span class="n">clip_actions</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">blackhole_outputs</span> <span class="o">=</span> <span class="n">blackhole_outputs</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">soft_horizon</span> <span class="o">=</span> <span class="n">soft_horizon</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">no_done_at_end</span> <span class="o">=</span> <span class="n">no_done_at_end</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">perf_stats</span> <span class="o">=</span> <span class="n">_PerfStats</span><span class="p">()</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">shutdown</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">observation_fn</span> <span class="o">=</span> <span class="n">observation_fn</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">render</span> <span class="o">=</span> <span class="n">render</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">sample_collector_class</span><span class="p">:</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>        <span class="n">sample_collector_class</span> <span class="o">=</span> <span class="n">SimpleListCollector</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">sample_collector</span> <span class="o">=</span> <span class="n">sample_collector_class</span><span class="p">(</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">policy_map</span><span class="p">,</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">clip_rewards</span><span class="p">,</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">,</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">multiple_episodes_in_batch</span><span class="p">,</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">rollout_fragment_length</span><span class="p">,</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>        <span class="n">count_steps_by</span><span class="o">=</span><span class="n">count_steps_by</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="ray.rllib.evaluation.sampler.AsyncSampler.get_data">
<code class="highlight language-python"><span class="n">get_data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Called by <code>self.next()</code> to return the next batch of data.</p>
<p>Override this in child classes.</p>

<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>Union[SampleBatch, MultiAgentBatch]</code></td>
      <td><p>The next batch of data.</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>ray/rllib/evaluation/sampler.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nd">@override</span><span class="p">(</span><span class="n">SamplerInput</span><span class="p">)</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="k">def</span> <span class="nf">get_data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SampleBatchType</span><span class="p">:</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Sampling thread has died&quot;</span><span class="p">)</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a>    <span class="n">rollout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">600.0</span><span class="p">)</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a>    <span class="c1"># Propagate errors.</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rollout</span><span class="p">,</span> <span class="ne">BaseException</span><span class="p">):</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a>        <span class="k">raise</span> <span class="n">rollout</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a>    <span class="k">return</span> <span class="n">rollout</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="ray.rllib.evaluation.sampler.AsyncSampler.get_extra_batches">
<code class="highlight language-python"><span class="n">get_extra_batches</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Returns list of extra batches since the last call to this method.</p>
<p>The list will contain all SampleBatches or
MultiAgentBatches that the user has provided thus-far. Users can
add these "extra batches" to an episode by calling the episode's
<code>add_extra_batch([SampleBatchType])</code> method. This can be done from
inside an overridden <code>Policy.compute_actions_from_input_dict(...,
episodes)</code> or from a custom callback's <code>on_episode_[start|step|end]()</code>
methods.</p>

<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>List[Union[SampleBatch, MultiAgentBatch]]</code></td>
      <td><p>List of SamplesBatches or MultiAgentBatches provided thus-far by
the user since the last call to this method.</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>ray/rllib/evaluation/sampler.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nd">@override</span><span class="p">(</span><span class="n">SamplerInput</span><span class="p">)</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="k">def</span> <span class="nf">get_extra_batches</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">SampleBatchType</span><span class="p">]:</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>    <span class="n">extra</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a>            <span class="n">extra</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">extra_batches</span><span class="o">.</span><span class="n">get_nowait</span><span class="p">())</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a>        <span class="k">except</span> <span class="n">queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a>            <span class="k">break</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a>    <span class="k">return</span> <span class="n">extra</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="ray.rllib.evaluation.sampler.AsyncSampler.get_metrics">
<code class="highlight language-python"><span class="n">get_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Returns list of episode metrics since the last call to this method.</p>
<p>The list will contain one RolloutMetrics object per completed episode.</p>

<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>List[ray.rllib.evaluation.metrics.RolloutMetrics]</code></td>
      <td><p>List of RolloutMetrics objects, one per completed episode since
the last call to this method.</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>ray/rllib/evaluation/sampler.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nd">@override</span><span class="p">(</span><span class="n">SamplerInput</span><span class="p">)</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="k">def</span> <span class="nf">get_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">RolloutMetrics</span><span class="p">]:</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>    <span class="n">completed</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a>            <span class="n">completed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics_queue</span><span class="o">.</span><span class="n">get_nowait</span><span class="p">()</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a>                <span class="n">perf_stats</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">perf_stats</span><span class="o">.</span><span class="n">get</span><span class="p">()))</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a>        <span class="k">except</span> <span class="n">queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a>            <span class="k">break</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a>    <span class="k">return</span> <span class="n">completed</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h3 class="doc doc-heading" id="ray.rllib.evaluation.sampler.AsyncSampler.run">
<code class="highlight language-python"><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Method representing the thread's activity.</p>
<p>You may override this method in a subclass. The standard run() method
invokes the callable object passed to the object's constructor as the
target argument, if any, with sequential and keyword arguments taken
from the args and kwargs arguments, respectively.</p>

        <details class="quote">
          <summary>Source code in <code>ray/rllib/evaluation/sampler.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nd">@override</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">)</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_run</span><span class="p">()</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a>    <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a>        <span class="k">raise</span> <span class="n">e</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>

<h2 id="utility-functions">Utility Functions</h2>


  <div class="doc doc-object doc-function">



<h2 class="doc doc-heading" id="ray.rllib.evaluation.postprocessing.compute_advantages">
<code class="highlight language-python"><span class="n">ray</span><span class="o">.</span><span class="n">rllib</span><span class="o">.</span><span class="n">evaluation</span><span class="o">.</span><span class="n">postprocessing</span><span class="o">.</span><span class="n">compute_advantages</span><span class="p">(</span><span class="n">rollout</span><span class="p">,</span> <span class="n">last_r</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">lambda_</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">use_gae</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">use_critic</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>


</h2>

    <div class="doc doc-contents first">

      <p>Given a rollout, compute its value targets and the advantages.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>rollout</code></td>
        <td><code>SampleBatch</code></td>
        <td><p>SampleBatch of a single trajectory.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>last_r</code></td>
        <td><code>float</code></td>
        <td><p>Value estimation for last observation.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>gamma</code></td>
        <td><code>float</code></td>
        <td><p>Discount factor.</p></td>
        <td><code>0.9</code></td>
      </tr>
      <tr>
        <td><code>lambda_</code></td>
        <td><code>float</code></td>
        <td><p>Parameter for GAE.</p></td>
        <td><code>1.0</code></td>
      </tr>
      <tr>
        <td><code>use_gae</code></td>
        <td><code>bool</code></td>
        <td><p>Using Generalized Advantage Estimation.</p></td>
        <td><code>True</code></td>
      </tr>
      <tr>
        <td><code>use_critic</code></td>
        <td><code>bool</code></td>
        <td><p>Whether to use critic (value estimates). Setting
this to False will use 0 as baseline.</p></td>
        <td><code>True</code></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td></td>
      <td><p>SampleBatch with experience from rollout and processed rewards.</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>ray/rllib/evaluation/postprocessing.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nd">@DeveloperAPI</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="k">def</span> <span class="nf">compute_advantages</span><span class="p">(</span><span class="n">rollout</span><span class="p">:</span> <span class="n">SampleBatch</span><span class="p">,</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>                       <span class="n">last_r</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>                       <span class="n">gamma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.9</span><span class="p">,</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a>                       <span class="n">lambda_</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a>                       <span class="n">use_gae</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a>                       <span class="n">use_critic</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a>    <span class="sd">&quot;&quot;&quot;Given a rollout, compute its value targets and the advantages.</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="sd">        rollout: SampleBatch of a single trajectory.</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="sd">        last_r: Value estimation for last observation.</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="sd">        gamma: Discount factor.</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="sd">        lambda_: Parameter for GAE.</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="sd">        use_gae: Using Generalized Advantage Estimation.</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="sd">        use_critic: Whether to use critic (value estimates). Setting</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="sd">            this to False will use 0 as baseline.</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="sd">        SampleBatch with experience from rollout and processed rewards.</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a>    <span class="k">assert</span> <span class="n">SampleBatch</span><span class="o">.</span><span class="n">VF_PREDS</span> <span class="ow">in</span> <span class="n">rollout</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">use_critic</span><span class="p">,</span> \
<a id="__codelineno-0-24" name="__codelineno-0-24"></a>        <span class="s2">&quot;use_critic=True but values not found&quot;</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a>    <span class="k">assert</span> <span class="n">use_critic</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">use_gae</span><span class="p">,</span> \
<a id="__codelineno-0-26" name="__codelineno-0-26"></a>        <span class="s2">&quot;Can&#39;t use gae without using a value function&quot;</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a>    <span class="k">if</span> <span class="n">use_gae</span><span class="p">:</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a>        <span class="n">vpred_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a>            <span class="p">[</span><span class="n">rollout</span><span class="p">[</span><span class="n">SampleBatch</span><span class="o">.</span><span class="n">VF_PREDS</span><span class="p">],</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a>             <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">last_r</span><span class="p">])])</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a>        <span class="n">delta_t</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a>            <span class="n">rollout</span><span class="p">[</span><span class="n">SampleBatch</span><span class="o">.</span><span class="n">REWARDS</span><span class="p">]</span> <span class="o">+</span> <span class="n">gamma</span> <span class="o">*</span> <span class="n">vpred_t</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">vpred_t</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a>        <span class="c1"># This formula for the advantage comes from:</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a>        <span class="c1"># &quot;Generalized Advantage Estimation&quot;: https://arxiv.org/abs/1506.02438</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a>        <span class="n">rollout</span><span class="p">[</span><span class="n">Postprocessing</span><span class="o">.</span><span class="n">ADVANTAGES</span><span class="p">]</span> <span class="o">=</span> <span class="n">discount_cumsum</span><span class="p">(</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a>            <span class="n">delta_t</span><span class="p">,</span> <span class="n">gamma</span> <span class="o">*</span> <span class="n">lambda_</span><span class="p">)</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a>        <span class="n">rollout</span><span class="p">[</span><span class="n">Postprocessing</span><span class="o">.</span><span class="n">VALUE_TARGETS</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a>            <span class="n">rollout</span><span class="p">[</span><span class="n">Postprocessing</span><span class="o">.</span><span class="n">ADVANTAGES</span><span class="p">]</span> <span class="o">+</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a>            <span class="n">rollout</span><span class="p">[</span><span class="n">SampleBatch</span><span class="o">.</span><span class="n">VF_PREDS</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>        <span class="n">rewards_plus_v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>            <span class="p">[</span><span class="n">rollout</span><span class="p">[</span><span class="n">SampleBatch</span><span class="o">.</span><span class="n">REWARDS</span><span class="p">],</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>             <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">last_r</span><span class="p">])])</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>        <span class="n">discounted_returns</span> <span class="o">=</span> <span class="n">discount_cumsum</span><span class="p">(</span><span class="n">rewards_plus_v</span><span class="p">,</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>                                             <span class="n">gamma</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>        <span class="k">if</span> <span class="n">use_critic</span><span class="p">:</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>            <span class="n">rollout</span><span class="p">[</span><span class="n">Postprocessing</span><span class="o">.</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>                    <span class="n">ADVANTAGES</span><span class="p">]</span> <span class="o">=</span> <span class="n">discounted_returns</span> <span class="o">-</span> <span class="n">rollout</span><span class="p">[</span><span class="n">SampleBatch</span><span class="o">.</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>                                                               <span class="n">VF_PREDS</span><span class="p">]</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>            <span class="n">rollout</span><span class="p">[</span><span class="n">Postprocessing</span><span class="o">.</span><span class="n">VALUE_TARGETS</span><span class="p">]</span> <span class="o">=</span> <span class="n">discounted_returns</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>            <span class="n">rollout</span><span class="p">[</span><span class="n">Postprocessing</span><span class="o">.</span><span class="n">ADVANTAGES</span><span class="p">]</span> <span class="o">=</span> <span class="n">discounted_returns</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>            <span class="n">rollout</span><span class="p">[</span><span class="n">Postprocessing</span><span class="o">.</span><span class="n">VALUE_TARGETS</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>                <span class="n">rollout</span><span class="p">[</span><span class="n">Postprocessing</span><span class="o">.</span><span class="n">ADVANTAGES</span><span class="p">])</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>    <span class="n">rollout</span><span class="p">[</span><span class="n">Postprocessing</span><span class="o">.</span><span class="n">ADVANTAGES</span><span class="p">]</span> <span class="o">=</span> <span class="n">rollout</span><span class="p">[</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>        <span class="n">Postprocessing</span><span class="o">.</span><span class="n">ADVANTAGES</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>    <span class="k">return</span> <span class="n">rollout</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h2 class="doc doc-heading" id="ray.rllib.evaluation.metrics.collect_metrics">
<code class="highlight language-python"><span class="n">ray</span><span class="o">.</span><span class="n">rllib</span><span class="o">.</span><span class="n">evaluation</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">collect_metrics</span><span class="p">(</span><span class="n">local_worker</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">remote_workers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">to_be_collected</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">180</span><span class="p">)</span></code>


</h2>

    <div class="doc doc-contents first">

      <p>Gathers episode metrics from RolloutWorker instances.</p>

        <details class="quote">
          <summary>Source code in <code>ray/rllib/evaluation/metrics.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nd">@DeveloperAPI</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="k">def</span> <span class="nf">collect_metrics</span><span class="p">(</span><span class="n">local_worker</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;RolloutWorker&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>                    <span class="n">remote_workers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">ActorHandle</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>                    <span class="n">to_be_collected</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">ObjectRef</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a>                    <span class="n">timeout_seconds</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">180</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ResultDict</span><span class="p">:</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a>    <span class="sd">&quot;&quot;&quot;Gathers episode metrics from RolloutWorker instances.&quot;&quot;&quot;</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a>    <span class="k">if</span> <span class="n">remote_workers</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a>        <span class="n">remote_workers</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a>    <span class="k">if</span> <span class="n">to_be_collected</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a>        <span class="n">to_be_collected</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a>    <span class="n">episodes</span><span class="p">,</span> <span class="n">to_be_collected</span> <span class="o">=</span> <span class="n">collect_episodes</span><span class="p">(</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a>        <span class="n">local_worker</span><span class="p">,</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a>        <span class="n">remote_workers</span><span class="p">,</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a>        <span class="n">to_be_collected</span><span class="p">,</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a>        <span class="n">timeout_seconds</span><span class="o">=</span><span class="n">timeout_seconds</span><span class="p">)</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a>    <span class="n">metrics</span> <span class="o">=</span> <span class="n">summarize_episodes</span><span class="p">(</span><span class="n">episodes</span><span class="p">,</span> <span class="n">episodes</span><span class="p">)</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a>    <span class="k">return</span> <span class="n">metrics</span>
</code></pre></div>
        </details>
    </div>

  </div>

              
            </article>
          </div>
        </div>
        
          <a href="#" class="md-top md-icon" data-md-component="top" data-md-state="hidden">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"/></svg>
            Back to top
          </a>
        
      </main>
      
        <footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="../models/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Models" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Models
            </div>
          </div>
        </a>
      
      
        
        <a href="../execution/" class="md-footer__link md-footer__link--next" aria-label="Next: Execution" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Execution
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; Anyscale, Inc 2021
    </div>
  
  
</div>
      
        <div class="md-social">
  
    
    
      
      
    
    <a href="https://twitter.com/raydistributed" target="_blank" rel="noopener" title="twitter.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
    </a>
  
    
    
      
      
    
    <a href="https://github.com/ray-project/ray" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
    </a>
  
    
    
      
      
    
    <a href="https://ray.io" target="_blank" rel="noopener" title="ray.io" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path d="M336.5 160C322 70.7 287.8 8 248 8s-74 62.7-88.5 152h177zM152 256c0 22.2 1.2 43.5 3.3 64h185.3c2.1-20.5 3.3-41.8 3.3-64s-1.2-43.5-3.3-64H155.3c-2.1 20.5-3.3 41.8-3.3 64zm324.7-96c-28.6-67.9-86.5-120.4-158-141.6 24.4 33.8 41.2 84.7 50 141.6h108zM177.2 18.4C105.8 39.6 47.8 92.1 19.3 160h108c8.7-56.9 25.5-107.8 49.9-141.6zM487.4 192H372.7c2.1 21 3.3 42.5 3.3 64s-1.2 43-3.3 64h114.6c5.5-20.5 8.6-41.8 8.6-64s-3.1-43.5-8.5-64zM120 256c0-21.5 1.2-43 3.3-64H8.6C3.2 212.5 0 233.8 0 256s3.2 43.5 8.6 64h114.6c-2-21-3.2-42.5-3.2-64zm39.5 96c14.5 89.3 48.7 152 88.5 152s74-62.7 88.5-152h-177zm159.3 141.6c71.4-21.2 129.4-73.7 158-141.6h-108c-8.8 56.9-25.6 107.8-50 141.6zM19.3 352c28.6 67.9 86.5 120.4 158 141.6-24.4-33.8-41.2-84.7-50-141.6h-108z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.tracking", "navigation.tabs", "navigation.indexes", "content.tabs.link", "navigation.tracking", "navigation.instant", "navigation.top", "content.code.annotate"], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../../../assets/javascripts/workers/search.0bbba5b5.min.js", "version": {"provider": "mike"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.e1a181d9.min.js"></script>
      
        <script src="../../../js/termynal.js"></script>
      
        <script src="../../../js/custom.js"></script>
      
    
  </body>
</html>